<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>WilliamBot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest" />
  <meta name="theme-color" content="#0b0a08" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="WilliamBot" />

  <style>
    :root{
      --bg:#0b0a08;
      --bg2:#12100c;

      --cream:#f3efe6;
      --ink:#1b1813;

      --border: rgba(243,239,230,.14);
      --muted: rgba(243,239,230,.70);
      --muted2: rgba(243,239,230,.56);

      --biz:#7a1114;
      --biz2:#a0141a;
      --school:#1e40af;
      --school2:#2563eb;
      --personal:#0f766e;
      --personal2:#14b8a6;

      --green:#15803d;
      --amber:#b45309;
      --red:#b91c1c;

      --r:18px;
      --r2:14px;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --shadow2: 0 10px 30px rgba(0,0,0,.28);

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;

      --navH: 66px;
      --topH: 58px;

      /* runtime lane colors */
      --lane: var(--biz);
      --lane2: var(--biz2);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; }
    body{
      font-family: var(--font);
      background:
        radial-gradient(900px 600px at 18% 10%, color-mix(in srgb, var(--lane2) 22%, transparent), transparent 55%),
        radial-gradient(800px 500px at 90% 28%, rgba(243,239,230,.10), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      color: var(--cream);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      overflow:hidden;
    }

    .hidden{ display:none !important; }
    .srOnly{
      position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0;
    }

    /* ---- App shell (mobile-first) ---- */
    .app{
      height:100%;
      display:flex;
      flex-direction:column;
      padding:
        env(safe-area-inset-top) 12px
        calc(env(safe-area-inset-bottom) + 12px) 12px;
      gap: 10px;
    }

    /* Top bar */
    .topbar{
      height: var(--topH);
      border: 1px solid var(--border);
      background: rgba(20,17,13,.78);
      backdrop-filter: blur(10px);
      border-radius: var(--r);
      box-shadow: var(--shadow2);
      padding: 10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      min-width: 0;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .logo{
      width: 38px;
      height: 38px;
      border-radius: 14px;
      display:grid;
      place-items:center;
      user-select:none;
      font-weight: 900;
      letter-spacing: .4px;
      color: var(--cream);
      border: 1px solid rgba(243,239,230,.16);
      background:
        radial-gradient(18px 18px at 30% 25%, rgba(243,239,230,.22), transparent 55%),
        linear-gradient(135deg, color-mix(in srgb, var(--lane) 75%, transparent), color-mix(in srgb, var(--lane) 20%, transparent));
      box-shadow: 0 10px 22px color-mix(in srgb, var(--lane) 18%, transparent);
      flex: 0 0 auto;
    }

    .titleWrap{
      display:flex;
      flex-direction:column;
      gap: 4px;
      min-width:0;
    }
    .sessionTitle{
      font-weight: 880;
      font-size: 14px;
      line-height: 1.1;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 48vw;
    }
    .sessionSub{
      font-size: 12px;
      color: rgba(243,239,230,.68);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 48vw;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border-radius:999px;
      padding: 7px 10px;
      border: 1px solid rgba(243,239,230,.14);
      background: rgba(15,13,10,.35);
      color: rgba(243,239,230,.92);
      font-size: 12px;
      font-weight: 850;
      user-select:none;
      cursor:pointer;
      flex: 0 0 auto;
    }
    .chip .dot{
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--lane2);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--lane2) 18%, transparent);
    }

    .iconBtn{
      border: 1px solid rgba(243,239,230,.14);
      background: rgba(15,13,10,.35);
      color: rgba(243,239,230,.9);
      border-radius: 14px;
      padding: 10px 10px;
      cursor:pointer;
      font-weight: 900;
      user-select:none;
      display:grid;
      place-items:center;
      min-width: 44px;
      min-height: 44px;
      transition: transform .06s ease, background .12s ease, border-color .12s ease;
    }
    .iconBtn:hover{
      border-color: rgba(243,239,230,.22);
      background: rgba(15,13,10,.48);
    }
    .iconBtn:active{ transform: translateY(1px); }
    .iconBtn:focus-visible{
      outline: none;
      box-shadow: 0 0 0 5px color-mix(in srgb, var(--lane2) 18%, transparent);
      border-color: color-mix(in srgb, var(--lane2) 45%, rgba(243,239,230,.22));
    }

    /* Main content card */
    .card{
      flex: 1;
      min-height: 0;
      border-radius: var(--r);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      overflow:hidden;
      background:
        radial-gradient(900px 600px at 30% 0%, color-mix(in srgb, var(--lane2) 10%, transparent), transparent 55%),
        linear-gradient(180deg, rgba(243,239,230,.08), rgba(243,239,230,.04));
      display:flex;
      flex-direction:column;
    }

    /* Screens */
    .screen{
      flex:1;
      min-height:0;
      display:none;
      flex-direction:column;
    }
    .screen.active{ display:flex; }

    /* Chat screen */
    .feed{
      flex:1;
      min-height:0;
      overflow:auto;
      padding: 14px 12px;
    }

    .row{ display:flex; margin: 10px 0; gap: 10px; }
    .row.you{ justify-content:flex-end; }
    .row.bot{ justify-content:flex-start; }

    .bubbleWrap{
      display:flex;
      flex-direction:column;
      gap: 6px;
      max-width: min(92ch, 96%);
      min-width: 0;
    }
    .bubble{
      padding: 12px 12px;
      border-radius: var(--r2);
      border: 1px solid rgba(21,18,13,.14);
      background: rgba(243,239,230,.92);
      color: var(--ink);
      box-shadow: 0 8px 20px rgba(0,0,0,.10);
      white-space: pre-wrap;
      word-wrap: break-word;
      line-height: 1.42;
      font-size: 14.6px;
      position: relative;
      min-width: 0;
    }
    .you .bubble{
      border-color: color-mix(in srgb, var(--lane2) 25%, rgba(21,18,13,.14));
      box-shadow:
        0 10px 24px color-mix(in srgb, var(--lane2) 12%, transparent),
        0 0 0 1px color-mix(in srgb, var(--lane2) 10%, transparent) inset;
      padding-left: 14px;
    }
    .you .bubble:before{
      content:"";
      position:absolute;
      left: 0;
      top: 10px;
      bottom: 10px;
      width: 3px;
      border-radius: 999px;
      background: linear-gradient(180deg, color-mix(in srgb, var(--lane2) 85%, transparent), color-mix(in srgb, var(--lane2) 20%, transparent));
      opacity:.9;
    }

    .meta{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size: 11px;
      color: rgba(21,18,13,.62);
      padding: 0 2px;
      align-items:center;
    }

    .msgTools{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      margin-top: 2px;
    }
    .miniAction{
      border: 1px solid rgba(21,18,13,.12);
      background: rgba(243,239,230,.72);
      color: rgba(21,18,13,.78);
      border-radius: 999px;
      padding: 6px 9px;
      font-size: 12px;
      font-weight: 850;
      cursor:pointer;
      user-select:none;
    }
    .miniAction:active{ transform: translateY(1px); }

    .typing{
      display:inline-flex;
      gap:5px;
      align-items:center;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(243,239,230,.22);
      border: 1px solid rgba(243,239,230,.14);
      color: rgba(243,239,230,.90);
      font-size: 12px;
      font-weight: 800;
      user-select:none;
    }
    .typing .pulse{
      width: 7px; height: 7px; border-radius: 50%;
      background: rgba(243,239,230,.9);
      opacity:.7;
      animation: p 1.2s infinite ease-in-out;
    }
    .typing .pulse:nth-child(2){ animation-delay: .15s; }
    .typing .pulse:nth-child(3){ animation-delay: .30s; }
    @keyframes p{ 0%,80%,100%{ transform: scale(.8); opacity:.45;} 40%{ transform: scale(1.1); opacity:.9;} }

    /* Composer */
    .composer{
      border-top: 1px solid rgba(243,239,230,.14);
      background: rgba(20,17,13,.52);
      padding: 10px 10px;
      display:flex;
      flex-direction:column;
      gap: 8px;
    }

    .toolChipsRow{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      align-items:center;
    }
    .toolChip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(243,239,230,.14);
      background: rgba(15,13,10,.35);
      color: rgba(243,239,230,.86);
      font-size: 12px;
      font-weight: 850;
      cursor:pointer;
      user-select:none;
      white-space: nowrap;
    }
    .toolChip.active{
      border-color: color-mix(in srgb, var(--lane2) 45%, rgba(243,239,230,.22));
      box-shadow: 0 0 0 4px color-mix(in srgb, var(--lane2) 10%, transparent) inset;
      background: color-mix(in srgb, var(--lane2) 16%, rgba(15,13,10,.35));
      color: rgba(243,239,230,.92);
    }

    .warn{
      display:none;
      border: 1px solid rgba(180,83,9,.35);
      background: rgba(180,83,9,.10);
      color: rgba(243,239,230,.92);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 12.5px;
      line-height: 1.35;
    }
    .warn strong{ color: rgba(243,239,230,.95); }
    .warnBtns{
      display:flex;
      gap:8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .composerRow{
      display:flex;
      gap: 10px;
      align-items:flex-end;
    }
    textarea{
      flex:1;
      resize:none;
      min-height: 50px;
      max-height: 180px;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(243,239,230,.16);
      background: rgba(11,10,8,.55);
      color: rgba(243,239,230,.92);
      font-size: 14.6px;
      outline:none;
    }
    textarea::placeholder{ color: rgba(243,239,230,.55); }
    textarea:focus{
      border-color: color-mix(in srgb, var(--lane2) 40%, rgba(243,239,230,.16));
      box-shadow: 0 0 0 5px color-mix(in srgb, var(--lane2) 16%, transparent);
    }

    .sendBtn{
      min-width: 56px;
      min-height: 50px;
      border-radius: 16px;
      border: 1px solid color-mix(in srgb, var(--lane2) 45%, rgba(243,239,230,.16));
      background: linear-gradient(180deg, color-mix(in srgb, var(--lane2) 32%, transparent), color-mix(in srgb, var(--lane2) 18%, transparent));
      color: rgba(243,239,230,.95);
      font-weight: 900;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 10px 26px color-mix(in srgb, var(--lane2) 16%, transparent);
      transition: transform .06s ease, filter .12s ease, opacity .12s ease;
    }
    .sendBtn:hover{ filter: brightness(1.06); }
    .sendBtn:active{ transform: translateY(1px); }
    .sendBtn:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none; }

    .plusBtn{
      min-width: 50px;
      min-height: 50px;
      border-radius: 16px;
      border: 1px solid rgba(243,239,230,.16);
      background: rgba(11,10,8,.55);
      color: rgba(243,239,230,.92);
      font-weight: 950;
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, border-color .12s ease, background .12s ease;
    }
    .plusBtn:hover{
      border-color: rgba(243,239,230,.22);
      background: rgba(11,10,8,.68);
    }
    .plusBtn:active{ transform: translateY(1px); }

    .subRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-size: 12px;
      color: rgba(243,239,230,.70);
      user-select:none;
    }
    .subRow strong{
      color: rgba(243,239,230,.92);
      font-weight: 900;
    }
    .subRow .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(243,239,230,.14);
      background: rgba(15,13,10,.35);
      font-weight: 850;
      cursor:pointer;
    }
    .subRow .pill .tinyDot{
      width: 8px; height: 8px; border-radius:50%;
      background: var(--amber);
      box-shadow: 0 0 0 3px rgba(180,83,9,.14);
    }
    .tinyDot.ok{ background: var(--green); box-shadow: 0 0 0 3px rgba(21,128,61,.14); }
    .tinyDot.bad{ background: var(--red); box-shadow: 0 0 0 3px rgba(185,28,28,.14); }

    /* Sessions / Workspace / Gallery / Files screens */
    .screenPad{ padding: 14px 12px; overflow:auto; min-height:0; }
    .section{
      border: 1px solid rgba(243,239,230,.14);
      background: rgba(15,13,10,.35);
      border-radius: 14px;
      padding: 12px;
    }
    .section + .section{ margin-top: 10px; }

    .sectionTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .sectionTitle strong{
      font-size: 13px;
      letter-spacing: .2px;
      color: rgba(243,239,230,.92);
    }
    .sectionTitle span{
      font-size: 12px;
      color: rgba(243,239,230,.62);
    }

    .rowBtns{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn{
      border-radius: 14px;
      padding: 10px 12px;
      border: 1px solid rgba(243,239,230,.14);
      background: rgba(20,17,13,.45);
      color: rgba(243,239,230,.90);
      font-weight: 900;
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, background .12s ease, border-color .12s ease;
      font-size: 13px;
    }
    .btn:hover{ border-color: rgba(243,239,230,.22); background: rgba(20,17,13,.62); }
    .btn:active{ transform: translateY(1px); }
    .btn.danger{
      border-color: rgba(185,28,28,.35);
      background: rgba(185,28,28,.12);
    }
    .btn.primary{
      border-color: color-mix(in srgb, var(--lane2) 45%, rgba(243,239,230,.14));
      background: color-mix(in srgb, var(--lane2) 18%, rgba(20,17,13,.45));
    }

    .input{
      width:100%;
      border-radius: 14px;
      padding: 10px 12px;
      border: 1px solid rgba(243,239,230,.16);
      background: rgba(11,10,8,.55);
      color: rgba(243,239,230,.92);
      font-size: 14px;
      outline:none;
    }
    .input:focus{
      border-color: color-mix(in srgb, var(--lane2) 40%, rgba(243,239,230,.16));
      box-shadow: 0 0 0 5px color-mix(in srgb, var(--lane2) 16%, transparent);
    }

    .list{ display:flex; flex-direction:column; gap: 8px; }
    .item{
      border: 1px solid rgba(243,239,230,.14);
      background: rgba(15,13,10,.35);
      border-radius: 14px;
      padding: 12px;
      cursor:pointer;
      transition: border-color .12s ease, background .12s ease, transform .06s ease;
      user-select:none;
    }
    .item:hover{ border-color: rgba(243,239,230,.22); background: rgba(15,13,10,.48); }
    .item:active{ transform: translateY(1px); }
    .itemTop{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .itemTitle{
      font-weight: 900;
      font-size: 13px;
      color: rgba(243,239,230,.92);
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      min-width:0;
    }
    .pillMini{
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(243,239,230,.14);
      color: rgba(243,239,230,.70);
      background: rgba(15,13,10,.35);
      flex: 0 0 auto;
    }
    .itemMeta{
      font-size: 12px;
      color: rgba(243,239,230,.62);
      margin-top: 6px;
      line-height: 1.25;
    }
    .activeGlow{
      border-color: color-mix(in srgb, var(--lane2) 45%, rgba(243,239,230,.14));
      box-shadow: 0 0 0 5px color-mix(in srgb, var(--lane2) 10%, transparent) inset;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 420px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .tile{
      border: 1px solid rgba(243,239,230,.14);
      background: rgba(15,13,10,.35);
      border-radius: 14px;
      padding: 12px;
    }
    .tile strong{ font-size: 13px; color: rgba(243,239,230,.92); }
    .tile small{ display:block; margin-top: 6px; color: rgba(243,239,230,.62); font-size: 12px; line-height: 1.3; }

    .imgPh{
      margin-top: 10px;
      width:100%;
      aspect-ratio: 1 / 1;
      border-radius: 12px;
      border: 1px solid rgba(243,239,230,.14);
      background:
        radial-gradient(22px 22px at 25% 30%, rgba(243,239,230,.18), transparent 55%),
        linear-gradient(135deg, color-mix(in srgb, var(--lane2) 16%, rgba(11,10,8,.55)), rgba(11,10,8,.55));
      display:grid;
      place-items:center;
      color: rgba(243,239,230,.82);
      font-weight: 900;
      user-select:none;
    }

    /* Bottom nav */
    .nav{
      height: calc(var(--navH) + env(safe-area-inset-bottom));
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      border: 1px solid var(--border);
      background: rgba(20,17,13,.78);
      backdrop-filter: blur(10px);
      border-radius: var(--r);
      box-shadow: var(--shadow2);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 8px;
    }
    .navBtn{
      flex:1;
      border-radius: 14px;
      border: 1px solid rgba(243,239,230,.14);
      background: rgba(15,13,10,.35);
      color: rgba(243,239,230,.86);
      padding: 10px 8px;
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      font-size: 12px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 6px;
      transition: transform .06s ease, background .12s ease, border-color .12s ease;
    }
    .navBtn:active{ transform: translateY(1px); }
    .navBtn.active{
      border-color: color-mix(in srgb, var(--lane2) 45%, rgba(243,239,230,.14));
      background: color-mix(in srgb, var(--lane2) 14%, rgba(15,13,10,.35));
      box-shadow: 0 0 0 4px color-mix(in srgb, var(--lane2) 10%, transparent) inset;
      color: rgba(243,239,230,.92);
    }
    .navBtn .ico{ font-size: 16px; line-height: 1; }

    /* Sheets / Modals */
    .backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.58);
      display:none;
      z-index: 9000;
    }
    .backdrop.open{ display:block; }

    .sheet{
      position: fixed;
      left: 0; right: 0;
      bottom: 0;
      transform: translateY(110%);
      transition: transform .18s ease;
      z-index: 9100;
      padding: 12px;
    }
    .sheet.open{ transform: translateY(0); }

    .sheetCard{
      width: min(920px, 100%);
      margin: 0 auto;
      border-radius: 20px;
      border: 1px solid rgba(243,239,230,.18);
      background: rgba(20,17,13,.92);
      box-shadow: 0 22px 80px rgba(0,0,0,.55);
      padding: 12px;
      max-height: min(78vh, 680px);
      overflow:auto;
    }
    .sheetHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .sheetHeader strong{ font-size: 13px; color: rgba(243,239,230,.92); }
    .sheetHeader .x{
      border-radius: 14px;
      min-width: 44px;
      min-height: 44px;
    }

    /* Message menu */
    .menu{
      position: fixed;
      z-index: 9500;
      border-radius: 14px;
      border: 1px solid rgba(243,239,230,.18);
      background: rgba(20,17,13,.96);
      box-shadow: 0 22px 80px rgba(0,0,0,.55);
      padding: 8px;
      display:none;
      min-width: 220px;
    }
    .menu.open{ display:block; }
    .menuBtn{
      width:100%;
      text-align:left;
      border-radius: 12px;
      border: 1px solid rgba(243,239,230,.12);
      background: rgba(15,13,10,.35);
      color: rgba(243,239,230,.90);
      padding: 10px 10px;
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      font-size: 13px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin: 6px 0;
    }
    .menuBtn:hover{ border-color: rgba(243,239,230,.22); background: rgba(15,13,10,.50); }
    .menuBtn.danger{ border-color: rgba(185,28,28,.35); background: rgba(185,28,28,.12); }

    /* Fatal overlay */
    .fatal{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      background: rgba(0,0,0,.78);
      z-index: 9999;
    }
    .fatalCard{
      width: min(860px, 100%);
      border-radius: 20px;
      border: 1px solid rgba(243,239,230,.18);
      background: rgba(20,17,13,.92);
      box-shadow: 0 22px 80px rgba(0,0,0,.55);
      padding: 14px;
      color: rgba(243,239,230,.90);
    }
    .fatalCard strong{ font-size: 13px; }
    .fatalCard pre{
      margin: 10px 0 0;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(243,239,230,.14);
      background: rgba(11,10,8,.55);
      overflow:auto;
      max-height: 45vh;
      color: rgba(243,239,230,.86);
      font-size: 12px;
      line-height: 1.35;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* Desktop enhancements (optional): center app width */
    @media (min-width: 980px){
      .app{
        padding-left: 18px;
        padding-right: 18px;
      }
      .topbar, .card, .nav{
        width: min(980px, 100%);
        margin: 0 auto;
      }
    }
  </style>
</head>

<body>
  <div class="app" id="app">

    <!-- TOP BAR -->
    <div class="topbar">
      <div class="brand">
        <div class="logo">W</div>
        <div class="titleWrap">
          <div style="display:flex; align-items:center; gap:8px;">
            <div class="chip" id="laneChip" title="Switch lane (Business / School / Personal)">
              <span class="dot"></span>
              <span id="laneText">Business</span>
              <span style="opacity:.75;">‚ñæ</span>
            </div>
            <div class="sessionTitle" id="sessionTitle">‚Äî</div>
          </div>
          <div class="sessionSub" id="sessionSub">Session: ‚Äî</div>
        </div>
      </div>

      <div style="display:flex; gap:10px; align-items:center;">
        <button class="iconBtn" id="statusBtn" title="Status / Settings">‚õ≠</button>
      </div>
    </div>

    <!-- MAIN CARD -->
    <div class="card">

      <!-- CHAT -->
      <div class="screen active" id="screenChat">
        <div class="feed" id="feed" aria-live="polite"></div>

        <div class="composer">
          <div class="subRow">
            <div>
              <strong id="modelLabel">Text model</strong>
              <span id="modelValue" style="margin-left:8px; font-weight:900; color: rgba(243,239,230,.92);">Mock GPT-Text</span>
            </div>
            <div class="pill" id="enginePill" title="Backend status">
              <span class="tinyDot bad" id="engineDot"></span>
              <span id="engineText">UI only</span>
            </div>
          </div>

          <div class="toolChipsRow">
            <div class="toolChip" id="chipModel">Model</div>
            <div class="toolChip" id="chipImage">Image</div>
            <div class="toolChip" id="chipFiles">Files</div>
            <div class="toolChip" id="chipTemplates">Templates</div>
          </div>

          <div class="warn" id="contextWarn">
            <div id="warnText"></div>
            <div class="warnBtns">
              <button class="btn primary" id="warnSwitchBtn">Switch lane (keep draft)</button>
              <button class="btn" id="warnSendAnywayBtn">Send anyway</button>
            </div>
          </div>

          <label class="srOnly" for="input">Message</label>
          <div class="composerRow">
            <button class="plusBtn" id="plusBtn" title="Tools">Ôºã</button>
            <textarea id="input" placeholder="Message WilliamBot‚Ä¶ (Enter to send, Shift+Enter new line)"></textarea>
            <button class="sendBtn" id="sendBtn" disabled>‚Üí</button>
          </div>

          <div class="subRow">
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <span style="opacity:.8;">Actions:</span>
              <span class="pill" id="btnStop" title="Stop generation"><span class="tinyDot bad" style="background: var(--amber);"></span>Stop</span>
              <span class="pill" id="btnRegen" title="Regenerate last answer"><span class="tinyDot ok"></span>Regenerate</span>
              <span class="pill" id="btnEditLast" title="Edit last user message"><span class="tinyDot"></span>Edit last</span>
            </div>
            <div style="opacity:.8;" id="typingStatus">‚Äî</div>
          </div>
        </div>
      </div>

      <!-- SESSIONS -->
      <div class="screen" id="screenSessions">
        <div class="screenPad">
          <div class="section">
            <div class="sectionTitle">
              <strong>Sessions</strong>
              <span><span id="sessionCount">0</span> total</span>
            </div>

            <div class="grid2">
              <input class="input" id="sessionSearch" placeholder="Search sessions‚Ä¶" />
              <button class="btn primary" id="newSessionBtn">New session</button>
            </div>

            <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
              <button class="btn" id="filterLaneBtn">Filter: current lane</button>
              <button class="btn" id="showAllLanesBtn">Show: all lanes</button>
            </div>
          </div>

          <div class="section">
            <div class="sectionTitle">
              <strong>Session list</strong>
              <span>Tap to open ‚Ä¢ Long-press / ‚Ä¶ for actions</span>
            </div>
            <div class="list" id="sessionList"></div>
          </div>
        </div>
      </div>

      <!-- WORKSPACE -->
      <div class="screen" id="screenWorkspace">
        <div class="screenPad">
          <div class="section">
            <div class="sectionTitle">
              <strong>Workspace</strong>
              <span id="wsHint">Session-bound</span>
            </div>
            <div class="grid2">
              <div class="tile">
                <strong>Lane</strong>
                <small id="wsLane">‚Äî</small>
              </div>
              <div class="tile">
                <strong>Profile</strong>
                <small id="wsProfile">‚Äî</small>
              </div>
            </div>
          </div>

          <div class="section">
            <div class="sectionTitle">
              <strong>Pins</strong>
              <span id="pinCount">0</span>
            </div>
            <div class="list" id="pinList"></div>
            <div style="margin-top:10px;" class="rowBtns">
              <button class="btn" id="clearPinsBtn">Clear pins (this session)</button>
            </div>
          </div>

          <div class="section">
            <div class="sectionTitle">
              <strong>Decision ledger (mock)</strong>
              <span>Business only</span>
            </div>
            <div style="color: rgba(243,239,230,.78); font-size:12.5px; line-height:1.35;">
              When backend connects, this stores pricing/ops decisions with inputs and sources. UI is ready now.
            </div>
            <div class="rowBtns" style="margin-top:10px;">
              <button class="btn" id="addDecisionBtn">Add decision (mock)</button>
              <button class="btn danger" id="clearDecisionsBtn">Clear decisions</button>
            </div>
            <div class="list" id="decisionList" style="margin-top:10px;"></div>
          </div>

          <div class="section">
            <div class="sectionTitle">
              <strong>Export / Import</strong>
              <span>Local backup</span>
            </div>
            <div class="rowBtns">
              <button class="btn primary" id="exportBtn">Export JSON</button>
              <button class="btn" id="importBtn">Import JSON</button>
            </div>
            <input type="file" id="importFile" class="hidden" accept="application/json" />
            <div style="margin-top:10px; color: rgba(243,239,230,.68); font-size:12px; line-height:1.35;">
              Export includes: lanes, sessions, chat history, pins, decisions, file metadata, and preferences.
            </div>
          </div>
        </div>
      </div>

      <!-- TOOLS (gallery + files + templates) -->
      <div class="screen" id="screenTools">
        <div class="screenPad">
          <div class="section">
            <div class="sectionTitle">
              <strong>Tools</strong>
              <span>Front-end ready ‚Ä¢ backend later</span>
            </div>
            <div class="rowBtns">
              <button class="btn primary" id="openImageToolBtn">Image generation</button>
              <button class="btn" id="openFilesToolBtn">Files</button>
              <button class="btn" id="openTemplatesToolBtn">Templates</button>
            </div>
          </div>

          <div class="section">
            <div class="sectionTitle">
              <strong>Image generation (mock)</strong>
              <span id="imgJobCount">0 jobs</span>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <input class="input" id="imgPrompt" placeholder="Describe an image‚Ä¶" />
              <select class="input" id="imgAspect" style="max-width: 200px;">
                <option value="1:1">1:1</option>
                <option value="16:9">16:9</option>
                <option value="9:16">9:16</option>
                <option value="4:3">4:3</option>
              </select>
              <select class="input" id="imgModel" style="max-width: 220px;">
                <option value="Mock SDXL">Mock SDXL</option>
                <option value="Mock Flux">Mock Flux</option>
                <option value="Mock Realistic">Mock Realistic</option>
              </select>
              <button class="btn primary" id="imgGenerateBtn">Generate</button>
              <button class="btn" id="imgCancelBtn">Cancel job</button>
            </div>

            <div style="margin-top:10px; color: rgba(243,239,230,.70); font-size:12px;">
              This produces placeholder tiles now. Later this becomes ComfyUI/A1111 output + progress + gallery.
            </div>

            <div class="grid2" style="margin-top:10px;" id="imgGallery"></div>
          </div>

          <div class="section">
            <div class="sectionTitle">
              <strong>Files (local-only)</strong>
              <span id="fileCount">0 files</span>
            </div>

            <div class="rowBtns">
              <button class="btn primary" id="fileAddBtn">Add files</button>
              <button class="btn" id="fileClearBtn">Clear file list</button>
            </div>
            <input type="file" id="fileInput" class="hidden" multiple />

            <div class="list" id="fileList" style="margin-top:10px;"></div>

            <div style="margin-top:10px; color: rgba(243,239,230,.70); font-size:12px; line-height:1.35;">
              Later: PDF extraction ‚Üí chunking ‚Üí embeddings ‚Üí citations in chat. UI already supports ‚Äúsource chips‚Äù via pins.
            </div>
          </div>

          <div class="section">
            <div class="sectionTitle">
              <strong>Templates</strong>
              <span>One-tap prompts</span>
            </div>
            <div class="list" id="templateList"></div>
          </div>
        </div>
      </div>

    </div>

    <!-- BOTTOM NAV -->
    <div class="nav">
      <button class="navBtn active" data-screen="Chat" id="navChat"><span class="ico">üí¨</span><span>Chat</span></button>
      <button class="navBtn" data-screen="Sessions" id="navSessions"><span class="ico">üóÇÔ∏è</span><span>Sessions</span></button>
      <button class="navBtn" data-screen="Workspace" id="navWorkspace"><span class="ico">üìå</span><span>Workspace</span></button>
      <button class="navBtn" data-screen="Tools" id="navTools"><span class="ico">üß∞</span><span>Tools</span></button>
    </div>

  </div>

  <!-- Backdrop -->
  <div class="backdrop" id="backdrop"></div>

  <!-- Sheets -->
  <div class="sheet" id="sheetLane">
    <div class="sheetCard" role="dialog" aria-modal="true" aria-label="Switch lane">
      <div class="sheetHeader">
        <strong>Switch lane</strong>
        <button class="iconBtn x" data-close="sheetLane">‚úï</button>
      </div>

      <div class="section">
        <div class="sectionTitle">
          <strong>Pick a lane</strong>
          <span>Hard-separated sessions and memory</span>
        </div>
        <div class="rowBtns">
          <button class="btn primary" data-lane="business">Business</button>
          <button class="btn" data-lane="school">School</button>
          <button class="btn" data-lane="personal">Personal</button>
        </div>
        <div style="margin-top:10px; color: rgba(243,239,230,.70); font-size:12px; line-height:1.35;">
          Switching lane jumps to your last session in that lane (or creates a default if none exists).
        </div>
      </div>

      <div class="section">
        <div class="sectionTitle">
          <strong>Lane rules (UI enforced)</strong>
          <span>Leak prevention</span>
        </div>
        <div style="color: rgba(243,239,230,.82); font-size:12.5px; line-height:1.35;">
          ‚Ä¢ Business: pricing, ops, decisions, numbers. <br/>
          ‚Ä¢ School: deadlines, drafts, citations, study plans. <br/>
          ‚Ä¢ Personal: life admin, goals, private notes. <br/><br/>
          The UI warns when your message looks like it belongs to another lane.
        </div>
      </div>
    </div>
  </div>

  <div class="sheet" id="sheetStatus">
    <div class="sheetCard" role="dialog" aria-modal="true" aria-label="Status and settings">
      <div class="sheetHeader">
        <strong>Status / Settings</strong>
        <button class="iconBtn x" data-close="sheetStatus">‚úï</button>
      </div>

      <div class="section">
        <div class="sectionTitle">
          <strong>Connection</strong>
          <span>Mock now</span>
        </div>
        <div class="rowBtns">
          <button class="btn" id="toggleEngineBtn">Toggle: UI only / Connected (mock)</button>
        </div>
        <div style="margin-top:10px; color: rgba(243,239,230,.72); font-size:12px; line-height:1.35;">
          UI supports streaming, stop, jobs, and files. When your PC is ready, we replace the mock engine with real endpoints.
        </div>
      </div>

      <div class="section">
        <div class="sectionTitle">
          <strong>Profile (per session)</strong>
          <span>Changes behavior</span>
        </div>
        <div class="rowBtns" id="profileBtns"></div>
      </div>

      <div class="section">
        <div class="sectionTitle">
          <strong>Models (UI picker)</strong>
          <span>Text model selection</span>
        </div>
        <div class="grid2">
          <select class="input" id="textModelSelect">
            <option value="Mock GPT-Text">Mock GPT-Text</option>
            <option value="Mock Deep Reasoner">Mock Deep Reasoner</option>
            <option value="Mock Fast">Mock Fast</option>
          </select>
          <button class="btn primary" id="applyTextModelBtn">Apply</button>
        </div>
      </div>
    </div>
  </div>

  <div class="sheet" id="sheetTools">
    <div class="sheetCard" role="dialog" aria-modal="true" aria-label="Tools">
      <div class="sheetHeader">
        <strong>Tools</strong>
        <button class="iconBtn x" data-close="sheetTools">‚úï</button>
      </div>

      <div class="section">
        <div class="sectionTitle">
          <strong>Quick actions</strong>
          <span>ChatGPT-style</span>
        </div>
        <div class="rowBtns">
          <button class="btn primary" id="toolOpenModels">Model</button>
          <button class="btn" id="toolOpenImage">Image</button>
          <button class="btn" id="toolOpenFiles">Files</button>
          <button class="btn" id="toolOpenTemplates">Templates</button>
        </div>
      </div>

      <div class="section">
        <div class="sectionTitle">
          <strong>Templates</strong>
          <span>Tap to insert</span>
        </div>
        <div class="list" id="sheetTemplateList"></div>
      </div>
    </div>
  </div>

  <!-- Message context menu -->
  <div class="menu" id="msgMenu" role="menu" aria-label="Message actions">
    <button class="menuBtn" data-act="copy">Copy <span style="opacity:.75;">‚åòC</span></button>
    <button class="menuBtn" data-act="pin">Pin to workspace <span style="opacity:.75;">üìå</span></button>
    <button class="menuBtn" data-act="retry">Regenerate from here <span style="opacity:.75;">‚Üª</span></button>
    <button class="menuBtn" data-act="delete" class="danger">Delete <span style="opacity:.75;">üóëÔ∏è</span></button>
  </div>

  <!-- Fatal overlay -->
  <div class="fatal" id="fatal">
    <div class="fatalCard">
      <strong>WilliamBot UI crashed (no silent white screen).</strong>
      <div style="margin-top:6px; color: rgba(243,239,230,.75); font-size:12px;">
        Copy the error, refresh, and you‚Äôre back.
      </div>
      <pre id="fatalText"></pre>
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:10px;">
        <button class="btn" id="fatalCopy">Copy error</button>
        <button class="btn" id="fatalClose">Close</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      "use strict";

      // -------------------- Safety: show errors instead of blank/white --------------------
      const fatalEl = document.getElementById("fatal");
      const fatalText = document.getElementById("fatalText");
      const fatalCopy = document.getElementById("fatalCopy");
      const fatalClose = document.getElementById("fatalClose");

      function showFatal(err){
        try{
          const msg = (err && err.stack) ? err.stack : String(err);
          fatalText.textContent = msg;
          fatalEl.style.display = "flex";
        } catch {}
      }
      window.addEventListener("error", (e) => showFatal(e.error || e.message || e), true);
      window.addEventListener("unhandledrejection", (e) => showFatal(e.reason || e), true);

      fatalCopy.addEventListener("click", async () => {
        try{ await navigator.clipboard.writeText(fatalText.textContent || ""); } catch {}
      });
      fatalClose.addEventListener("click", () => { fatalEl.style.display = "none"; });

      // -------------------- Helpers --------------------
      const $ = (id) => document.getElementById(id);
      const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
      const safeParse = (json, fallback) => { try { return JSON.parse(json); } catch { return fallback; } };

      function nowTime(){
        const d = new Date();
        return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
      }
      function stamp(){
        const d = new Date();
        return d.toLocaleString([], {month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit"});
      }
      function uid(prefix){
        return (prefix || "id") + "_" + Math.random().toString(36).slice(2, 8) + "_" + Date.now().toString(36).slice(-4);
      }
      function setCSSLane(lane){
        const root = document.documentElement;
        if(lane === "business"){
          root.style.setProperty("--lane", "var(--biz)");
          root.style.setProperty("--lane2", "var(--biz2)");
        } else if(lane === "school"){
          root.style.setProperty("--lane", "var(--school)");
          root.style.setProperty("--lane2", "var(--school2)");
        } else {
          root.style.setProperty("--lane", "var(--personal)");
          root.style.setProperty("--lane2", "var(--personal2)");
        }
      }
      function laneLabel(l){
        return l === "business" ? "Business" : l === "school" ? "School" : "Personal";
      }

      // -------------------- Storage schema --------------------
      const STORE = {
        v: "wb_v7",
        state: "wb_state_v7",
        historyPrefix: "wb_hist_v7_",
        pinsPrefix: "wb_pins_v7_",
        decisionsPrefix: "wb_decisions_v7_",
        files: "wb_files_v7",
      };
      const histKey = (sid) => STORE.historyPrefix + sid;
      const pinsKey = (sid) => STORE.pinsPrefix + sid;
      const decisionsKey = (sid) => STORE.decisionsPrefix + sid;

      function defaultState(){
        return {
          lane: "business",
          showAllLanesInSessions: false,

          activeSession: { business:"biz_main", school:"math107", personal:"life_main" },

          sessions: [
            { id:"biz_main", lane:"business", title:"Business ‚Äî Pricing & Ops", note:"COGS ‚Ä¢ margins ‚Ä¢ Amazon/Shopify ‚Ä¢ decision ledger", updated: stamp() },
            { id:"math107", lane:"school", title:"UMGC ‚Äî MATH 107", note:"Syllabus ‚Ä¢ homework help ‚Ä¢ study plan", updated: stamp() },
            { id:"hist125", lane:"school", title:"UMGC ‚Äî HIST 125", note:"Readings ‚Ä¢ discussions ‚Ä¢ drafts", updated: stamp() },
            { id:"life_main", lane:"personal", title:"Personal ‚Äî Life Admin", note:"Tasks ‚Ä¢ goals ‚Ä¢ notes", updated: stamp() },
          ],

          // per-session profile
          profile: {
            biz_main: "Financial",
            math107: "Study",
            hist125: "Writing",
            life_main: "Life"
          },

          // preferences
          engine: "ui_only", // "ui_only" | "mock_connected"
          textModel: "Mock GPT-Text",

          // image jobs (mock)
          imageJobs: [],

          // templates
          templates: [
            { id:"t_biz_guardrails", lane:"business", title:"Pricing guardrails", text:"Build pricing guardrails for a luxury hair-care product. Ask for inputs (COGS, packaging, shipping, channel fees) then compute margin floors and a pricing ladder." },
            { id:"t_biz_ledger", lane:"business", title:"Decision ledger entry", text:"Create a decision ledger entry template for a pricing change. Include date, SKU, channel, old->new price, inputs, margin impact, risks, and sources." },
            { id:"t_school_plan", lane:"school", title:"Weekly study plan", text:"Build a weekly plan for this course based on due dates and workload. Make it realistic and repeatable." },
            { id:"t_school_cite", lane:"school", title:"Draft with citations (placeholder)", text:"Draft a response with clear structure and placeholders for citations. Ask me for the sources first." },
            { id:"t_life_today", lane:"personal", title:"Plan my day", text:"Plan my day in blocks. Ask for constraints, priorities, and must-do items. Keep it simple and actionable." },
          ]
        };
      }

      function loadState(){
        const raw = localStorage.getItem(STORE.state);
        const st = safeParse(raw, null);
        if(st && st.sessions && st.activeSession) return st;
        const d = defaultState();
        localStorage.setItem(STORE.state, JSON.stringify(d));
        return d;
      }
      function saveState(){
        localStorage.setItem(STORE.state, JSON.stringify(state));
      }

      function loadHistory(sid){
        const raw = localStorage.getItem(histKey(sid));
        const h = safeParse(raw, []);
        return Array.isArray(h) ? h : [];
      }
      function saveHistory(sid, h){
        localStorage.setItem(histKey(sid), JSON.stringify(h.slice(-800)));
      }

      function loadPins(sid){
        const raw = localStorage.getItem(pinsKey(sid));
        const p = safeParse(raw, []);
        return Array.isArray(p) ? p : [];
      }
      function savePins(sid, p){
        localStorage.setItem(pinsKey(sid), JSON.stringify(p.slice(-400)));
      }

      function loadDecisions(sid){
        const raw = localStorage.getItem(decisionsKey(sid));
        const d = safeParse(raw, []);
        return Array.isArray(d) ? d : [];
      }
      function saveDecisions(sid, d){
        localStorage.setItem(decisionsKey(sid), JSON.stringify(d.slice(-400)));
      }

      function loadFiles(){
        const raw = localStorage.getItem(STORE.files);
        const f = safeParse(raw, []);
        return Array.isArray(f) ? f : [];
      }
      function saveFiles(files){
        localStorage.setItem(STORE.files, JSON.stringify(files.slice(-500)));
      }

      let state = loadState();
      let files = loadFiles();

      // -------------------- Derived state --------------------
      function currentLane(){ return state.lane; }
      function activeSessionId(){
        return state.activeSession[currentLane()] || "";
      }
      function getSession(sid){
        return state.sessions.find(s => s.id === sid) || null;
      }
      function activeSession(){
        return getSession(activeSessionId());
      }
      function profileForSession(sid){
        const s = getSession(sid);
        if(!s) return "‚Äî";
        const p = state.profile[sid];
        if(p) return p;
        if(s.lane === "business") return "Financial";
        if(s.lane === "school") return "Study";
        return "Life";
      }

      function laneProfiles(lane){
        if(lane === "business") return ["Financial","Ops","Strategy","Formulation","Compliance"];
        if(lane === "school") return ["Study","Writing","Math","Research"];
        return ["Life","Goals","Admin","Fitness","Relationships"];
      }

      // -------------------- UI refs --------------------
      const backdrop = $("backdrop");
      const sheetLane = $("sheetLane");
      const sheetStatus = $("sheetStatus");
      const sheetTools = $("sheetTools");

      const laneChip = $("laneChip");
      const laneText = $("laneText");
      const sessionTitle = $("sessionTitle");
      const sessionSub = $("sessionSub");

      const engineDot = $("engineDot");
      const engineText = $("engineText");
      const typingStatus = $("typingStatus");

      const feed = $("feed");
      const input = $("input");
      const sendBtn = $("sendBtn");

      const screenChat = $("screenChat");
      const screenSessions = $("screenSessions");
      const screenWorkspace = $("screenWorkspace");
      const screenTools = $("screenTools");

      const navChat = $("navChat");
      const navSessions = $("navSessions");
      const navWorkspace = $("navWorkspace");
      const navTools = $("navTools");

      const sessionCount = $("sessionCount");
      const sessionSearch = $("sessionSearch");
      const sessionList = $("sessionList");
      const newSessionBtn = $("newSessionBtn");
      const filterLaneBtn = $("filterLaneBtn");
      const showAllLanesBtn = $("showAllLanesBtn");

      const wsHint = $("wsHint");
      const wsLane = $("wsLane");
      const wsProfile = $("wsProfile");
      const pinCount = $("pinCount");
      const pinList = $("pinList");
      const clearPinsBtn = $("clearPinsBtn");

      const decisionList = $("decisionList");
      const addDecisionBtn = $("addDecisionBtn");
      const clearDecisionsBtn = $("clearDecisionsBtn");

      const exportBtn = $("exportBtn");
      const importBtn = $("importBtn");
      const importFile = $("importFile");

      const plusBtn = $("plusBtn");
      const statusBtn = $("statusBtn");

      const chipModel = $("chipModel");
      const chipImage = $("chipImage");
      const chipFiles = $("chipFiles");
      const chipTemplates = $("chipTemplates");

      const modelValue = $("modelValue");
      const textModelSelect = $("textModelSelect");
      const applyTextModelBtn = $("applyTextModelBtn");
      const profileBtns = $("profileBtns");
      const toggleEngineBtn = $("toggleEngineBtn");

      const toolOpenModels = $("toolOpenModels");
      const toolOpenImage = $("toolOpenImage");
      const toolOpenFiles = $("toolOpenFiles");
      const toolOpenTemplates = $("toolOpenTemplates");

      const templateList = $("templateList");
      const sheetTemplateList = $("sheetTemplateList");

      const openImageToolBtn = $("openImageToolBtn");
      const openFilesToolBtn = $("openFilesToolBtn");
      const openTemplatesToolBtn = $("openTemplatesToolBtn");

      const imgPrompt = $("imgPrompt");
      const imgAspect = $("imgAspect");
      const imgModel = $("imgModel");
      const imgGenerateBtn = $("imgGenerateBtn");
      const imgCancelBtn = $("imgCancelBtn");
      const imgGallery = $("imgGallery");
      const imgJobCount = $("imgJobCount");

      const fileAddBtn = $("fileAddBtn");
      const fileClearBtn = $("fileClearBtn");
      const fileInput = $("fileInput");
      const fileList = $("fileList");
      const fileCount = $("fileCount");

      const btnStop = $("btnStop");
      const btnRegen = $("btnRegen");
      const btnEditLast = $("btnEditLast");

      const contextWarn = $("contextWarn");
      const warnText = $("warnText");
      const warnSwitchBtn = $("warnSwitchBtn");
      const warnSendAnywayBtn = $("warnSendAnywayBtn");

      const msgMenu = $("msgMenu");

      // -------------------- Navigation --------------------
      function setScreen(name){
        const map = {
          Chat: screenChat,
          Sessions: screenSessions,
          Workspace: screenWorkspace,
          Tools: screenTools
        };
        for(const k in map){
          map[k].classList.toggle("active", k === name);
        }
        for(const btn of [navChat, navSessions, navWorkspace, navTools]){
          btn.classList.toggle("active", btn.dataset.screen === name);
        }
        if(name === "Workspace") renderWorkspace();
        if(name === "Sessions") renderSessions();
        if(name === "Tools") renderTools();
      }

      // -------------------- Sheets --------------------
      function openSheet(sheetEl){
        backdrop.classList.add("open");
        sheetEl.classList.add("open");
        // focus first close button or first input
        const focusable = sheetEl.querySelector("button, [href], input, select, textarea, [tabindex]:not([tabindex='-1'])");
        if(focusable) setTimeout(() => focusable.focus(), 0);
      }
      function closeSheet(sheetEl){
        sheetEl.classList.remove("open");
        const anyOpen = [sheetLane, sheetStatus, sheetTools].some(s => s.classList.contains("open"));
        if(!anyOpen) backdrop.classList.remove("open");
      }
      function closeAllSheets(){
        closeSheet(sheetLane);
        closeSheet(sheetStatus);
        closeSheet(sheetTools);
        closeMsgMenu();
      }

      // -------------------- Top bar render --------------------
      function updateTopBar(){
        const lane = currentLane();
        setCSSLane(lane);
        laneText.textContent = laneLabel(lane);

        const s = activeSession();
        sessionTitle.textContent = s ? s.title : "‚Äî";
        sessionSub.textContent = "Session: " + (s ? s.note : "‚Äî");

        modelValue.textContent = state.textModel;

        if(state.engine === "ui_only"){
          engineDot.classList.remove("ok"); engineDot.classList.add("bad");
          engineText.textContent = "UI only";
        } else {
          engineDot.classList.remove("bad"); engineDot.classList.add("ok");
          engineText.textContent = "Connected (mock)";
        }

        // keep select in sync
        textModelSelect.value = state.textModel;
      }

      // -------------------- History rendering --------------------
      function ensureIntro(sid){
        const s = getSession(sid);
        if(!s) return;

        let h = loadHistory(sid);
        if(h.length) return;

        const introText = (s.lane === "business")
          ? `Business lane loaded.\n\nUI is ready now:\n‚Ä¢ Sessions separated from School/Personal\n‚Ä¢ Streaming + Stop + Regenerate\n‚Ä¢ Pins + Decision ledger\n‚Ä¢ Image & Files tools (mock)\n\nWhen your backend connects, this becomes COGS-aware pricing, RAG, and real image generation.`
          : (s.lane === "school")
          ? `School lane loaded.\n\nUI is ready now:\n‚Ä¢ Sessions per class\n‚Ä¢ Streaming + Stop + Regenerate\n‚Ä¢ Pins for citations/notes\n‚Ä¢ Templates for drafts and plans\n\nWhen backend connects, this parses syllabi, extracts deadlines, and cites sources.`
          : `Personal lane loaded.\n\nUI is ready now:\n‚Ä¢ Private sessions\n‚Ä¢ Pins for plans and notes\n‚Ä¢ Templates for daily planning\n\nWhen backend connects, this can run local models without mixing with Business/School.`;

        h = [{
          id: uid("m"),
          role: "bot",
          ts: nowTime(),
          content: introText
        }];
        saveHistory(sid, h);
      }

      function renderFeed(){
        const sid = activeSessionId();
        feed.innerHTML = "";
        if(!sid){
          feed.innerHTML = `<div style="padding:14px 12px; color: rgba(243,239,230,.72);">No active session.</div>`;
          return;
        }

        ensureIntro(sid);

        const h = loadHistory(sid);
        for(const m of h){
          renderMessageNode(m);
        }
        feed.scrollTop = feed.scrollHeight;
      }

      function renderMessageNode(m){
        const row = document.createElement("div");
        row.className = "row " + (m.role === "you" ? "you" : "bot");
        row.dataset.mid = m.id;

        const wrap = document.createElement("div");
        wrap.className = "bubbleWrap";

        const bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.textContent = m.content || "";

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.innerHTML = `<span>${m.role === "you" ? "You" : "WilliamBot"}</span><span style="opacity:.65;">${m.ts || ""}</span>`;

        // Message actions (ChatGPT-like)
        const tools = document.createElement("div");
        tools.className = "msgTools";
        const more = document.createElement("button");
        more.className = "miniAction";
        more.textContent = "‚ãØ";
        more.title = "Message actions";
        more.addEventListener("click", (e) => {
          e.preventDefault(); e.stopPropagation();
          openMsgMenu(m.id, e.clientX, e.clientY);
        });

        tools.appendChild(more);

        wrap.appendChild(bubble);
        wrap.appendChild(meta);
        wrap.appendChild(tools);

        row.appendChild(wrap);
        feed.appendChild(row);
      }

      // -------------------- Context warning (lane leak prevention) --------------------
      const SCHOOL_HINTS = ["syllabus","assignment","homework","quiz","discussion post","apa","citation","umgc","grade","module","week"];
      const BIZ_HINTS = ["cogs","margin","msrp","sku","shopify","amazon","fba","fbm","overhead","fees","pricing","profit","inventory","supplier"];
      const LIFE_HINTS = ["relationship","family","sleep","routine","habit","mental","goal","diet","workout","schedule","appointment","personal"];

      function classify(text){
        const t = String(text || "").toLowerCase();
        const looksSchool = SCHOOL_HINTS.some(k => t.includes(k));
        const looksBiz = BIZ_HINTS.some(k => t.includes(k));
        const looksLife = LIFE_HINTS.some(k => t.includes(k));
        return { looksSchool, looksBiz, looksLife };
      }

      let pendingWarn = null; // {suggestLane, draft}
      function maybeWarn(text){
        const sid = activeSessionId();
        if(!sid){ hideWarn(); return; }

        const lane = currentLane();
        const c = classify(text);

        // decide suggestion if strong mismatch
        let suggest = null;

        if(lane === "business"){
          if(c.looksSchool && !c.looksBiz) suggest = "school";
          else if(c.looksLife && !c.looksBiz) suggest = "personal";
        } else if(lane === "school"){
          if(c.looksBiz && !c.looksSchool) suggest = "business";
          else if(c.looksLife && !c.looksSchool) suggest = "personal";
        } else {
          if(c.looksBiz && !c.looksLife) suggest = "business";
          else if(c.looksSchool && !c.looksLife) suggest = "school";
        }

        if(suggest){
          pendingWarn = { suggestLane: suggest, draft: text };
          warnText.innerHTML =
            `<strong>Context check:</strong> This looks like <b>${laneLabel(suggest)}</b> content, but you‚Äôre in <b>${laneLabel(lane)}</b>.`;
          contextWarn.style.display = "block";
          return;
        }
        hideWarn();
      }
      function hideWarn(){
        pendingWarn = null;
        contextWarn.style.display = "none";
        warnText.textContent = "";
      }

      // -------------------- Mock engine (streaming, stop, regenerate) --------------------
      let streamTimer = null;
      let streamState = null; // {sid, botId, fullText, idx}
      function isStreaming(){ return !!streamTimer; }

      function stopStreaming(){
        if(streamTimer){
          clearInterval(streamTimer);
          streamTimer = null;
        }
        streamState = null;
        typingStatus.textContent = "Stopped";
      }

      function appendToMessage(sid, mid, delta){
        const h = loadHistory(sid);
        const msg = h.find(x => x.id === mid);
        if(!msg) return;
        msg.content += delta;
        saveHistory(sid, h);

        // update DOM bubble if visible
        const node = feed.querySelector(`[data-mid="${mid}"] .bubble`);
        if(node) node.textContent = msg.content;
        feed.scrollTop = feed.scrollHeight;
      }

      function setMessageContent(sid, mid, content){
        const h = loadHistory(sid);
        const msg = h.find(x => x.id === mid);
        if(!msg) return;
        msg.content = content;
        saveHistory(sid, h);
        const node = feed.querySelector(`[data-mid="${mid}"] .bubble`);
        if(node) node.textContent = msg.content;
      }

      function mockReplyForLane(lane, profile, userText){
        // Lean "ChatGPT-like": crisp, structured, practical.
        // Also: we keep "best thing" feel by showing tool readiness + next actions.
        const t = userText.trim();

        if(lane === "business"){
          return [
            `UI-only mode (backend not connected).`,
            ``,
            `**Business lane / ${profile}**`,
            `What I can do right now (front-end):`,
            `‚Ä¢ Keep sessions separated from School/Personal`,
            `‚Ä¢ Pin outputs into Workspace`,
            `‚Ä¢ Draft a decision ledger entry`,
            ``,
            `What I need when backend is ready:`,
            `1) COGS per SKU`,
            `2) Packaging unit cost`,
            `3) Shipping range`,
            `4) Channel fees (Amazon/Shopify)`,
            ``,
            `If you want, reply with:`,
            `- SKU + size (e.g., 120 ml leave-in)`,
            `- rough COGS`,
            `and I‚Äôll format the pricing guardrails template.`
          ].join("\n");
        }

        if(lane === "school"){
          return [
            `UI-only mode (backend not connected).`,
            ``,
            `**School lane / ${profile}**`,
            `Pick one:`,
            `1) Weekly plan (repeatable)`,
            `2) Draft outline + thesis`,
            `3) Explain a concept step-by-step`,
            ``,
            `Paste the prompt or question and I‚Äôll structure it the way you can submit.`
          ].join("\n");
        }

        return [
          `UI-only mode (backend not connected).`,
          ``,
          `**Personal lane / ${profile}**`,
          `If you tell me:`,
          `‚Ä¢ top 3 priorities`,
          `‚Ä¢ time window`,
          `‚Ä¢ one constraint`,
          `I‚Äôll build a simple plan with blocks + checklist.`
        ].join("\n");
      }

      function startMockStreamingAnswer(sid, userText, fromIndex){
        stopStreaming();

        const s = getSession(sid);
        if(!s) return;

        const profile = profileForSession(sid);
        const botId = uid("m");

        const h = loadHistory(sid);
        const botMsg = { id: botId, role:"bot", ts: nowTime(), content:"" };
        h.push(botMsg);
        saveHistory(sid, h);

        renderMessageNode(botMsg);

        // Build full text
        const full = mockReplyForLane(s.lane, profile, userText);

        streamState = { sid, botId, fullText: full, idx: 0 };
        typingStatus.textContent = "Generating‚Ä¶";

        const speed = state.engine === "mock_connected" ? 10 : 14; // ms-ish cadence
        streamTimer = setInterval(() => {
          if(!streamState) return;

          const chunkSize = 2; // characters per tick
          const start = streamState.idx;
          const end = Math.min(streamState.fullText.length, start + chunkSize);
          const delta = streamState.fullText.slice(start, end);

          appendToMessage(streamState.sid, streamState.botId, delta);
          streamState.idx = end;

          if(streamState.idx >= streamState.fullText.length){
            clearInterval(streamTimer);
            streamTimer = null;
            streamState = null;
            typingStatus.textContent = "Done";
          }
        }, speed);
      }

      // -------------------- Sending --------------------
      function syncSendButton(){
        sendBtn.disabled = input.value.trim().length === 0 || !activeSession();
      }

      function addUserMessage(sid, text){
        const h = loadHistory(sid);
        const m = { id: uid("m"), role:"you", ts: nowTime(), content: text };
        h.push(m);
        saveHistory(sid, h);

        renderMessageNode(m);
        feed.scrollTop = feed.scrollHeight;

        // session updated
        const s = getSession(sid);
        if(s){ s.updated = stamp(); saveState(); }
        return m;
      }

      function sendMessage(forceSendAnyway){
        const sid = activeSessionId();
        if(!sid) return;

        const text = input.value.trim();
        if(!text) return;

        if(!forceSendAnyway){
          maybeWarn(text);
          if(pendingWarn){
            // don‚Äôt send yet
            return;
          }
        } else {
          hideWarn();
        }

        input.value = "";
        syncSendButton();

        const youMsg = addUserMessage(sid, text);

        // stream mock answer
        startMockStreamingAnswer(sid, youMsg.content);
      }

      // Edit last user message
      function editLastUser(){
        const sid = activeSessionId();
        if(!sid) return;
        const h = loadHistory(sid);
        const lastYou = [...h].reverse().find(x => x.role === "you");
        if(!lastYou) return;

        input.value = lastYou.content;
        input.focus();
        syncSendButton();
        setScreen("Chat");
      }

      // Regenerate last answer (simple: remove last bot msg and rerun)
      function regenerate(){
        const sid = activeSessionId();
        if(!sid) return;

        stopStreaming();

        const h = loadHistory(sid);
        const lastYou = [...h].reverse().find(x => x.role === "you");
        if(!lastYou) return;

        // remove last bot message if it exists after lastYou
        // easiest: delete last bot in history
        const idx = [...h].map((m,i)=>({m,i})).reverse().find(x => x.m.role === "bot");
        if(idx){
          h.splice(idx.i, 1);
          saveHistory(sid, h);
        }
        renderFeed();
        startMockStreamingAnswer(sid, lastYou.content);
      }

      // -------------------- Sessions --------------------
      function createSession(){
        const lane = currentLane();
        const sid = uid("s");
        const title = (lane === "business") ? "Business ‚Äî New Session"
                  : (lane === "school") ? "UMGC ‚Äî New Class Session"
                  : "Personal ‚Äî New Session";
        const note = (lane === "business") ? "Pricing ‚Ä¢ ops ‚Ä¢ planning"
                 : (lane === "school") ? "Study plan ‚Ä¢ assignments ‚Ä¢ notes"
                 : "Life admin ‚Ä¢ goals ‚Ä¢ notes";

        const sess = { id: sid, lane, title, note, updated: stamp() };
        state.sessions = [sess, ...state.sessions];
        state.activeSession[lane] = sid;

        // default profile
        state.profile[sid] = (lane === "business") ? "Financial" : (lane === "school") ? "Study" : "Life";

        saveState();
        updateTopBar();
        ensureIntro(sid);
        renderFeed();
        renderSessions();
        setScreen("Chat");
      }

      function setActiveSession(sid){
        const s = getSession(sid);
        if(!s) return;

        state.lane = s.lane; // lane follows session
        state.activeSession[s.lane] = s.id;
        saveState();

        updateTopBar();
        renderFeed();
        renderWorkspace();
      }

      function renameSession(sid){
        const s = getSession(sid);
        if(!s) return;
        const next = prompt("Rename session:", s.title);
        if(!next) return;
        s.title = next.trim().slice(0, 90) || s.title;
        s.updated = stamp();
        saveState();
        updateTopBar();
        renderSessions();
      }

      function deleteSession(sid){
        const s = getSession(sid);
        if(!s) return;

        const protectedIds = new Set(["biz_main","math107","hist125","life_main"]);
        if(protectedIds.has(sid)){
          alert("That session is protected (default). Create new ones and delete those instead.");
          return;
        }

        const ok = confirm("Delete this session? This removes its chat history from this browser.");
        if(!ok) return;

        // remove from sessions
        state.sessions = state.sessions.filter(x => x.id !== sid);

        // cleanup storage keys
        try{ localStorage.removeItem(histKey(sid)); } catch {}
        try{ localStorage.removeItem(pinsKey(sid)); } catch {}
        try{ localStorage.removeItem(decisionsKey(sid)); } catch {}
        try{ delete state.profile[sid]; } catch {}

        // if it was active, pick first in lane
        if(state.activeSession[s.lane] === sid){
          const first = state.sessions.find(x => x.lane === s.lane);
          state.activeSession[s.lane] = first ? first.id : "";
        }

        saveState();
        updateTopBar();
        renderSessions();
        renderFeed();
      }

      function renderSessions(){
        sessionCount.textContent = String(state.sessions.length);

        const q = (sessionSearch.value || "").trim().toLowerCase();
        const showAll = !!state.showAllLanesInSessions;
        const lane = currentLane();

        const list = state.sessions.filter(s => {
          if(!showAll && s.lane !== lane) return false;
          if(!q) return true;
          return (s.title || "").toLowerCase().includes(q) || (s.note || "").toLowerCase().includes(q);
        });

        sessionList.innerHTML = "";
        if(!list.length){
          sessionList.innerHTML = `<div style="color: rgba(243,239,230,.70); font-size:12px;">No sessions match.</div>`;
          return;
        }

        const activeId = activeSessionId();

        for(const s of list){
          const div = document.createElement("div");
          div.className = "item" + (s.id === activeId ? " activeGlow" : "");
          div.dataset.sid = s.id;

          div.innerHTML = `
            <div class="itemTop">
              <div class="itemTitle">${escapeHtml(s.title)}</div>
              <span class="pillMini">${laneLabel(s.lane)}</span>
            </div>
            <div class="itemMeta">
              ${escapeHtml(s.note || "")}<br/>
              <span style="color: rgba(243,239,230,.58)">Updated: ${escapeHtml(s.updated || "‚Äî")}</span>
            </div>
          `;

          // Tap to open
          div.addEventListener("click", () => {
            setActiveSession(s.id);
            setScreen("Chat");
          });

          // Long press for actions
          let pressTimer = null;
          div.addEventListener("touchstart", () => {
            pressTimer = setTimeout(() => {
              openSessionActions(s.id);
            }, 520);
          }, {passive:true});
          div.addEventListener("touchend", () => { if(pressTimer) clearTimeout(pressTimer); pressTimer=null; });
          div.addEventListener("touchmove", () => { if(pressTimer) clearTimeout(pressTimer); pressTimer=null; });

          sessionList.appendChild(div);
        }
      }

      function openSessionActions(sid){
        const s = getSession(sid);
        if(!s) return;
        const choice = prompt(
          `Session actions:\n1 = Rename\n2 = Delete\n\nEnter 1 or 2:`,
          "1"
        );
        if(!choice) return;
        if(choice.trim() === "1") renameSession(sid);
        if(choice.trim() === "2") deleteSession(sid);
      }

      function escapeHtml(s){
        return String(s).replace(/[&<>"']/g, c => ({
          "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
        }[c]));
      }

      // -------------------- Workspace (pins + decisions) --------------------
      function renderWorkspace(){
        const s = activeSession();
        if(!s){
          wsHint.textContent = "No session";
          wsLane.textContent = "‚Äî";
          wsProfile.textContent = "‚Äî";
          pinList.innerHTML = "";
          decisionList.innerHTML = "";
          return;
        }

        wsHint.textContent = s.id.toUpperCase();
        wsLane.textContent = laneLabel(s.lane);
        wsProfile.textContent = profileForSession(s.id);

        const pins = loadPins(s.id);
        pinCount.textContent = String(pins.length);
        pinList.innerHTML = "";
        if(!pins.length){
          pinList.innerHTML = `<div style="color: rgba(243,239,230,.70); font-size:12px;">No pins yet. Pin a message from chat.</div>`;
        } else {
          for(const p of pins.slice().reverse()){
            const div = document.createElement("div");
            div.className = "item";
            div.innerHTML = `
              <div class="itemTop">
                <div class="itemTitle">${escapeHtml(p.title || "Pinned item")}</div>
                <span class="pillMini">${escapeHtml(p.kind || "note")}</span>
              </div>
              <div class="itemMeta">${escapeHtml(p.content || "")}</div>
            `;
            div.addEventListener("click", () => {
              // jump to chat; for now we just open chat
              setScreen("Chat");
            });
            pinList.appendChild(div);
          }
        }

        // Decisions (business only)
        const dec = loadDecisions(s.id);
        decisionList.innerHTML = "";
        if(s.lane !== "business"){
          decisionList.innerHTML = `<div style="color: rgba(243,239,230,.70); font-size:12px;">Decision ledger is Business lane only.</div>`;
        } else if(!dec.length){
          decisionList.innerHTML = `<div style="color: rgba(243,239,230,.70); font-size:12px;">No decisions yet. Add one (mock).</div>`;
        } else {
          for(const d of dec.slice().reverse()){
            const div = document.createElement("div");
            div.className = "item";
            div.innerHTML = `
              <div class="itemTop">
                <div class="itemTitle">${escapeHtml(d.title || "Decision")}</div>
                <span class="pillMini">${escapeHtml(d.date || "")}</span>
              </div>
              <div class="itemMeta">${escapeHtml(d.body || "")}</div>
            `;
            decisionList.appendChild(div);
          }
        }
      }

      function pinMessage(mid){
        const sid = activeSessionId();
        if(!sid) return;
        const h = loadHistory(sid);
        const m = h.find(x => x.id === mid);
        if(!m) return;

        const pins = loadPins(sid);
        pins.push({
          id: uid("pin"),
          ts: stamp(),
          kind: (m.role === "bot") ? "output" : "note",
          title: (m.role === "bot") ? "Bot output" : "User note",
          content: (m.content || "").slice(0, 800)
        });
        savePins(sid, pins);
        renderWorkspace();
      }

      function addDecisionMock(){
        const s = activeSession();
        if(!s || s.lane !== "business") return;

        const title = prompt("Decision title (e.g., 'Raise 8oz butter MSRP'):", "Pricing decision");
        if(!title) return;

        const body = prompt("Decision note (inputs + why):", "Inputs: COGS=?, fees=?, ship=? | Why: ?");
        const dec = loadDecisions(s.id);
        dec.push({ id: uid("dec"), date: stamp(), title, body: body || "" });
        saveDecisions(s.id, dec);
        renderWorkspace();
      }

      // -------------------- Tools (templates, images, files) --------------------
      function renderTemplates(){
        const lane = currentLane();
        const list = state.templates.filter(t => t.lane === lane);

        function renderInto(el){
          el.innerHTML = "";
          for(const t of list){
            const div = document.createElement("div");
            div.className = "item";
            div.innerHTML = `
              <div class="itemTop">
                <div class="itemTitle">${escapeHtml(t.title)}</div>
                <span class="pillMini">${laneLabel(t.lane)}</span>
              </div>
              <div class="itemMeta">${escapeHtml(t.text.slice(0, 120))}${t.text.length > 120 ? "‚Ä¶" : ""}</div>
            `;
            div.addEventListener("click", () => {
              // insert into composer
              input.value = t.text;
              syncSendButton();
              setScreen("Chat");
              closeAllSheets();
              input.focus();
            });
            el.appendChild(div);
          }
        }

        renderInto(templateList);
        renderInto(sheetTemplateList);
      }

      function renderImages(){
        imgJobCount.textContent = String(state.imageJobs.length) + " jobs";
        imgGallery.innerHTML = "";

        const jobs = state.imageJobs.slice().reverse();
        if(!jobs.length){
          imgGallery.innerHTML = `
            <div class="tile">
              <strong>No images yet</strong>
              <small>Generate a mock job to test the UI. Later we replace placeholders with real outputs.</small>
              <div class="imgPh">IMG</div>
            </div>
          `;
          return;
        }

        for(const j of jobs.slice(0, 12)){
          const tile = document.createElement("div");
          tile.className = "tile";
          tile.innerHTML = `
            <strong>${escapeHtml(j.model || "Model")} ‚Ä¢ ${escapeHtml(j.aspect || "1:1")}</strong>
            <small>${escapeHtml((j.prompt || "").slice(0, 120))}${(j.prompt || "").length > 120 ? "‚Ä¶" : ""}</small>
            <div class="imgPh">${escapeHtml(j.status || "done").toUpperCase()}</div>
            <div class="rowBtns" style="margin-top:10px;">
              <button class="btn" data-act="reuse" data-id="${escapeHtml(j.id)}">Reuse</button>
              <button class="btn danger" data-act="del" data-id="${escapeHtml(j.id)}">Delete</button>
            </div>
          `;
          imgGallery.appendChild(tile);
        }

        // gallery actions
        imgGallery.querySelectorAll("[data-act]").forEach(btn => {
          btn.addEventListener("click", (e) => {
            const act = btn.getAttribute("data-act");
            const id = btn.getAttribute("data-id");
            const job = state.imageJobs.find(x => x.id === id);
            if(!job) return;

            if(act === "reuse"){
              imgPrompt.value = job.prompt || "";
              imgAspect.value = job.aspect || "1:1";
              imgModel.value = job.model || "Mock SDXL";
            }
            if(act === "del"){
              state.imageJobs = state.imageJobs.filter(x => x.id !== id);
              saveState();
              renderImages();
            }
          });
        });
      }

      let currentImageJobId = null;
      let imgJobTimer = null;

      function createMockImageJob(){
        const prompt = (imgPrompt.value || "").trim();
        if(!prompt){
          alert("Enter an image prompt.");
          return;
        }

        // cancel any running
        cancelMockImageJob();

        const job = {
          id: uid("img"),
          ts: stamp(),
          prompt,
          aspect: imgAspect.value,
          model: imgModel.value,
          status: "queued"
        };
        state.imageJobs.push(job);
        saveState();
        renderImages();

        currentImageJobId = job.id;
        job.status = "running";
        saveState();
        renderImages();

        // mock progress to "done"
        imgJobTimer = setTimeout(() => {
          const j = state.imageJobs.find(x => x.id === currentImageJobId);
          if(j) j.status = "done";
          currentImageJobId = null;
          imgJobTimer = null;
          saveState();
          renderImages();
        }, 1200);
      }

      function cancelMockImageJob(){
        if(imgJobTimer){
          clearTimeout(imgJobTimer);
          imgJobTimer = null;
        }
        if(currentImageJobId){
          const j = state.imageJobs.find(x => x.id === currentImageJobId);
          if(j) j.status = "canceled";
          currentImageJobId = null;
          saveState();
          renderImages();
        }
      }

      function renderFiles(){
        fileCount.textContent = String(files.length) + " files";
        fileList.innerHTML = "";
        if(!files.length){
          fileList.innerHTML = `<div style="color: rgba(243,239,230,.70); font-size:12px;">No files yet. Add PDFs/images later for RAG.</div>`;
          return;
        }

        for(const f of files.slice().reverse()){
          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = `
            <div class="itemTop">
              <div class="itemTitle">${escapeHtml(f.name)}</div>
              <span class="pillMini">${escapeHtml(f.type || "file")}</span>
            </div>
            <div class="itemMeta">
              Size: ${escapeHtml(String(f.size || 0))} bytes<br/>
              Added: ${escapeHtml(f.ts || "")}
            </div>
          `;
          div.addEventListener("click", () => {
            // pin as "source" placeholder
            const sid = activeSessionId();
            if(!sid) return;
            const pins = loadPins(sid);
            pins.push({
              id: uid("pin"),
              ts: stamp(),
              kind: "source",
              title: "File (placeholder)",
              content: `${f.name} ‚Ä¢ (indexing/citations will be added when backend is connected)`
            });
            savePins(sid, pins);
            alert("Pinned to Workspace as a source placeholder.");
          });
          fileList.appendChild(div);
        }
      }

      function renderTools(){
        renderTemplates();
        renderImages();
        renderFiles();
      }

      // -------------------- Message menu actions --------------------
      let menuMid = null;

      function openMsgMenu(mid, x, y){
        menuMid = mid;
        closeAllSheets(); // close sheets but not menu
        backdrop.classList.add("open");

        // position near click
        const w = 240;
        const h = 220;
        const px = clamp(x - w, 12, window.innerWidth - w - 12);
        const py = clamp(y - h, 12, window.innerHeight - h - 12);

        msgMenu.style.left = px + "px";
        msgMenu.style.top = py + "px";
        msgMenu.classList.add("open");
      }

      function closeMsgMenu(){
        msgMenu.classList.remove("open");
        menuMid = null;
        // backdrop only closes if no sheets open
        const anySheet = [sheetLane, sheetStatus, sheetTools].some(s => s.classList.contains("open"));
        if(!anySheet) backdrop.classList.remove("open");
      }

      function deleteMessage(mid){
        const sid = activeSessionId();
        if(!sid) return;
        const h = loadHistory(sid).filter(m => m.id !== mid);
        saveHistory(sid, h);
        renderFeed();
      }

      function retryFromHere(mid){
        const sid = activeSessionId();
        if(!sid) return;

        stopStreaming();

        const h = loadHistory(sid);
        const idx = h.findIndex(m => m.id === mid);
        if(idx < 0) return;

        // find the nearest user message at or before idx
        let u = null;
        for(let i = idx; i >= 0; i--){
          if(h[i].role === "you"){ u = h[i]; break; }
        }
        if(!u) return;

        // truncate history after u (drop bot replies after it)
        const uIdx = h.findIndex(m => m.id === u.id);
        const truncated = h.slice(0, uIdx + 1);
        saveHistory(sid, truncated);

        renderFeed();
        startMockStreamingAnswer(sid, u.content);
      }

      msgMenu.addEventListener("click", async (e) => {
        const btn = e.target.closest("[data-act]");
        if(!btn) return;
        const act = btn.getAttribute("data-act");
        const mid = menuMid;
        if(!mid) return;

        const sid = activeSessionId();

        if(act === "copy"){
          try{
            const h = loadHistory(sid);
            const m = h.find(x => x.id === mid);
            if(m) await navigator.clipboard.writeText(m.content || "");
          } catch {}
        }

        if(act === "pin"){
          pinMessage(mid);
        }

        if(act === "retry"){
          retryFromHere(mid);
        }

        if(act === "delete"){
          deleteMessage(mid);
        }

        closeMsgMenu();
      });

      // -------------------- Export/Import --------------------
      function exportJSON(){
        const blob = new Blob([JSON.stringify({ state, files }, null, 2)], {type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "williambot_backup.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 2000);
      }

      function importJSON(file){
        const reader = new FileReader();
        reader.onload = () => {
          try{
            const obj = JSON.parse(String(reader.result || "{}"));
            if(!obj || !obj.state) throw new Error("Invalid backup format.");
            state = obj.state;
            files = Array.isArray(obj.files) ? obj.files : [];
            saveState();
            saveFiles(files);

            // refresh UI
            updateTopBar();
            renderFeed();
            renderSessions();
            renderWorkspace();
            renderTools();
            alert("Import complete.");
          } catch (e){
            alert("Import failed: " + (e && e.message ? e.message : String(e)));
          }
        };
        reader.readAsText(file);
      }

      // -------------------- Status sheet (profiles/models) --------------------
      function renderProfileButtons(){
        const sid = activeSessionId();
        const s = activeSession();
        profileBtns.innerHTML = "";
        if(!s) return;

        const opts = laneProfiles(s.lane);
        const cur = profileForSession(sid);

        for(const p of opts){
          const b = document.createElement("button");
          b.className = "btn" + (p === cur ? " primary" : "");
          b.textContent = p;
          b.addEventListener("click", () => {
            state.profile[sid] = p;
            saveState();
            updateTopBar();
            renderWorkspace();
            renderProfileButtons();
            // also pin the behavior change visibly
            const pins = loadPins(sid);
            pins.push({ id: uid("pin"), ts: stamp(), kind:"mode", title:"Profile changed", content:`Profile set to: ${p}` });
            savePins(sid, pins);
          });
          profileBtns.appendChild(b);
        }
      }

      // -------------------- Wiring events --------------------
      function wire(){
        // Navigation
        navChat.addEventListener("click", () => setScreen("Chat"));
        navSessions.addEventListener("click", () => setScreen("Sessions"));
        navWorkspace.addEventListener("click", () => setScreen("Workspace"));
        navTools.addEventListener("click", () => setScreen("Tools"));

        // Top actions
        laneChip.addEventListener("click", () => { openSheet(sheetLane); });
        statusBtn.addEventListener("click", () => { renderProfileButtons(); openSheet(sheetStatus); });

        // Lane sheet lane buttons
        sheetLane.addEventListener("click", (e) => {
          const b = e.target.closest("[data-lane]");
          if(!b) return;
          const lane = b.getAttribute("data-lane");
          if(!lane) return;
          // switch lane and jump to last session in that lane
          state.lane = lane;
          const sid = state.activeSession[lane];
          if(!sid){
            // create a default session if missing
            const defId = (lane === "business") ? "biz_main" : (lane === "school") ? "math107" : "life_main";
            state.activeSession[lane] = defId;
          }
          saveState();
          updateTopBar();
          renderFeed();
          renderWorkspace();
          renderSessions();
          renderTools();
          closeSheet(sheetLane);
        });

        // Close buttons
        document.querySelectorAll("[data-close]").forEach(btn => {
          btn.addEventListener("click", () => {
            const id = btn.getAttribute("data-close");
            closeSheet($(id));
          });
        });

        // Backdrop click
        backdrop.addEventListener("click", () => closeAllSheets());
        window.addEventListener("keydown", (e) => {
          if(e.key === "Escape") closeAllSheets();
        });

        // Composer
        input.addEventListener("input", () => {
          syncSendButton();
          maybeWarn(input.value);
        });

        input.addEventListener("keydown", (e) => {
          if(e.key === "Enter" && !e.shiftKey){
            e.preventDefault();
            sendMessage(false);
          }
        });

        sendBtn.addEventListener("click", () => sendMessage(false));

        // Warn buttons
        warnSwitchBtn.addEventListener("click", () => {
          if(!pendingWarn) return;
          const draft = pendingWarn.draft;
          const targetLane = pendingWarn.suggestLane;
          hideWarn();

          state.lane = targetLane;
          // jump to active session in that lane
          saveState();
          updateTopBar();
          renderFeed();
          renderWorkspace();

          input.value = draft;
          syncSendButton();
          setScreen("Chat");
          input.focus();
        });

        warnSendAnywayBtn.addEventListener("click", () => sendMessage(true));

        // Action pills
        btnStop.addEventListener("click", stopStreaming);
        btnRegen.addEventListener("click", regenerate);
        btnEditLast.addEventListener("click", editLastUser);

        // Tools: plus button opens tools sheet
        plusBtn.addEventListener("click", () => {
          renderTemplates();
          openSheet(sheetTools);
        });

        // Tool chips (quick jumps)
        chipModel.addEventListener("click", () => { openSheet(sheetStatus); });
        chipImage.addEventListener("click", () => { setScreen("Tools"); closeAllSheets(); });
        chipFiles.addEventListener("click", () => { setScreen("Tools"); closeAllSheets(); });
        chipTemplates.addEventListener("click", () => { setScreen("Tools"); closeAllSheets(); });

        // Sheet tool buttons
        toolOpenModels.addEventListener("click", () => { closeSheet(sheetTools); openSheet(sheetStatus); });
        toolOpenImage.addEventListener("click", () => { closeAllSheets(); setScreen("Tools"); imgPrompt.focus(); });
        toolOpenFiles.addEventListener("click", () => { closeAllSheets(); setScreen("Tools"); });
        toolOpenTemplates.addEventListener("click", () => { closeAllSheets(); setScreen("Tools"); });

        // Status: engine toggle
        toggleEngineBtn.addEventListener("click", () => {
          state.engine = (state.engine === "ui_only") ? "mock_connected" : "ui_only";
          saveState();
          updateTopBar();
        });

        // Status: apply text model
        applyTextModelBtn.addEventListener("click", () => {
          state.textModel = textModelSelect.value;
          saveState();
          updateTopBar();
          closeSheet(sheetStatus);
        });

        // Sessions screen
        newSessionBtn.addEventListener("click", createSession);
        sessionSearch.addEventListener("input", renderSessions);

        filterLaneBtn.addEventListener("click", () => {
          state.showAllLanesInSessions = false;
          saveState();
          renderSessions();
        });
        showAllLanesBtn.addEventListener("click", () => {
          state.showAllLanesInSessions = true;
          saveState();
          renderSessions();
        });

        // Workspace
        clearPinsBtn.addEventListener("click", () => {
          const sid = activeSessionId();
          if(!sid) return;
          const ok = confirm("Clear pins for this session?");
          if(!ok) return;
          savePins(sid, []);
          renderWorkspace();
        });

        addDecisionBtn.addEventListener("click", addDecisionMock);
        clearDecisionsBtn.addEventListener("click", () => {
          const s = activeSession();
          if(!s || s.lane !== "business") return;
          const ok = confirm("Clear decision ledger for this session?");
          if(!ok) return;
          saveDecisions(s.id, []);
          renderWorkspace();
        });

        // Export/Import
        exportBtn.addEventListener("click", exportJSON);
        importBtn.addEventListener("click", () => importFile.click());
        importFile.addEventListener("change", () => {
          const f = importFile.files && importFile.files[0];
          if(f) importJSON(f);
          importFile.value = "";
        });

        // Tools screen buttons
        openImageToolBtn.addEventListener("click", () => setScreen("Tools"));
        openFilesToolBtn.addEventListener("click", () => setScreen("Tools"));
        openTemplatesToolBtn.addEventListener("click", () => setScreen("Tools"));

        // Image tool
        imgGenerateBtn.addEventListener("click", createMockImageJob);
        imgCancelBtn.addEventListener("click", cancelMockImageJob);

        // Files tool
        fileAddBtn.addEventListener("click", () => fileInput.click());
        fileClearBtn.addEventListener("click", () => {
          const ok = confirm("Clear the local file list?");
          if(!ok) return;
          files = [];
          saveFiles(files);
          renderFiles();
        });
        fileInput.addEventListener("change", () => {
          const list = Array.from(fileInput.files || []);
          if(!list.length) return;

          for(const f of list){
            files.push({ id: uid("f"), name: f.name, size: f.size, type: f.type || "file", ts: stamp() });
          }
          saveFiles(files);
          renderFiles();
          fileInput.value = "";
        });

        // Close menu if click outside
        window.addEventListener("click", (e) => {
          if(msgMenu.classList.contains("open")){
            const inside = msgMenu.contains(e.target);
            const clickedMore = (e.target && e.target.closest && e.target.closest(".miniAction"));
            if(!inside && !clickedMore) closeMsgMenu();
          }
        }, true);
      }

      // -------------------- Init / migrate --------------------
      function migrateEnsureDefaults(){
        // ensure default sessions exist
        const ids = new Set(state.sessions.map(s => s.id));
        const must = [
          { id:"biz_main", lane:"business", title:"Business ‚Äî Pricing & Ops", note:"COGS ‚Ä¢ margins ‚Ä¢ Amazon/Shopify ‚Ä¢ decision ledger", updated: stamp() },
          { id:"math107", lane:"school", title:"UMGC ‚Äî MATH 107", note:"Syllabus ‚Ä¢ homework help ‚Ä¢ study plan", updated: stamp() },
          { id:"hist125", lane:"school", title:"UMGC ‚Äî HIST 125", note:"Readings ‚Ä¢ discussions ‚Ä¢ drafts", updated: stamp() },
          { id:"life_main", lane:"personal", title:"Personal ‚Äî Life Admin", note:"Tasks ‚Ä¢ goals ‚Ä¢ notes", updated: stamp() },
        ];
        for(const m of must){
          if(!ids.has(m.id)) state.sessions.push(m);
        }

        // ensure active session IDs valid
        for(const lane of ["business","school","personal"]){
          const sid = state.activeSession[lane];
          const ok = sid && state.sessions.some(s => s.id === sid && s.lane === lane);
          if(!ok){
            const first = state.sessions.find(s => s.lane === lane);
            state.activeSession[lane] = first ? first.id : "";
          }
        }

        // ensure lane is valid
        if(!["business","school","personal"].includes(state.lane)) state.lane = "business";

        saveState();
      }

      function init(){
        migrateEnsureDefaults();
        updateTopBar();
        renderTemplates();
        renderTools();
        renderSessions();
        renderWorkspace();
        renderFeed();
        syncSendButton();
        wire();
      }

      try{
        if(document.readyState === "loading"){
          document.addEventListener("DOMContentLoaded", init, { once:true });
        } else {
          init();
        }
      } catch (e){
        showFatal(e);
      }
    })();
  </script>
</body>
</html>
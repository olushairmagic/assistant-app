<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>WilliamBot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest" />
  <meta name="theme-color" content="#0b0a08" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="WilliamBot" />

  <style>
    :root{
      --bg:#0b0a08;
      --bg2:#12100c;

      --cream:#f3efe6;
      --ink:#1b1813;

      --border: rgba(243,239,230,.14);
      --border2: rgba(243,239,230,.20);

      --accent:#7a1114;
      --accent2:#a0141a;
      --school:#1e40af;
      --school2:#2563eb;

      --green:#15803d;
      --amber:#b45309;
      --red:#b91c1c;

      --r:18px;
      --r2:14px;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --shadow2: 0 10px 30px rgba(0,0,0,.28);

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;

      /* spacing */
      --s1: 6px;
      --s2: 10px;
      --s3: 12px;
      --s4: 14px;
      --s5: 16px;

      /* motion: minimal by default */
      --tFast: 90ms;
      --tMed: 120ms;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; }
    body{
      font-family: var(--font);
      background:
        radial-gradient(900px 600px at 18% 10%, rgba(122,17,20,.20), transparent 55%),
        radial-gradient(800px 500px at 90% 28%, rgba(243,239,230,.10), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      color: var(--cream);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      overflow-x:hidden;
    }

    @media (prefers-reduced-motion: reduce){
      *{
        transition: none !important;
        animation: none !important;
        scroll-behavior: auto !important;
      }
    }

    .hidden { display:none !important; }
    .srOnly{
      position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0;
    }

    :focus-visible{
      outline: 3px solid rgba(243,239,230,.42);
      outline-offset: 2px;
      border-radius: 10px;
    }

    .wrap{
      height:100%;
      padding: var(--s3) var(--s3) calc(var(--s3) + env(safe-area-inset-bottom));
      display:flex;
      justify-content:center;
    }
    .app{
      width:100%;
      max-width: 1280px;
      height: 100%;
      display:grid;
      grid-template-columns: 300px 1fr 360px;
      grid-template-rows: auto 1fr;
      gap: var(--s3);
      min-width: 0;
    }

    header{
      grid-column: 1 / -1;
      border: 1px solid var(--border);
      background: rgba(20,17,13,.78);
      backdrop-filter: blur(10px);
      border-radius: var(--r);
      box-shadow: var(--shadow2);
      padding: var(--s3);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: var(--s3);
      min-width: 0;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: var(--s2);
      min-width: 0;
    }
    .logo{
      width: 38px;
      height: 38px;
      border-radius: 14px;
      display:grid;
      place-items:center;
      user-select:none;
      font-weight: 900;
      letter-spacing: .4px;
      color: var(--cream);
      border: 1px solid rgba(243,239,230,.16);
      background:
        radial-gradient(18px 18px at 30% 25%, rgba(243,239,230,.22), transparent 55%),
        linear-gradient(135deg, rgba(122,17,20,.75), rgba(122,17,20,.20));
      box-shadow: 0 10px 22px rgba(122,17,20,.18);
      flex: 0 0 auto;
    }
    .brandText{
      display:flex;
      flex-direction:column;
      line-height: 1.06;
      min-width: 0;
      gap: 6px;
    }
    .brandText strong{
      font-size: 15.5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .catRow{
      display:flex;
      align-items:center;
      gap: var(--s2);
      min-width: 0;
    }
    .catBadge{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 5px 9px;
      border-radius: 999px;
      border: 1px solid rgba(243,239,230,.14);
      font-size: 12px;
      color: rgba(243,239,230,.92);
      background: rgba(15,13,10,.35);
      white-space: nowrap;
      user-select:none;
      flex: 0 0 auto;
    }
    .catBadge .miniDot{
      width: 8px;
      height: 8px;
      border-radius: 50%;
      box-shadow: 0 0 0 3px rgba(0,0,0,.18);
      flex: 0 0 auto;
    }
    .catBadge.biz .miniDot{ background: var(--accent2); box-shadow: 0 0 0 3px rgba(122,17,20,.16); }
    .catBadge.school .miniDot{ background: var(--school2); box-shadow: 0 0 0 3px rgba(37,99,235,.16); }

    #topSub{
      font-size: 12px;
      color: rgba(243,239,230,.68);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 0;
      max-width: 64ch;
    }

    .statusRow{
      display:flex;
      align-items:center;
      gap: var(--s2);
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .badge{
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(20,17,13,.55);
      color: rgba(243,239,230,.82);
      font-size: 12px;
      user-select:none;
      white-space: nowrap;
      max-width: 100%;
      transition: background var(--tMed) ease, border-color var(--tMed) ease;
    }
    .badge.clickable{ cursor:pointer; }
    .badge:hover{
      border-color: var(--border2);
      background: rgba(20,17,13,.66);
    }
    .badge .label{
      color: rgba(243,239,230,.62);
      font-weight: 650;
    }

    .dot{
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: var(--amber);
      box-shadow: 0 0 0 4px rgba(180,83,9,.14);
      flex: 0 0 auto;
    }
    .dot.ok{ background: var(--green); box-shadow: 0 0 0 4px rgba(21,128,61,.14); }
    .dot.bad{ background: var(--red); box-shadow: 0 0 0 4px rgba(185,28,28,.16); }

    .ghostBtn{
      border: 1px solid var(--border);
      background: rgba(20,17,13,.45);
      color: rgba(243,239,230,.90);
      padding: 10px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 740;
      font-size: 13px;
      transition: background var(--tMed) ease, border-color var(--tMed) ease;
      user-select:none;
    }
    .ghostBtn:hover{
      border-color: var(--border2);
      background: rgba(20,17,13,.62);
    }

    .panel{
      border-radius: var(--r);
      border: 1px solid var(--border);
      background: rgba(20,17,13,.78);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 0;
      min-width: 0;
    }
    .panelHeader{
      padding: var(--s3);
      border-bottom: 1px solid rgba(243,239,230,.14);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: var(--s2);
    }
    .panelHeader strong{
      font-size: 13px;
      letter-spacing: .2px;
      color: rgba(243,239,230,.92);
    }
    .panelHeader small{
      display:block;
      font-size: 12px;
      color: rgba(243,239,230,.62);
      margin-top:4px;
    }
    .panelBody{
      padding: var(--s2);
      overflow:auto;
      min-height: 0;
    }

    .segRow{
      display:flex;
      gap:8px;
      margin-top:10px;
    }
    .seg{
      flex:1;
      padding: 10px 10px;
      border-radius: 999px;
      border: 1px solid rgba(243,239,230,.14);
      background: rgba(15,13,10,.35);
      color: rgba(243,239,230,.82);
      font-weight: 820;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
      text-align:center;
      transition: border-color var(--tMed) ease, background var(--tMed) ease;
      white-space: nowrap;
    }
    .seg.active{
      border-color: rgba(122,17,20,.45);
      background: rgba(122,17,20,.18);
      color: rgba(243,239,230,.92);
      box-shadow: 0 0 0 4px rgba(122,17,20,.10) inset;
    }
    .seg.schoolActive{
      border-color: rgba(37,99,235,.45);
      background: rgba(37,99,235,.16);
      box-shadow: 0 0 0 4px rgba(37,99,235,.10) inset;
    }

    .list{ display:flex; flex-direction:column; gap: 8px; margin-top:10px; }
    .item{
      border: 1px solid rgba(243,239,230,.14);
      background: rgba(15,13,10,.35);
      border-radius: 14px;
      padding: 10px;
      cursor:pointer;
      transition: border-color var(--tMed) ease, background var(--tMed) ease;
    }
    .item:hover{
      border-color: rgba(243,239,230,.22);
      background: rgba(15,13,10,.48);
    }
    .item.active{
      border-color: rgba(243,239,230,.26);
      background: rgba(243,239,230,.06);
      box-shadow: 0 0 0 3px rgba(243,239,230,.06) inset;
    }
    .itemTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .itemTitle{
      font-weight: 850;
      font-size: 13px;
      color: rgba(243,239,230,.92);
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      min-width:0;
    }
    .pillMini{
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(243,239,230,.14);
      color: rgba(243,239,230,.72);
      background: rgba(15,13,10,.35);
      flex: 0 0 auto;
      user-select:none;
    }
    .itemMeta{
      font-size: 12px;
      color: rgba(243,239,230,.62);
      margin-top: 6px;
      line-height: 1.25;
    }
    .rowBtns{
      display:flex;
      gap:8px;
      margin-top:10px;
      flex-wrap: wrap;
    }

    .chat{
      border-radius: var(--r);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 0;
      min-width: 0;
    }
    .chat.bizBg{
      background:
        radial-gradient(900px 600px at 30% 0%, rgba(122,17,20,.10), transparent 55%),
        linear-gradient(180deg, rgba(243,239,230,.08), rgba(243,239,230,.04));
    }
    .chat.schoolBg{
      background:
        radial-gradient(900px 600px at 30% 0%, rgba(37,99,235,.10), transparent 55%),
        linear-gradient(180deg, rgba(243,239,230,.08), rgba(243,239,230,.04));
    }

    .feed{
      flex:1;
      overflow:auto;
      padding: 14px 12px;
      background:
        radial-gradient(900px 600px at 25% 20%, rgba(243,239,230,.12), transparent 55%),
        linear-gradient(180deg, rgba(243,239,230,.10), rgba(243,239,230,.06));
      min-height: 0;
      scroll-behavior: smooth;
    }

    .row{ display:flex; margin: 10px 0; gap: 10px; }
    .row.you{ justify-content:flex-end; }
    .row.bot{ justify-content:flex-start; }

    .bubbleWrap{
      display:flex;
      flex-direction:column;
      gap: 6px;
      max-width: min(92ch, 96%);
      min-width: 0;
    }
    .bubble{
      padding: 12px 12px;
      border-radius: var(--r2);
      border: 1px solid rgba(21,18,13,.14);
      background: rgba(243,239,230,.92);
      color: var(--ink);
      box-shadow: 0 8px 20px rgba(0,0,0,.10);
      white-space: pre-wrap;
      word-wrap: break-word;
      line-height: 1.42;
      font-size: 14.6px;
      position: relative;
      min-width: 0;
    }
    .you .bubble{
      border-color: rgba(122,17,20,.25);
      box-shadow:
        0 10px 24px rgba(122,17,20,.10),
        0 0 0 1px rgba(122,17,20,.08) inset;
      padding-left: 14px;
    }
    .you .bubble:before{
      content:"";
      position:absolute;
      left: 0;
      top: 10px;
      bottom: 10px;
      width: 3px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(122,17,20,.85), rgba(122,17,20,.20));
      opacity:.9;
    }

    .meta{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size: 11px;
      color: rgba(21,18,13,.62);
      padding: 0 2px;
      align-items:center;
    }
    .confidence{ display:flex; align-items:center; gap: 6px; user-select:none; }
    .confDot{
      width: 8px; height: 8px; border-radius: 50%;
      background: #9ca3af;
      box-shadow: 0 0 0 3px rgba(156,163,175,.18);
    }
    .confDot.g{ background: var(--green); box-shadow: 0 0 0 3px rgba(21,128,61,.14); }
    .confDot.y{ background: var(--amber); box-shadow: 0 0 0 3px rgba(180,83,9,.14); }
    .confDot.r{ background: var(--red); box-shadow: 0 0 0 3px rgba(185,28,28,.14); }

    .composer{
      padding: var(--s3);
      border-top: 1px solid rgba(243,239,230,.14);
      background: rgba(20,17,13,.52);
      display:flex;
      flex-direction:column;
      gap: var(--s2);
    }
    .composerRow{
      display:flex;
      gap: var(--s2);
      align-items:flex-end;
    }

    textarea{
      flex:1;
      resize:none;
      min-height: 48px;
      max-height: 220px;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(243,239,230,.16);
      background: rgba(11,10,8,.55);
      color: rgba(243,239,230,.92);
      font-size: 14.6px;
      outline:none;
    }
    textarea::placeholder{ color: rgba(243,239,230,.55); }
    textarea:focus{
      border-color: rgba(122,17,20,.40);
      box-shadow: 0 0 0 5px rgba(122,17,20,.16);
    }

    .warn{
      display:none;
      border: 1px solid rgba(180,83,9,.35);
      background: rgba(180,83,9,.10);
      color: rgba(243,239,230,.92);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 12.5px;
      line-height: 1.35;
    }
    .warn strong{ color: rgba(243,239,230,.95); }

    .send{
      min-width: 96px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(122,17,20,.45);
      background: linear-gradient(180deg, rgba(122,17,20,.32), rgba(122,17,20,.18));
      color: rgba(243,239,230,.95);
      font-weight: 850;
      cursor: pointer;
      box-shadow: 0 10px 26px rgba(122,17,20,.16);
      transition: filter var(--tFast) ease;
    }
    .send:hover{ filter: brightness(1.06); }
    .send:disabled{
      opacity: .55;
      cursor: not-allowed;
      box-shadow: none;
      filter: none;
    }

    .section{
      border: 1px solid rgba(243,239,230,.14);
      background: rgba(15,13,10,.35);
      border-radius: 14px;
      padding: 10px;
    }
    .section + .section{ margin-top: 10px; }

    .sectionTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 8px;
    }
    .sectionTitle strong{
      font-size: 12.5px;
      color: rgba(243,239,230,.90);
      letter-spacing: .2px;
    }
    .sectionTitle span{
      font-size: 12px;
      color: rgba(243,239,230,.62);
    }

    .kv{ display:flex; flex-direction:column; gap: 8px; }
    .kvRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      padding-top: 6px;
      border-top: 1px dashed rgba(243,239,230,.12);
    }
    .kvRow:first-child{ border-top:none; padding-top:0; }
    .kvKey{
      font-size: 12px;
      color: rgba(243,239,230,.78);
      line-height: 1.25;
      display:flex;
      gap:8px;
      align-items:flex-start;
    }
    .kvVal{
      font-size: 12px;
      color: rgba(243,239,230,.92);
      font-weight: 780;
      text-align:right;
      line-height: 1.25;
      white-space: nowrap;
    }
    .kvSub{
      font-size: 11px;
      color: rgba(243,239,230,.62);
      margin-top: 2px;
    }

    .fileChip{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(243,239,230,.14);
      background: rgba(15,13,10,.30);
      color: rgba(243,239,230,.80);
      font-size: 12px;
    }
    .fileChip small{ color: rgba(243,239,230,.60); }

    .miniBtn{
      border-radius: 999px;
      padding: 7px 10px;
      border: 1px solid rgba(243,239,230,.14);
      background: rgba(20,17,13,.45);
      color: rgba(243,239,230,.90);
      font-weight: 820;
      cursor:pointer;
      user-select:none;
      font-size: 12px;
      transition: background var(--tMed) ease, border-color var(--tMed) ease;
      white-space: nowrap;
    }
    .miniBtn:hover{ border-color: rgba(243,239,230,.22); background: rgba(20,17,13,.62); }
    .miniBtn.danger{
      border-color: rgba(185,28,28,.35);
      background: rgba(185,28,28,.12);
    }
    .miniBtn.danger:hover{
      border-color: rgba(185,28,28,.55);
      background: rgba(185,28,28,.18);
    }

    .fatal{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      background: rgba(0,0,0,.78);
      z-index: 9999;
    }
    .fatalCard{
      width: min(860px, 100%);
      border-radius: 20px;
      border: 1px solid rgba(243,239,230,.18);
      background: rgba(20,17,13,.92);
      box-shadow: 0 22px 80px rgba(0,0,0,.55);
      padding: 14px;
      color: rgba(243,239,230,.90);
    }
    .fatalCard strong{ font-size: 13px; }
    .fatalCard pre{
      margin: 10px 0 0;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(243,239,230,.14);
      background: rgba(11,10,8,.55);
      overflow:auto;
      max-height: 45vh;
      color: rgba(243,239,230,.86);
      font-size: 12px;
      line-height: 1.35;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .drawerBackdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.58);
      display:none;
      z-index: 9000;
    }
    .drawer{
      position: fixed;
      top: 0;
      bottom: 0;
      width: min(92vw, 420px);
      background: rgba(20,17,13,.92);
      border-right: 1px solid rgba(243,239,230,.14);
      box-shadow: 0 22px 80px rgba(0,0,0,.55);
      transform: translateX(-110%);
      transition: transform var(--tMed) ease;
      z-index: 9100;
      padding: 12px;
      overflow:auto;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
    }
    .drawer.right{
      right: 0;
      left: auto;
      border-right: none;
      border-left: 1px solid rgba(243,239,230,.14);
      transform: translateX(110%);
    }
    .drawer.open{ transform: translateX(0); }
    .drawerBackdrop.open{ display:block; }

    @media (max-width: 1080px){
      .app{ grid-template-columns: 300px 1fr; }
      #workspacePanel{ display:none; }
    }
    @media (max-width: 760px){
      .app{ grid-template-columns: 1fr; }
      #leftPanel{ display:none; }
      #workspacePanel{ display:none; }
      header{
        padding: 10px;
        gap: 10px;
      }
      #topSub{ max-width: 42ch; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="app">

      <!-- TOP -->
      <header>
        <div class="brand">
          <div class="logo" aria-hidden="true">W</div>
          <div class="brandText">
            <div class="catRow">
              <strong>WilliamBot</strong>
              <span class="catBadge biz" id="catBadge" aria-label="Active category">
                <span class="miniDot" aria-hidden="true"></span>
                <span id="catText">Business</span>
              </span>
            </div>
            <span id="topSub">Session: —</span>
          </div>
        </div>

        <div class="statusRow" aria-label="Status">
          <div class="badge clickable" id="profileBadge" title="Profile is stored per session" role="button" tabindex="0">
            <span class="label">Profile</span>
            <span id="profileText">Study</span>
          </div>

          <div class="badge clickable" id="notionBadge" title="Notion sync placeholder (wire later)" role="button" tabindex="0">
            <span id="notionDot" class="dot bad" aria-hidden="true"></span>
            <span class="label">Notion</span>
            <span id="notionText">Not connected</span>
          </div>

          <div class="badge" title="Local backend connection">
            <span id="engineDot" class="dot bad" aria-hidden="true"></span>
            <span class="label">Engine</span>
            <span id="engineText">UI only</span>
          </div>

          <button class="ghostBtn" id="openSessions" aria-haspopup="dialog">Sessions</button>
          <button class="ghostBtn" id="openWorkspace" aria-haspopup="dialog">Workspace</button>
        </div>
      </header>

      <!-- LEFT: SESSIONS -->
      <aside class="panel" id="leftPanel" aria-label="Sessions panel">
        <div class="panelHeader">
          <div>
            <strong>Sessions</strong>
            <small><span id="sessionCount">0</span> total • <span id="activeLabel">Active: —</span></small>

            <div class="segRow" role="tablist" aria-label="Session groups">
              <button class="seg active" id="tabBiz" role="tab" aria-selected="true">Business</button>
              <button class="seg" id="tabSchool" role="tab" aria-selected="false">School</button>
            </div>
          </div>

          <div style="display:flex; gap:8px; align-items:center;">
            <button class="miniBtn" id="newSessionBtn" title="Create a new session">New</button>
          </div>
        </div>

        <div class="panelBody">
          <div class="list" id="sessionList"></div>
        </div>
      </aside>

      <!-- CENTER: CHAT -->
      <main class="chat bizBg" id="chatShell" aria-label="Chat">
        <div class="feed" id="feed" aria-live="polite" aria-relevant="additions text"></div>

        <div class="composer">
          <div class="warn" id="contextWarn"></div>
          <div class="composerRow">
            <label class="srOnly" for="input">Message</label>
            <textarea id="input" placeholder="Ask, calculate, study… (Enter to send, Shift+Enter new line)"></textarea>
            <button class="send" id="sendBtn" disabled>Send</button>
          </div>
        </div>
      </main>

      <!-- RIGHT: WORKSPACE -->
      <aside class="panel" id="workspacePanel" aria-label="Workspace panel">
        <div class="panelHeader">
          <div>
            <strong>Workspace</strong>
            <small id="wsSubtitle">Session-bound state</small>
          </div>
          <span id="wsHint" style="font-size:12px; color: rgba(243,239,230,.62);">—</span>
        </div>
        <div class="panelBody" id="workspaceBody"></div>
      </aside>

    </div>
  </div>

  <!-- Mobile drawers -->
  <div class="drawerBackdrop" id="drawerBackdrop"></div>

  <div class="drawer" id="sessionsDrawer" aria-hidden="true" role="dialog" aria-label="Sessions drawer">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <strong>Sessions</strong>
      <button class="miniBtn" id="closeSessionsDrawer">Close</button>
    </div>

    <div class="segRow" style="margin-top:12px;">
      <button class="seg active" id="drawerTabBiz">Business</button>
      <button class="seg" id="drawerTabSchool">School</button>
    </div>

    <div class="rowBtns" style="margin-top:10px;">
      <button class="miniBtn" id="drawerNewSession">New session</button>
    </div>

    <div class="list" id="drawerSessionList" style="margin-top:12px;"></div>
  </div>

  <div class="drawer right" id="workspaceDrawer" aria-hidden="true" role="dialog" aria-label="Workspace drawer">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <strong>Workspace</strong>
      <button class="miniBtn" id="closeWorkspaceDrawer">Close</button>
    </div>
    <div id="drawerWorkspaceBody" style="margin-top:12px;"></div>
  </div>

  <!-- Fatal overlay -->
  <div class="fatal" id="fatal">
    <div class="fatalCard" role="dialog" aria-label="Crash report">
      <strong>WilliamBot UI crashed (no silent white screen).</strong>
      <div style="margin-top:6px; color: rgba(243,239,230,.75); font-size:12px;">
        Copy the error, refresh, and you’re back.
      </div>
      <pre id="fatalText"></pre>
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:10px;">
        <button class="miniBtn" id="fatalCopy">Copy error</button>
        <button class="miniBtn" id="fatalClose">Close</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      "use strict";

      // -------------------- Crash safety --------------------
      const fatalEl = document.getElementById("fatal");
      const fatalText = document.getElementById("fatalText");
      const fatalCopy = document.getElementById("fatalCopy");
      const fatalClose = document.getElementById("fatalClose");

      function showFatal(err){
        try{
          const msg = (err && err.stack) ? err.stack : String(err);
          fatalText.textContent = msg;
          fatalEl.style.display = "flex";
        } catch {}
      }
      window.addEventListener("error", (e) => showFatal(e.error || e.message || e), true);
      window.addEventListener("unhandledrejection", (e) => showFatal(e.reason || e), true);

      fatalCopy.addEventListener("click", async () => {
        try{ await navigator.clipboard.writeText(fatalText.textContent || ""); } catch {}
      });
      fatalClose.addEventListener("click", () => { fatalEl.style.display = "none"; });

      // -------------------- DOM helpers --------------------
      const $ = (id) => document.getElementById(id);

      const escapeHtml = (s) =>
        String(s).replace(/[&<>"']/g, c => ({
          "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
        }[c]));

      function stamp(){
        const d = new Date();
        return d.toLocaleString([], {month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit"});
      }
      function nowTime(){
        const d = new Date();
        return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
      }
      function uid(){
        return Math.random().toString(36).slice(2, 8) + "_" + Date.now().toString(36).slice(-4);
      }
      function setDot(el, state){
        el.classList.remove("ok","bad");
        if(state === "ok") el.classList.add("ok");
        if(state === "bad") el.classList.add("bad");
      }
      function safeParse(json, fallback){
        try { return JSON.parse(json); } catch { return fallback; }
      }

      // -------------------- Router --------------------
      // Supported:
      //   #/biz
      //   #/school
      //   #/biz/session/<id>
      //   #/school/session/<id>
      function parseHash(){
        const raw = (location.hash || "").replace(/^#/, "");
        const parts = raw.split("/").filter(Boolean);
        if(parts.length === 0) return { group: null, sessionId: null };

        const group = (parts[0] === "biz") ? "business" : (parts[0] === "school") ? "school" : null;
        if(!group) return { group: null, sessionId: null };

        if(parts[1] === "session" && parts[2]) return { group, sessionId: parts[2] };
        return { group, sessionId: null };
      }

      function setHashForGroup(group){
        const g = (group === "business") ? "biz" : "school";
        if(location.hash !== "#/" + g) location.hash = "#/" + g;
      }

      function setHashForSession(group, sid){
        const g = (group === "business") ? "biz" : "school";
        location.hash = "#/" + g + "/session/" + encodeURIComponent(sid);
      }

      // -------------------- Storage --------------------
      const STORE = {
        sessions: "wb_sessions_v7",

        // NEW: group-scoped keys
        historyPrefixBiz: "wb_history_v7_biz_",
        historyPrefixSchool: "wb_history_v7_school_",
        profilePrefixBiz: "wb_profile_v7_biz_",
        profilePrefixSchool: "wb_profile_v7_school_",

        // Old v7 keys (ungrouped) — migrate if present
        legacyHistoryPrefix: "wb_history_v7_",
        legacyProfilePrefix: "wb_profile_v7_",

        activeGroup: "wb_active_group_v7",
        activeBiz: "wb_active_session_business_v7",
        activeSchool: "wb_active_session_school_v7"
      };

      function historyKey(group, sid){
        const p = (group === "business") ? STORE.historyPrefixBiz : STORE.historyPrefixSchool;
        return p + sid;
      }
      function legacyHistoryKey(sid){
        return STORE.legacyHistoryPrefix + sid;
      }
      function profileKey(group, sid){
        const p = (group === "business") ? STORE.profilePrefixBiz : STORE.profilePrefixSchool;
        return p + sid;
      }
      function legacyProfileKey(sid){
        return STORE.legacyProfilePrefix + sid;
      }

      // -------------------- Default sessions --------------------
      function defaultSessions(){
        return [
          {
            id: "biz_main",
            group: "business",
            title: "Business — Pricing & Ops",
            note: "COGS • margins • Amazon/Shopify • decision ledger",
            updated: stamp(),
            files: [
              { name: "Products & SKUs (local)", desc: "Later: Notion + invoices + COGS tables" },
              { name: "Pricing guardrails (local)", desc: "Margin floors • fees • shipping • overhead" }
            ]
          },
          {
            id: "school_math107",
            group: "school",
            title: "UMGC — MATH 107 (College Algebra)",
            note: "Syllabus PDF • homework help • study plan",
            updated: stamp(),
            files: [{ name: "MATH_107_...Spring_2026.pdf", desc: "Syllabus (uploaded)" }]
          },
          {
            id: "school_hist125",
            group: "school",
            title: "UMGC — HIST 125 (Technological Transformations)",
            note: "Syllabus PDF • readings • discussion prep",
            updated: stamp(),
            files: [{ name: "HIST_125_...Spring_2026.pdf", desc: "Syllabus (uploaded)" }]
          }
        ];
      }

      function loadSessions(){
        const raw = localStorage.getItem(STORE.sessions);
        const parsed = safeParse(raw, null);
        if(Array.isArray(parsed) && parsed.length) return parsed;

        const s = defaultSessions();
        localStorage.setItem(STORE.sessions, JSON.stringify(s));
        return s;
      }

      function saveSessions(sessions){
        localStorage.setItem(STORE.sessions, JSON.stringify(sessions));
      }

      function loadHistory(session){
        const k = historyKey(session.group, session.id);
        const raw = localStorage.getItem(k);
        const parsed = safeParse(raw, null);
        if(Array.isArray(parsed)) return parsed;

        // Auto-migrate from old ungrouped key if present
        const legacy = safeParse(localStorage.getItem(legacyHistoryKey(session.id)), null);
        if(Array.isArray(legacy)){
          localStorage.setItem(k, JSON.stringify(legacy));
          try { localStorage.removeItem(legacyHistoryKey(session.id)); } catch {}
          return legacy;
        }
        return [];
      }

      function saveHistory(session, hist){
        localStorage.setItem(historyKey(session.group, session.id), JSON.stringify(hist.slice(-600)));
      }

      const PROFILE_BUS = ["Financial", "Ops", "Strategy", "Formulation", "Compliance"];
      const PROFILE_SCHOOL = ["Study", "Writing", "Math", "Research"];

      function profileListForSession(session){
        return (session.group === "business") ? PROFILE_BUS : PROFILE_SCHOOL;
      }

      function getProfileForSession(session){
        const k = profileKey(session.group, session.id);
        const stored = localStorage.getItem(k);
        const list = profileListForSession(session);
        if(stored && list.includes(stored)) return stored;

        // Migrate old ungrouped profile key if present
        const legacy = localStorage.getItem(legacyProfileKey(session.id));
        if(legacy && list.includes(legacy)){
          localStorage.setItem(k, legacy);
          try { localStorage.removeItem(legacyProfileKey(session.id)); } catch {}
          return legacy;
        }

        return (session.group === "business") ? "Financial" : "Study";
      }

      function setProfileForSession(session, profile){
        localStorage.setItem(profileKey(session.group, session.id), profile);
        $("profileText").textContent = profile;
      }

      function cycleProfileForSession(session){
        const list = profileListForSession(session);
        const cur = getProfileForSession(session);
        const idx = Math.max(0, list.indexOf(cur));
        const next = list[(idx + 1) % list.length];
        setProfileForSession(session, next);
      }

      // -------------------- Group + active session tracking --------------------
      function getActiveGroup(){
        return localStorage.getItem(STORE.activeGroup) || "business";
      }
      function setActiveGroup(g){
        localStorage.setItem(STORE.activeGroup, g);
      }
      function getActiveSessionIdForGroup(group){
        const key = (group === "business") ? STORE.activeBiz : STORE.activeSchool;
        return localStorage.getItem(key) || "";
      }
      function setActiveSessionIdForGroup(group, id){
        const key = (group === "business") ? STORE.activeBiz : STORE.activeSchool;
        localStorage.setItem(key, id);
      }

      // -------------------- UI elements --------------------
      const feed = $("feed");
      const input = $("input");
      const sendBtn = $("sendBtn");
      const topSub = $("topSub");
      const sessionCount = $("sessionCount");
      const activeLabel = $("activeLabel");

      const sessionList = $("sessionList");

      const tabBiz = $("tabBiz");
      const tabSchool = $("tabSchool");
      const drawerTabBiz = $("drawerTabBiz");
      const drawerTabSchool = $("drawerTabSchool");

      const backdrop = $("drawerBackdrop");
      const sessionsDrawer = $("sessionsDrawer");
      const workspaceDrawer = $("workspaceDrawer");
      const drawerSessionList = $("drawerSessionList");
      const drawerWorkspaceBody = $("drawerWorkspaceBody");

      const wsHint = $("wsHint");
      const wsSubtitle = $("wsSubtitle");
      const workspaceBody = $("workspaceBody");

      const notionDot = $("notionDot");
      const engineDot = $("engineDot");

      const catBadge = $("catBadge");
      const catText = $("catText");
      const chatShell = $("chatShell");

      const contextWarn = $("contextWarn");

      // -------------------- State --------------------
      let sessions = loadSessions();
      saveSessions(sessions);

      let history = [];

      function sessionsByGroup(group){
        return sessions.filter(s => s.group === group);
      }
      function firstSessionId(group){
        const list = sessionsByGroup(group);
        return list.length ? list[0].id : "";
      }

      function currentSession(){
        const r = parseHash();
        const group = r.group || getActiveGroup();
        const sidFromHash = r.sessionId ? decodeURIComponent(r.sessionId) : null;

        const sid = sidFromHash || getActiveSessionIdForGroup(group) || "";
        return sessions.find(s => s.id === sid && s.group === group) || null;
      }

      function setCategoryUI(group){
        catBadge.classList.toggle("biz", group === "business");
        catBadge.classList.toggle("school", group === "school");
        catText.textContent = (group === "business") ? "Business" : "School";

        chatShell.classList.toggle("bizBg", group === "business");
        chatShell.classList.toggle("schoolBg", group === "school");
      }

      function setTopSubText(){
        const s = currentSession();
        topSub.textContent = "Session: " + (s ? s.title : "—");
      }

      function setTabsUI(group){
        tabBiz.classList.toggle("active", group === "business");
        tabSchool.classList.toggle("active", group === "school");
        tabBiz.setAttribute("aria-selected", group === "business" ? "true" : "false");
        tabSchool.setAttribute("aria-selected", group === "school" ? "true" : "false");

        tabBiz.classList.remove("schoolActive");
        tabSchool.classList.remove("schoolActive");
        if(group === "school") tabSchool.classList.add("schoolActive");

        drawerTabBiz.classList.toggle("active", group === "business");
        drawerTabSchool.classList.toggle("active", group === "school");
        drawerTabBiz.classList.remove("schoolActive");
        drawerTabSchool.classList.remove("schoolActive");
        if(group === "school") drawerTabSchool.classList.add("schoolActive");
      }

      function sessionPillText(s){
        const cs = currentSession();
        const active = cs && s.id === cs.id;
        if(active) return "Active";
        return (s.group === "school") ? "Class" : "Business";
      }

      function renderSessionListInto(el, group){
        el.innerHTML = "";
        const filtered = sessionsByGroup(group);
        const cs = currentSession();

        if(filtered.length === 0){
          const empty = document.createElement("div");
          empty.style.color = "rgba(243,239,230,.62)";
          empty.style.fontSize = "12px";
          empty.textContent = "No sessions yet.";
          el.appendChild(empty);
          return;
        }

        for(const s of filtered){
          const div = document.createElement("div");
          div.className = "item" + ((cs && s.id === cs.id) ? " active" : "");
          div.innerHTML = `
            <div class="itemTop">
              <div class="itemTitle">${escapeHtml(s.title)}</div>
              <span class="pillMini">${escapeHtml(sessionPillText(s))}</span>
            </div>
            <div class="itemMeta">
              ${escapeHtml(s.note || "")}<br/>
              <span style="color: rgba(243,239,230,.58)">Updated: ${escapeHtml(s.updated || "—")}</span>
            </div>

            <div class="rowBtns">
              <button class="miniBtn" data-act="activate" data-id="${escapeHtml(s.id)}">Open</button>
              <button class="miniBtn" data-act="rename" data-id="${escapeHtml(s.id)}">Rename</button>
              <button class="miniBtn danger" data-act="delete" data-id="${escapeHtml(s.id)}">Delete</button>
            </div>
          `;
          el.appendChild(div);
        }
      }

      function renderSessions(){
        const r = parseHash();
        const group = r.group || getActiveGroup();

        setTabsUI(group);
        setCategoryUI(group);

        sessionCount.textContent = String(sessions.length);

        const cs = currentSession();
        activeLabel.textContent = cs ? cs.title : "—";

        renderSessionListInto(sessionList, group);
        renderSessionListInto(drawerSessionList, group);

        setTopSubText();

        if(cs) $("profileText").textContent = getProfileForSession(cs);
      }

      // -------------------- Activation + navigation --------------------
      function ensureGroupHasActive(group){
        const cur = getActiveSessionIdForGroup(group);
        const ok = cur && sessions.some(s => s.id === cur && s.group === group);
        if(!ok){
          const pick = firstSessionId(group);
          if(pick) setActiveSessionIdForGroup(group, pick);
        }
      }

      function activateGroup(group){
        setActiveGroup(group);
        ensureGroupHasActive(group);

        // route drives everything
        setHashForGroup(group);
      }

      function activateSessionById(group, id, opts){
        opts = opts || {};
        const s = sessions.find(x => x.id === id && x.group === group);
        if(!s) return;

        setActiveGroup(group);
        setActiveSessionIdForGroup(group, id);

        // route to session
        setHashForSession(group, id);

        if(!opts.keepDrawersOpen) closeDrawer("sessions");
      }

      // When hash changes, we hydrate state from it (single source of truth)
      function handleRoute(){
        const r = parseHash();
        const group = r.group || getActiveGroup();
        setActiveGroup(group);
        ensureGroupHasActive(group);

        if(r.sessionId){
          const sid = decodeURIComponent(r.sessionId);
          if(sessions.some(s => s.id === sid && s.group === group)){
            setActiveSessionIdForGroup(group, sid);
          } else {
            // fallback to group home if invalid session
            setHashForGroup(group);
            return;
          }
        }

        loadThread();
        hydrateWorkspace();
        renderSessions();
        syncSendButton();
      }

      // -------------------- CRUD sessions --------------------
      function createSession(group){
        const isBiz = group === "business";
        const newId = (isBiz ? "biz_" : "school_") + uid();

        const title = isBiz ? "Business — New Session" : "UMGC — New Class Session";
        const note  = isBiz ? "Pricing • ops • planning" : "Study plan • assignments • notes";

        const sess = { id: newId, group, title, note, updated: stamp(), files: [] };

        sessions = [sess, ...sessions];
        saveSessions(sessions);

        // intro + profile (group-scoped keys)
        saveHistory(sess, [introForSession(sess)]);
        localStorage.setItem(profileKey(sess.group, sess.id), isBiz ? "Financial" : "Study");

        activateSessionById(group, newId);
      }

      function renameSession(id){
        const s = sessions.find(x => x.id === id);
        if(!s) return;

        const next = prompt("Rename session:", s.title);
        if(!next) return;

        s.title = next.trim().slice(0, 90) || s.title;
        s.updated = stamp();
        saveSessions(sessions);

        renderSessions();
        hydrateWorkspace();
      }

      function deleteSession(id){
        const s = sessions.find(x => x.id === id);
        if(!s) return;

        const protectedIds = new Set(["biz_main","school_math107","school_hist125"]);
        if(protectedIds.has(id)){
          alert("That session is protected (default). Create new ones and delete those instead.");
          return;
        }

        const ok = confirm("Delete this session? This removes its chat history from this browser.");
        if(!ok) return;

        const group = s.group;
        sessions = sessions.filter(x => x.id !== id);
        saveSessions(sessions);

        try{ localStorage.removeItem(historyKey(group, id)); } catch {}
        try{ localStorage.removeItem(profileKey(group, id)); } catch {}

        const activeInGroup = getActiveSessionIdForGroup(group);
        if(activeInGroup === id){
          const fallback = firstSessionId(group);
          if(fallback){
            setActiveSessionIdForGroup(group, fallback);
            setHashForSession(group, fallback);
          } else {
            setHashForGroup(group);
          }
        } else {
          renderSessions();
        }
      }

      // -------------------- Chat --------------------
      function renderMessage(m){
        const row = document.createElement("div");
        row.className = "row " + (m.role === "you" ? "you" : "bot");

        const wrap = document.createElement("div");
        wrap.className = "bubbleWrap";

        const bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.textContent = m.content || "";

        const meta = document.createElement("div");
        meta.className = "meta";

        const who = document.createElement("span");
        who.textContent = m.role === "you" ? "You" : "WilliamBot";

        const conf = document.createElement("span");
        conf.className = "confidence";

        const dot = document.createElement("span");
        dot.className = "confDot " + (m.confidence || "y");

        const label = document.createElement("span");
        label.textContent = (m.confidence === "g") ? "High" : (m.confidence === "r") ? "Low" : "Medium";

        const time = document.createElement("span");
        time.style.opacity = ".65";
        time.textContent = "• " + (m.ts || nowTime());

        conf.appendChild(dot);
        conf.appendChild(label);
        conf.appendChild(time);

        meta.appendChild(who);
        meta.appendChild(conf);

        wrap.appendChild(bubble);
        wrap.appendChild(meta);

        row.appendChild(wrap);
        feed.appendChild(row);

        feed.scrollTop = feed.scrollHeight;
      }

      function introForSession(session){
        if(session.group === "business"){
          return {
            role:"bot",
            confidence:"y",
            ts: nowTime(),
            content:
`Business session loaded.

When backend connects:
• COGS-aware pricing & margin math
• Channel fees (Amazon/Shopify) + shipping + overhead allocation
• Decision ledger for traceable pricing changes
• RAG for product specs, invoices, policies

Try:
- "Build pricing guardrails"
- "List inputs needed to lock MSRP"
- "Create a decision ledger template"`
          };
        }
        return {
          role:"bot",
          confidence:"y",
          ts: nowTime(),
          content:
`Class session loaded.

When backend connects:
• Read syllabus PDF and extract deadlines + grading
• Build weekly plan + checklists
• Explain concepts and help structure drafts

Try:
- "Summarize grading breakdown"
- "Extract deadlines into a checklist"
- "Explain this topic like I'm new"`
        };
      }

      function loadThread(){
        const cs = currentSession();
        feed.innerHTML = "";
        contextWarn.style.display = "none";
        contextWarn.textContent = "";

        if(!cs){
          loadThreadEmpty(parseHash().group || getActiveGroup());
          return;
        }

        history = loadHistory(cs);
        if(history.length === 0){
          const intro = introForSession(cs);
          history.push(intro);
          saveHistory(cs, history);
        }

        for(const m of history) renderMessage(m);
      }

      function loadThreadEmpty(group){
        feed.innerHTML = "";
        contextWarn.style.display = "none";
        contextWarn.textContent = "";

        const msg = {
          role:"bot",
          confidence:"y",
          ts: nowTime(),
          content:
(group === "business")
? "No Business sessions exist yet. Tap **New** to create one."
: "No School sessions exist yet. Tap **New session** to create one."
        };
        renderMessage(msg);
        history = [];
      }

      function addToHistory(m){
        const cs = currentSession();
        if(!cs) return;
        history.push(m);
        saveHistory(cs, history);
      }

      function syncSendButton(){
        sendBtn.disabled = input.value.trim().length === 0 || !currentSession();
      }

      function autoSizeTextarea(){
        input.style.height = "auto";
        input.style.height = Math.min(input.scrollHeight, 220) + "px";
      }

      // -------------------- Context safeguards --------------------
      const SCHOOL_HINTS = ["syllabus","assignment","homework","quiz","discussion post","apa","citation","umgc","grade","module","week"];
      const BIZ_HINTS = ["cogs","margin","msrp","sku","shopify","amazon","fba","fbm","overhead","fees","pricing","profit","inventory","supplier"];

      function maybeWarnAboutContext(text){
        const cs = currentSession();
        if(!cs) return;

        const t = String(text || "").toLowerCase();
        const looksSchool = SCHOOL_HINTS.some(k => t.includes(k));
        const looksBiz = BIZ_HINTS.some(k => t.includes(k));

        if(cs.group === "business" && looksSchool && !looksBiz){
          contextWarn.innerHTML = `<strong>Context check:</strong> This looks like School content, but you’re in a Business session. Switch tabs if that’s accidental.`;
          contextWarn.style.display = "block";
          return;
        }

        if(cs.group === "school" && looksBiz && !looksSchool){
          contextWarn.innerHTML = `<strong>Context check:</strong> This looks like Business content, but you’re in a School session. Switch tabs if that’s accidental.`;
          contextWarn.style.display = "block";
          return;
        }

        contextWarn.style.display = "none";
        contextWarn.textContent = "";
      }

      function sendMessage(){
        const cs = currentSession();
        if(!cs) return;

        const text = input.value.trim();
        if(!text) return;

        maybeWarnAboutContext(text);

        input.value = "";
        autoSizeTextarea();
        syncSendButton();

        const youMsg = { role:"you", confidence:"g", ts: nowTime(), content: text };
        renderMessage(youMsg);
        addToHistory(youMsg);

        cs.updated = stamp();
        saveSessions(sessions);
        renderSessions();

        let reply;
        if(cs.group === "business"){
          reply =
`UI-only mode (backend not connected).

When backend is live, I will:
• compute margins step-by-step
• use your real COGS/fees/shipping
• store decisions in a ledger

Pick next:
1) MSRP guardrails
2) MSRP inputs list
3) Decision ledger format`;
        } else {
          reply =
`UI-only mode (backend not connected).

When backend is live, I will:
• parse the syllabus PDF
• extract deadlines + grading
• build a weekly plan

Pick next:
1) Weekly plan
2) Deadlines checklist
3) Concept help`;
        }

        const botMsg = { role:"bot", confidence:"y", ts: nowTime(), content: reply };
        renderMessage(botMsg);
        addToHistory(botMsg);
      }

      // -------------------- Workspace --------------------
      function categoryFiles(group){
        const out = [];
        for(const s of sessionsByGroup(group)){
          const files = Array.isArray(s.files) ? s.files : [];
          for(const f of files){
            out.push({
              sessionTitle: s.title,
              sessionId: s.id,
              name: f.name || "Untitled",
              desc: f.desc || ""
            });
          }
        }
        return out;
      }

      function workspaceTemplate(session){
        const isBiz = session.group === "business";
        const group = session.group;

        wsHint.textContent = session.id.toUpperCase();
        wsSubtitle.textContent = (isBiz ? "Business state" : "Class state") + " • " + stamp();

        const files = session.files || [];
        const fileRows = files.map(f => `
          <div class="fileChip">
            <div>
              <div style="font-weight:850; color: rgba(243,239,230,.92);">${escapeHtml(f.name)}</div>
              <small>${escapeHtml(f.desc || "")}</small>
            </div>
            <button class="miniBtn" data-ws="open">Open</button>
          </div>
        `).join("");

        const allFiles = categoryFiles(group);
        const allFileRows = allFiles.length ? allFiles.map(f => `
          <div class="fileChip">
            <div>
              <div style="font-weight:850; color: rgba(243,239,230,.92);">${escapeHtml(f.name)}</div>
              <small>${escapeHtml(f.sessionTitle)} • ${escapeHtml(f.desc)}</small>
            </div>
            <button class="miniBtn" data-ws="open">Open</button>
          </div>
        `).join("") : `<div style="color: rgba(243,239,230,.62); font-size:12px;">No files in this category yet.</div>`;

        const assumptions = isBiz
          ? [
              { k:"Target gross margin", v:"≥ 70%", sub:"Luxury guardrail", c:"g" },
              { k:"Channels", v:"Amazon + Shopify", sub:"Different fees, same COGS base", c:"g" },
              { k:"Fee risk", v:"Verify category", sub:"Amazon referral/fulfillment vary", c:"y" },
              { k:"COGS freshness", v:"Notion not connected", sub:"Avoid locking MSRP without data", c:"r" }
            ]
          : [
              { k:"Syllabus", v:"Mounted (PDF)", sub:"Use for deadlines + grading policy", c:"g" },
              { k:"Weekly plan", v:"Build cadence", sub:"Make it automatic later", c:"y" },
              { k:"Notes", v:"Structured", sub:"Definitions • examples • self-test", c:"g" }
            ];

        const assRows = assumptions.map(a => `
          <div class="kvRow">
            <div>
              <div class="kvKey">
                <span class="confDot ${a.c}" style="transform: translateY(2px);"></span>
                <div>
                  <div>${escapeHtml(a.k)}</div>
                  <div class="kvSub">${escapeHtml(a.sub || "")}</div>
                </div>
              </div>
            </div>
            <div class="kvVal">${escapeHtml(a.v)}</div>
          </div>
        `).join("");

        const actions = isBiz ? `
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="miniBtn" data-ws="guardrails">Pricing guardrails</button>
            <button class="miniBtn" data-ws="inputs">MSRP inputs list</button>
            <button class="miniBtn" data-ws="ledger">Decision ledger</button>
          </div>
        ` : `
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="miniBtn" data-ws="plan">Weekly plan</button>
            <button class="miniBtn" data-ws="deadlines">Extract deadlines</button>
            <button class="miniBtn" data-ws="notes">Study notes</button>
          </div>
        `;

        const rag = `
          <div class="section">
            <div class="sectionTitle">
              <strong>Knowledge (RAG)</strong>
              <span>Local-only</span>
            </div>
            <div style="color: rgba(243,239,230,.72); font-size:12px; line-height:1.35;">
              Where syllabi, notes, invoices, specs, and policies live for retrieval.
              <br/>UI today; backend will index files later.
            </div>
            <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
              <button class="miniBtn" data-ws="ragAdd">Add document</button>
              <button class="miniBtn" data-ws="ragReindex">Re-index</button>
            </div>
          </div>
        `;

        return `
          <div class="section">
            <div class="sectionTitle">
              <strong>Active session</strong>
              <span>${escapeHtml(session.updated || "")}</span>
            </div>
            <div style="color: rgba(243,239,230,.86); font-size:12.5px; line-height:1.35;">
              <div style="font-weight:900; color: rgba(243,239,230,.94);">${escapeHtml(session.title)}</div>
              <div style="margin-top:4px; color: rgba(243,239,230,.70);">${escapeHtml(session.note || "")}</div>
            </div>
            <div style="margin-top:10px;">${actions}</div>
          </div>

          <div class="section">
            <div class="sectionTitle">
              <strong>Mounted files (this session)</strong>
              <span>${files.length} items</span>
            </div>
            <div style="display:flex; flex-direction:column; gap:8px;">
              ${fileRows || `<div style="color: rgba(243,239,230,.62); font-size:12px;">No files yet.</div>`}
            </div>
          </div>

          <div class="section">
            <div class="sectionTitle">
              <strong>All files (${escapeHtml(group)})</strong>
              <span>${allFiles.length} total</span>
            </div>
            <div style="display:flex; flex-direction:column; gap:8px;">
              ${allFileRows}
            </div>
          </div>

          <div class="section">
            <div class="sectionTitle">
              <strong>Working assumptions</strong>
              <span>${escapeHtml(getProfileForSession(session))}</span>
            </div>
            <div class="kv">${assRows}</div>
          </div>

          ${rag}
        `;
      }

      function hydrateWorkspace(){
        const cs = currentSession();
        if(!cs){
          hydrateWorkspaceEmpty(parseHash().group || getActiveGroup());
          return;
        }
        const html = workspaceTemplate(cs);
        workspaceBody.innerHTML = html;
        drawerWorkspaceBody.innerHTML = html;
      }

      function onWorkspaceClick(e){
        const btn = e.target.closest("[data-ws]");
        if(!btn) return;

        const act = btn.getAttribute("data-ws");
        const s = currentSession();
        if(!s) return;

        const canned = (function(){
          if(s.group === "business"){
            if(act === "guardrails") return
`Pricing guardrails (UI preview):
• Don’t lock MSRP until COGS + packaging + shipping + fees are verified.
• Keep gross margin floor ≥ 70% (luxury guardrail).
• Separate prices by channel (Amazon fees vs Shopify).
• Log every price change in a decision ledger.`;
            if(act === "inputs") return
`MSRP inputs list (UI preview):
1) Unit ingredient cost (COGS)
2) Packaging unit cost (jar/bottle + label + shrink + box)
3) Avg shipping + worst-case shipping
4) Channel fees (Amazon referral/FBA; Shopify payment fees)
5) Returns + damage reserve
6) Overhead allocation per unit (fixed costs / volume assumption)
7) Target margin floor + promo buffer`;
            if(act === "ledger") return
`Decision ledger template (UI preview):
• Date/time
• SKU + channel
• Old price → new price
• Inputs used (COGS, fees, ship, overhead)
• Margin impact (before/after)
• Reason
• Risks + mitigations
• Sources (links/files)`;
          } else {
            if(act === "plan") return
`Weekly plan (UI preview):
• Mon: read/watch + outline
• Tue: practice/problems/notes
• Wed: draft discussion/assignment
• Thu: revise + self-test
• Fri: final polish + submit`;
            if(act === "deadlines") return
`Deadlines extraction (backend hook):
Backend will parse the syllabus PDF and generate:
• assignment list
• due dates
• grading weights
• reminders`;
            if(act === "notes") return
`Study notes (backend hook):
Backend will generate structured notes:
• key terms
• examples
• common mistakes
• quick quiz questions`;
          }
          if(act === "ragAdd") return "RAG add-doc: backend will index PDFs/Docs into your local knowledge store.";
          if(act === "ragReindex") return "Re-index: backend will rebuild embeddings + refresh the vector store.";
          if(act === "open") return "UI-only: file open will be wired when backend can serve PDFs and extracted text.";
          return "UI-only action.";
        })();

        const msg = { role:"bot", confidence:"y", ts: nowTime(), content: canned };
        renderMessage(msg);
        addToHistory(msg);
      }

      function hydrateWorkspaceEmpty(group){
        wsHint.textContent = "—";
        wsSubtitle.textContent = (group === "business" ? "Business state" : "Class state") + " • " + stamp();

        const html = `
          <div class="section">
            <div class="sectionTitle">
              <strong>No active session</strong>
              <span>${escapeHtml(group)}</span>
            </div>
            <div style="color: rgba(243,239,230,.78); font-size:12.5px; line-height:1.35;">
              Create a ${group === "business" ? "Business" : "School"} session to activate the workspace.
            </div>
          </div>
        `;
        workspaceBody.innerHTML = html;
        drawerWorkspaceBody.innerHTML = html;
      }

      // -------------------- Drawers --------------------
      function openDrawer(which){
        backdrop.classList.add("open");
        if(which === "sessions"){
          sessionsDrawer.classList.add("open");
          sessionsDrawer.setAttribute("aria-hidden","false");
        } else {
          workspaceDrawer.classList.add("open");
          workspaceDrawer.setAttribute("aria-hidden","false");
        }
      }
      function closeDrawer(which){
        if(which === "sessions"){
          sessionsDrawer.classList.remove("open");
          sessionsDrawer.setAttribute("aria-hidden","true");
        } else if(which === "workspace"){
          workspaceDrawer.classList.remove("open");
          workspaceDrawer.setAttribute("aria-hidden","true");
        } else {
          sessionsDrawer.classList.remove("open");
          workspaceDrawer.classList.remove("open");
          sessionsDrawer.setAttribute("aria-hidden","true");
          workspaceDrawer.setAttribute("aria-hidden","true");
        }

        const anyOpen = sessionsDrawer.classList.contains("open") || workspaceDrawer.classList.contains("open");
        if(!anyOpen) backdrop.classList.remove("open");
      }

      // -------------------- Events --------------------
      function wireEvents(){
        // Workspace click delegation
        workspaceBody.addEventListener("click", onWorkspaceClick);
        drawerWorkspaceBody.addEventListener("click", onWorkspaceClick);

        // input
        input.addEventListener("input", () => {
          syncSendButton();
          autoSizeTextarea();
          maybeWarnAboutContext(input.value);
        });

        // IME-safe Enter-to-send
        let composing = false;
        input.addEventListener("compositionstart", () => composing = true);
        input.addEventListener("compositionend", () => composing = false);

        input.addEventListener("keydown", (e) => {
          if(e.key === "Enter" && !e.shiftKey && !composing){
            e.preventDefault();
            sendMessage();
          }
        });

        sendBtn.addEventListener("click", sendMessage);

        const switchTo = (g) => {
          closeDrawer("all");
          activateGroup(g); // sets hash
        };

        tabBiz.addEventListener("click", () => switchTo("business"));
        tabSchool.addEventListener("click", () => switchTo("school"));
        drawerTabBiz.addEventListener("click", () => switchTo("business"));
        drawerTabSchool.addEventListener("click", () => switchTo("school"));

        $("newSessionBtn").addEventListener("click", () => createSession(parseHash().group || getActiveGroup()));
        $("drawerNewSession").addEventListener("click", () => createSession(parseHash().group || getActiveGroup()));

        function sessionActionHandler(e){
          const btn = e.target.closest("[data-act]");
          if(!btn) return;
          const act = btn.getAttribute("data-act");
          const id = btn.getAttribute("data-id");
          if(!id) return;

          const s = sessions.find(x => x.id === id);
          if(!s) return;

          if(act === "activate") activateSessionById(s.group, s.id);
          if(act === "rename") renameSession(id);
          if(act === "delete") deleteSession(id);
        }
        sessionList.addEventListener("click", sessionActionHandler);
        drawerSessionList.addEventListener("click", sessionActionHandler);

        // keyboard-accessible badges
        function clickOnEnterSpace(el, fn){
          el.addEventListener("keydown", (e) => {
            if(e.key === "Enter" || e.key === " "){
              e.preventDefault();
              fn();
            }
          });
        }

        $("profileBadge").addEventListener("click", () => {
          const cs = currentSession();
          if(!cs) return;
          cycleProfileForSession(cs);
          hydrateWorkspace();
        });
        clickOnEnterSpace($("profileBadge"), () => $("profileBadge").click());

        $("notionBadge").addEventListener("click", () => {
          const cur = $("notionText").textContent || "";
          if(cur.includes("Not connected")){
            setDot(notionDot,"bad"); $("notionText").textContent = "Out of sync (12h)";
          } else if(cur.includes("Out of sync")){
            setDot(notionDot,"ok"); $("notionText").textContent = "Synced 3 min ago";
          } else {
            setDot(notionDot,"bad"); $("notionText").textContent = "Not connected";
          }
        });
        clickOnEnterSpace($("notionBadge"), () => $("notionBadge").click());

        $("openSessions").addEventListener("click", () => openDrawer("sessions"));
        $("openWorkspace").addEventListener("click", () => openDrawer("workspace"));

        $("closeSessionsDrawer").addEventListener("click", () => closeDrawer("sessions"));
        $("closeWorkspaceDrawer").addEventListener("click", () => closeDrawer("workspace"));

        backdrop.addEventListener("click", () => closeDrawer("all"));
        window.addEventListener("keydown", (e) => {
          if(e.key === "Escape") closeDrawer("all");
        });

        // Route listener
        window.addEventListener("hashchange", handleRoute);
      }

      // -------------------- Init --------------------
      let didInit = false;
      function init(){
        if(didInit) return;
        didInit = true;

        setDot(notionDot, "bad");
        $("notionText").textContent = "Not connected";
        setDot(engineDot, "bad");
        $("engineText").textContent = "UI only";

        // Ensure each group has an active session set
        ensureGroupHasActive("business");
        ensureGroupHasActive("school");

        // If no hash route provided, set based on stored active group
        const r = parseHash();
        if(!r.group){
          setHashForGroup(getActiveGroup());
          return; // handleRoute will run on hashchange
        }

        wireEvents();
        handleRoute();
        autoSizeTextarea();
      }

      try{
        if(document.readyState === "loading"){
          document.addEventListener("DOMContentLoaded", init, { once:true });
        } else {
          init();
        }
      } catch (e){
        showFatal(e);
      }
    })();
  </script>
</body>
</html>
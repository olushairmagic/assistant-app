<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>WilliamBot</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest" />
  <meta name="theme-color" content="#0B0A08" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="WilliamBot" />

  <style>
    :root{
      --bg:#0b0a08;
      --bg2:#0f0d0a;
      --cream:#f3efe6;
      --ink:#15120d;
      --muted:rgba(243,239,230,.68);
      --border:rgba(243,239,230,.14);
      --glass:rgba(15,13,10,.55);
      --glass2:rgba(15,13,10,.40);
      --red:#7a1114;
      --green:#15803d;
      --amber:#b45309;

      --r:18px;
      --r2:14px;
      --shadow:0 18px 60px rgba(0,0,0,.35);
      --shadow2:0 10px 30px rgba(0,0,0,.28);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--font);
      background:
        radial-gradient(900px 600px at 18% 10%, rgba(122,17,20,.20), transparent 55%),
        radial-gradient(800px 500px at 90% 28%, rgba(243,239,230,.10), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      color:var(--cream);
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }

    .wrap{
      height:100%;
      padding: 12px 12px calc(12px + env(safe-area-inset-bottom));
      display:flex;
      justify-content:center;
    }
    .app{
      width:100%;
      max-width: 1280px;
      height: 100%;
      display:grid;
      grid-template-columns: 300px 1fr 360px;
      grid-template-rows: auto 1fr;
      gap: 12px;
      min-width: 0;
    }

    header{
      grid-column: 1 / -1;
      border: 1px solid var(--border);
      background: var(--glass);
      backdrop-filter: blur(10px);
      border-radius: var(--r);
      box-shadow: var(--shadow2);
      padding: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      min-width: 0;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .logo{
      width: 38px;
      height: 38px;
      border-radius: 14px;
      display:grid;
      place-items:center;
      user-select:none;
      font-weight:900;
      letter-spacing:.4px;
      color: var(--cream);
      border: 1px solid rgba(243,239,230,.16);
      background:
        radial-gradient(18px 18px at 30% 25%, rgba(243,239,230,.22), transparent 55%),
        linear-gradient(135deg, rgba(122,17,20,.75), rgba(122,17,20,.20));
      box-shadow: 0 10px 22px rgba(122,17,20,.18);
    }
    .brandText{
      display:flex;
      flex-direction:column;
      line-height: 1.06;
      min-width: 0;
    }
    .brandText strong{
      font-size: 15.5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .brandText span{
      font-size: 12px;
      color: rgba(243,239,230,.68);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .statusRow{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .badge{
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--glass2);
      color: rgba(243,239,230,.80);
      font-size: 12px;
      user-select:none;
      cursor: default;
      white-space: nowrap;
      max-width: 420px;
    }
    .badge .label{
      color: rgba(243,239,230,.62);
      font-weight: 650;
    }
    .dot{
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: var(--amber);
      box-shadow: 0 0 0 4px rgba(180,83,9,.14);
      flex: 0 0 auto;
    }
    .dot.ok{ background: var(--green); box-shadow: 0 0 0 4px rgba(21,128,61,.14); }
    .dot.bad{ background: #b91c1c; box-shadow: 0 0 0 4px rgba(185,28,28,.16); }

    .ghostBtn{
      border: 1px solid var(--border);
      background: rgba(15,13,10,.40);
      color: rgba(243,239,230,.88);
      padding: 10px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 740;
      font-size: 13px;
      transition: transform .06s ease, border-color .12s ease, background .12s ease;
      user-select:none;
    }
    .ghostBtn:active{ transform: translateY(1px); }
    .ghostBtn:hover{
      border-color: rgba(243,239,230,.22);
      background: rgba(15,13,10,.55);
    }

    .panel{
      border-radius: var(--r);
      border: 1px solid var(--border);
      background: var(--glass);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 0;
      min-width: 0;
    }
    .panelHeader{
      padding: 12px 12px;
      border-bottom: 1px solid rgba(243,239,230,.14);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .panelHeader strong{
      font-size: 13px;
      letter-spacing: .2px;
      color: rgba(243,239,230,.92);
    }
    .panelHeader span{
      font-size: 12px;
      color: rgba(243,239,230,.62);
    }
    .panelBody{
      padding: 10px;
      overflow:auto;
      min-height: 0;
    }

    /* Sessions list */
    .groupTitle{
      font-size: 11px;
      color: rgba(243,239,230,.65);
      letter-spacing: .18px;
      margin: 8px 0 6px;
      text-transform: uppercase;
    }
    .sessionItem{
      border: 1px solid rgba(243,239,230,.14);
      background: rgba(15,13,10,.35);
      border-radius: 14px;
      padding: 10px;
      cursor:pointer;
      transition: border-color .12s ease, background .12s ease;
      margin-bottom: 8px;
    }
    .sessionItem:hover{
      border-color: rgba(243,239,230,.22);
      background: rgba(15,13,10,.48);
    }
    .sessionItem.active{
      border-color: rgba(122,17,20,.35);
      background: rgba(122,17,20,.14);
    }
    .sessionTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .sessionName{
      font-weight: 820;
      font-size: 13px;
      color: rgba(243,239,230,.92);
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      min-width:0;
    }
    .pill{
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(243,239,230,.14);
      color: rgba(243,239,230,.74);
      background: rgba(15,13,10,.35);
      user-select:none;
      flex: 0 0 auto;
    }
    .sessionNote{
      margin-top: 6px;
      font-size: 12px;
      color: rgba(243,239,230,.62);
      line-height: 1.25;
    }

    /* Chat */
    .chat{
      border-radius: var(--r);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 0;
      background:
        radial-gradient(900px 600px at 30% 0%, rgba(122,17,20,.10), transparent 55%),
        linear-gradient(180deg, rgba(243,239,230,.08), rgba(243,239,230,.04));
      min-width: 0;
    }
    .feed{
      flex:1;
      overflow:auto;
      padding: 14px 12px;
      background:
        radial-gradient(900px 600px at 25% 20%, rgba(243,239,230,.12), transparent 55%),
        linear-gradient(180deg, rgba(243,239,230,.10), rgba(243,239,230,.06));
      min-height: 0;
    }
    .row{ display:flex; margin: 10px 0; gap: 10px; }
    .row.you{ justify-content:flex-end; }
    .row.bot{ justify-content:flex-start; }

    .bubbleWrap{
      display:flex;
      flex-direction:column;
      gap: 6px;
      max-width: min(92ch, 96%);
      min-width: 0;
    }
    .bubble{
      padding: 12px 12px;
      border-radius: var(--r2);
      border: 1px solid rgba(21,18,13,.14);
      background: rgba(243,239,230,.92);
      color: var(--ink);
      box-shadow: 0 8px 20px rgba(0,0,0,.10);
      white-space: pre-wrap;
      word-wrap: break-word;
      line-height: 1.42;
      font-size: 14.6px;
      position: relative;
      min-width: 0;
    }
    .you .bubble{
      border-color: rgba(122,17,20,.25);
      box-shadow:
        0 10px 24px rgba(122,17,20,.10),
        0 0 0 1px rgba(122,17,20,.08) inset;
      padding-left: 14px;
    }
    .you .bubble:before{
      content:"";
      position:absolute;
      left: 0;
      top: 10px;
      bottom: 10px;
      width: 3px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(122,17,20,.85), rgba(122,17,20,.20));
      opacity:.9;
    }
    .meta{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size: 11px;
      color: rgba(21,18,13,.62);
      padding: 0 2px;
      align-items:center;
    }

    .composer{
      padding: 12px;
      border-top: 1px solid rgba(243,239,230,.14);
      background: rgba(15,13,10,.45);
      display:flex;
      gap: 10px;
      align-items:flex-end;
    }
    textarea{
      flex:1;
      resize:none;
      min-height: 48px;
      max-height: 180px;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(243,239,230,.16);
      background: rgba(11,10,8,.55);
      color: rgba(243,239,230,.92);
      font-size: 14.6px;
      outline:none;
    }
    textarea::placeholder{ color: rgba(243,239,230,.55); }
    textarea:focus{
      border-color: rgba(122,17,20,.40);
      box-shadow: 0 0 0 5px rgba(122,17,20,.16);
    }
    .send{
      min-width: 96px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(122,17,20,.45);
      background: linear-gradient(180deg, rgba(122,17,20,.32), rgba(122,17,20,.18));
      color: rgba(243,239,230,.95);
      font-weight: 820;
      cursor: pointer;
      box-shadow: 0 10px 26px rgba(122,17,20,.16);
      transition: transform .06s ease, filter .12s ease;
    }
    .send:hover{ filter: brightness(1.06); }
    .send:active{ transform: translateY(1px); }
    .send:disabled{
      opacity: .55;
      cursor: not-allowed;
      box-shadow: none;
    }

    /* Context */
    .section{
      border: 1px solid rgba(243,239,230,.14);
      background: rgba(15,13,10,.35);
      border-radius: 14px;
      padding: 10px;
      margin-bottom: 10px;
    }
    .sectionTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 8px;
    }
    .sectionTitle strong{
      font-size: 12.5px;
      color: rgba(243,239,230,.90);
      letter-spacing: .2px;
    }
    .sectionTitle span{
      font-size: 12px;
      color: rgba(243,239,230,.62);
    }
    .kv{
      font-size: 12px;
      color: rgba(243,239,230,.82);
      line-height: 1.45;
    }
    .kv .muted{ color: rgba(243,239,230,.62); }

    /* Mobile drawers */
    .drawerBack{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      z-index: 998;
    }
    .drawer{
      width: min(820px, 100%);
      max-height: 86vh;
      border-radius: 22px;
      border: 1px solid rgba(243,239,230,.18);
      background: rgba(15,13,10,.86);
      backdrop-filter: blur(12px);
      box-shadow: 0 22px 80px rgba(0,0,0,.55);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 0;
    }
    .drawerGrip{
      height: 20px;
      display:grid;
      place-items:center;
      border-bottom: 1px solid rgba(243,239,230,.14);
    }
    .gripBar{
      width: 56px; height: 6px;
      border-radius: 999px;
      background: rgba(243,239,230,.18);
    }
    .drawerHdr{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .drawerHdr strong{ font-size: 13px; color: rgba(243,239,230,.92); }
    .drawerHdr span{ font-size: 12px; color: rgba(243,239,230,.62); }
    .drawerBody{
      padding: 12px;
      overflow:auto;
      min-height: 0;
    }

    @media (max-width: 1080px){
      .app{ grid-template-columns: 300px 1fr; }
      #contextPanel{ display:none; }
    }
    @media (max-width: 760px){
      .app{ grid-template-columns: 1fr; }
      #leftPanel{ display:none; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="app">

      <header>
        <div class="brand">
          <div class="logo">W</div>
          <div class="brandText">
            <strong>WilliamBot</strong>
            <span id="topSub">Session: —</span>
          </div>
        </div>

        <div class="statusRow">
          <div class="badge" title="Backend status">
            <span id="backendDot" class="dot bad"></span>
            <span class="label">Engine</span>
            <span id="backendText">UI-only</span>
          </div>

          <div class="badge" title="Storage is local (per session)">
            <span class="dot ok"></span>
            <span class="label">State</span>
            <span>Saved per session</span>
          </div>

          <button class="ghostBtn" id="sessionsBtn">Sessions</button>
          <button class="ghostBtn" id="contextBtn">Context</button>
        </div>
      </header>

      <!-- LEFT: Sessions (desktop/tablet) -->
      <aside class="panel" id="leftPanel">
        <div class="panelHeader">
          <div>
            <strong>Sessions</strong>
            <div><span id="sessionCount">0</span><span> total</span></div>
          </div>
          <span id="activeSessionLabel">Active: —</span>
        </div>
        <div class="panelBody" id="sessionList"></div>
      </aside>

      <!-- CENTER: Chat -->
      <main class="chat">
        <div class="feed" id="feed"></div>
        <div class="composer">
          <textarea id="input" placeholder="Send a message… (Enter to send, Shift+Enter new line)"></textarea>
          <button class="send" id="sendBtn" disabled>Send</button>
        </div>
      </main>

      <!-- RIGHT: Context (desktop only) -->
      <aside class="panel" id="contextPanel">
        <div class="panelHeader">
          <div>
            <strong>Context</strong>
            <div><span>Session-scoped</span></div>
          </div>
          <span id="ctxHint">—</span>
        </div>
        <div class="panelBody" id="contextContentDesktop"></div>
      </aside>

    </div>
  </div>

  <!-- MOBILE: Sessions Drawer -->
  <div class="drawerBack" id="sessionsDrawerBack" aria-hidden="true">
    <div class="drawer">
      <div class="drawerGrip"><div class="gripBar"></div></div>
      <div class="drawerHdr">
        <div>
          <strong>Sessions</strong><br/>
          <span>Tap a session to switch (old ones stay here).</span>
        </div>
        <button class="ghostBtn" id="sessionsDrawerClose">Close</button>
      </div>
      <div class="drawerBody" id="sessionListMobile"></div>
    </div>
  </div>

  <!-- MOBILE: Context Drawer -->
  <div class="drawerBack" id="contextDrawerBack" aria-hidden="true">
    <div class="drawer">
      <div class="drawerGrip"><div class="gripBar"></div></div>
      <div class="drawerHdr">
        <div>
          <strong>Context</strong><br/>
          <span>Session-scoped working state.</span>
        </div>
        <button class="ghostBtn" id="contextDrawerClose">Close</button>
      </div>
      <div class="drawerBody" id="contextContentMobile"></div>
    </div>
  </div>

  <script>
    // ====== STORAGE KEYS ======
    const STORE = {
      sessions: "wb_sessions_v3",
      activeSession: "wb_active_session_v3",
      historyPrefix: "wb_history_v3_"
    };

    const $ = (id) => document.getElementById(id);

    const feed = $("feed");
    const input = $("input");
    const sendBtn = $("sendBtn");

    const sessionsBtn = $("sessionsBtn");
    const contextBtn = $("contextBtn");

    const sessionList = $("sessionList");
    const sessionListMobile = $("sessionListMobile");
    const sessionCount = $("sessionCount");
    const activeSessionLabel = $("activeSessionLabel");

    const topSub = $("topSub");
    const ctxHint = $("ctxHint");

    const contextPanel = $("contextPanel");
    const contextContentDesktop = $("contextContentDesktop");
    const contextContentMobile = $("contextContentMobile");

    const sessionsDrawerBack = $("sessionsDrawerBack");
    const sessionsDrawerClose = $("sessionsDrawerClose");
    const contextDrawerBack = $("contextDrawerBack");
    const contextDrawerClose = $("contextDrawerClose");

    // ====== UTILS ======
    function nowTime(){
      const d = new Date();
      return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
    }
    function nowStamp(){
      const d = new Date();
      return d.toLocaleString([], {month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit"});
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"]/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]));
    }
    function historyKey(sessionId){ return STORE.historyPrefix + sessionId; }
    function isMobileLayout(){ return window.matchMedia("(max-width: 760px)").matches; }

    // ====== SESSIONS MODEL ======
    const DEFAULT_SESSIONS = [
      // Business
      { id:"biz_pricing", group:"Business", title:"Pricing & Margins", note:"MSRP, fees, profit targets" },
      { id:"biz_formulation", group:"Business", title:"Formulation", note:"Constraints, batches, stability" },
      { id:"biz_amazon", group:"Business", title:"Amazon Ops", note:"Listings, compliance, reviews" },

      // School
      { id:"school_math107", group:"School", title:"MATH 107 — College Algebra", note:"UMGC • Spring 2026" },
      { id:"school_hist125", group:"School", title:"HIST 125 — Technological Transformations", note:"UMGC • Spring 2026" }
    ];

    function loadSessions(){
      try{
        const raw = localStorage.getItem(STORE.sessions);
        const data = raw ? JSON.parse(raw) : null;
        if(Array.isArray(data) && data.length) return data;
      } catch {}
      // first run
      const seeded = DEFAULT_SESSIONS.map(s => ({...s, updated: nowStamp()}));
      localStorage.setItem(STORE.sessions, JSON.stringify(seeded));
      return seeded;
    }
    function saveSessions(list){
      localStorage.setItem(STORE.sessions, JSON.stringify(list));
    }

    function getActiveSessionId(){
      const v = localStorage.getItem(STORE.activeSession);
      return v || "biz_pricing";
    }
    function setActiveSessionId(id){
      localStorage.setItem(STORE.activeSession, id);
    }

    function loadHistory(sessionId){
      try{
        const raw = localStorage.getItem(historyKey(sessionId));
        if(!raw) return [];
        const data = JSON.parse(raw);
        return Array.isArray(data) ? data : [];
      } catch { return []; }
    }
    function saveHistory(sessionId, hist){
      localStorage.setItem(historyKey(sessionId), JSON.stringify(hist.slice(-400)));
    }

    let sessions = loadSessions();
    let activeSessionId = getActiveSessionId();
    let history = loadHistory(activeSessionId);

    // ====== RENDER: SESSIONS LIST ======
    function renderSessions(targetEl){
      const groups = {};
      for(const s of sessions){
        groups[s.group] = groups[s.group] || [];
        groups[s.group].push(s);
      }

      targetEl.innerHTML = "";
      const order = ["Business","School"];
      const keys = order.filter(k => groups[k]).concat(Object.keys(groups).filter(k => !order.includes(k)));

      for(const g of keys){
        const gt = document.createElement("div");
        gt.className = "groupTitle";
        gt.textContent = g;
        targetEl.appendChild(gt);

        for(const s of groups[g]){
          const div = document.createElement("div");
          div.className = "sessionItem" + (s.id === activeSessionId ? " active" : "");
          div.innerHTML = `
            <div class="sessionTop">
              <div class="sessionName">${escapeHtml(s.title)}</div>
              <span class="pill">${s.id === activeSessionId ? "Active" : "Open"}</span>
            </div>
            <div class="sessionNote">
              ${escapeHtml(s.note || "")}<br/>
              <span style="opacity:.75;">Updated: ${escapeHtml(s.updated || "—")}</span>
            </div>
          `;
          div.addEventListener("click", () => switchSession(s.id));
          targetEl.appendChild(div);
        }
      }
    }

    function renderAllSessions(){
      sessionCount.textContent = String(sessions.length);
      const active = sessions.find(s => s.id === activeSessionId);
      activeSessionLabel.textContent = "Active: " + (active ? active.title : "—");
      renderSessions(sessionList);
      renderSessions(sessionListMobile);

      topSub.textContent = "Session: " + (active ? active.title : activeSessionId);
      ctxHint.textContent = active ? active.group : "—";
    }

    // ====== RENDER: CHAT ======
    function renderMessage(m){
      const row = document.createElement("div");
      row.className = "row " + (m.role === "you" ? "you" : "bot");

      const wrap = document.createElement("div");
      wrap.className = "bubbleWrap";

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = m.content || "";

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.innerHTML = `<span>${m.role === "you" ? "You" : "WilliamBot"}</span><span>${escapeHtml(m.ts || nowTime())}</span>`;

      wrap.appendChild(bubble);
      wrap.appendChild(meta);
      row.appendChild(wrap);
      feed.appendChild(row);
      feed.scrollTop = feed.scrollHeight;
    }

    function hydrateThread(){
      feed.innerHTML = "";
      if(history.length === 0){
        const active = sessions.find(s => s.id === activeSessionId);
        const intro = {
          role:"bot",
          ts: nowTime(),
          content:
`UI is live.

You are in: ${active ? active.title : activeSessionId}

Sessions are the main switch now.
Old sessions never disappear — they stay in the Sessions list.

Backend will connect later (Tailscale + local server).`
        };
        history.push(intro);
        saveHistory(activeSessionId, history);
      }
      history.forEach(renderMessage);
    }

    // ====== CONTEXT (SESSION-SCOPED) ======
    function contextForSession(sessionId){
      // Calm + minimal. Replace later with real RAG + syllabus parsing.
      if(sessionId.startsWith("biz_")){
        return {
          title:"Business context",
          blocks:[
            { k:"Focus", v:"Pricing, ops, formulation, Amazon/Shopify" },
            { k:"Rule", v:"Don’t commit pricing without fresh COGS + fees + ship cost." },
            { k:"Backend", v:"UI-only until PC arrives." }
          ]
        };
      }
      if(sessionId === "school_math107"){
        return {
          title:"MATH 107 context",
          blocks:[
            { k:"Course", v:"College Algebra (UMGC)" },
            { k:"Use", v:"Upload worksheets/notes; I’ll explain steps and check work." },
            { k:"Next", v:"Later: add syllabus as a local RAG source." }
          ]
        };
      }
      if(sessionId === "school_hist125"){
        return {
          title:"HIST 125 context",
          blocks:[
            { k:"Course", v:"Technological Transformations (UMGC)" },
            { k:"Use", v:"Summaries, outlines, discussion post structure, citations help." },
            { k:"Next", v:"Later: add syllabus as a local RAG source." }
          ]
        };
      }
      return { title:"Context", blocks:[{k:"—",v:"—"}] };
    }

    function renderContext(){
      const data = contextForSession(activeSessionId);
      const stamp = nowStamp();

      const html = `
        <div class="section">
          <div class="sectionTitle">
            <strong>${escapeHtml(data.title)}</strong>
            <span>${escapeHtml(stamp)}</span>
          </div>
          <div class="kv">
            ${data.blocks.map(b => `
              <div style="margin-bottom:8px;">
                <div><strong style="color:rgba(243,239,230,.92)">${escapeHtml(b.k)}:</strong></div>
                <div class="muted">${escapeHtml(b.v)}</div>
              </div>
            `).join("")}
          </div>
        </div>

        <div class="section">
          <div class="sectionTitle">
            <strong>Session storage</strong>
            <span>${escapeHtml(stamp)}</span>
          </div>
          <div class="kv">
            <div class="muted">Each session has its own saved chat history (localStorage).</div>
            <div style="margin-top:8px;" class="muted">Switch sessions using the Sessions button.</div>
          </div>
        </div>
      `;

      contextContentDesktop.innerHTML = html;
      contextContentMobile.innerHTML = html;
    }

    // ====== SWITCH SESSION ======
    function switchSession(newId){
      if(newId === activeSessionId) return;

      activeSessionId = newId;
      setActiveSessionId(newId);

      history = loadHistory(activeSessionId);

      // update updated stamp
      sessions = sessions.map(s => s.id === newId ? {...s, updated: nowStamp()} : s);
      saveSessions(sessions);

      renderAllSessions();
      hydrateThread();
      renderContext();

      if(isMobileLayout()){
        closeSessionsDrawer();
      }
    }

    // ====== SEND ======
    function syncSend(){ sendBtn.disabled = input.value.trim().length === 0; }

    function addToHistory(m){
      history.push(m);
      saveHistory(activeSessionId, history);
    }

    function sendMessage(){
      const text = input.value.trim();
      if(!text) return;

      input.value = "";
      syncSend();

      const you = { role:"you", ts: nowTime(), content:text };
      renderMessage(you);
      addToHistory(you);

      const bot = {
        role:"bot",
        ts: nowTime(),
        content:"Backend not connected yet (UI-only). When your PC arrives, we’ll wire /health + /chat over Tailscale."
      };
      renderMessage(bot);
      addToHistory(bot);

      renderContext();
    }

    // ====== DRAWERS ======
    function openSessionsDrawer(){
      sessionsDrawerBack.style.display = "flex";
      sessionsDrawerBack.setAttribute("aria-hidden","false");
    }
    function closeSessionsDrawer(){
      sessionsDrawerBack.style.display = "none";
      sessionsDrawerBack.setAttribute("aria-hidden","true");
    }
    function openContextDrawer(){
      contextDrawerBack.style.display = "flex";
      contextDrawerBack.setAttribute("aria-hidden","false");
    }
    function closeContextDrawer(){
      contextDrawerBack.style.display = "none";
      contextDrawerBack.setAttribute("aria-hidden","true");
    }

    // ====== EVENTS ======
    input.addEventListener("input", syncSend);
    input.addEventListener("keydown", (e) => {
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        sendMessage();
      }
    });
    sendBtn.addEventListener("click", sendMessage);

    sessionsBtn.addEventListener("click", () => {
      if(isMobileLayout()) openSessionsDrawer();
      else $("leftPanel").classList.toggle("hidden");
    });

    contextBtn.addEventListener("click", () => {
      if(window.matchMedia("(max-width: 1080px)").matches) openContextDrawer();
      else contextPanel.classList.toggle("hidden");
    });

    sessionsDrawerClose.addEventListener("click", closeSessionsDrawer);
    sessionsDrawerBack.addEventListener("click", (e) => { if(e.target === sessionsDrawerBack) closeSessionsDrawer(); });

    contextDrawerClose.addEventListener("click", closeContextDrawer);
    contextDrawerBack.addEventListener("click", (e) => { if(e.target === contextDrawerBack) closeContextDrawer(); });

    // ====== INIT ======
    // ensure active session exists
    if(!sessions.some(s => s.id === activeSessionId)){
      activeSessionId = "biz_pricing";
      setActiveSessionId(activeSessionId);
    }

    renderAllSessions();
    hydrateThread();
    renderContext();
    syncSend();
  </script>
</body>
</html>
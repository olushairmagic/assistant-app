<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>WilliamBot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest" />
  <meta name="theme-color" content="#0b0a08" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="WilliamBot" />

  <style>
    :root{
      --bg:#0b0a08;
      --bg2:#12100c;

      --cream:#f3efe6;
      --ink:#1b1813;

      --border: rgba(243,239,230,.14);
      --border2: rgba(243,239,230,.20);

      --accent:#7a1114;
      --accent2:#a0141a;
      --school:#1e40af;
      --school2:#2563eb;
      --personal:#0f766e;
      --personal2:#14b8a6;

      --green:#15803d;
      --amber:#b45309;
      --red:#b91c1c;

      --r:18px;
      --r2:14px;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --shadow2: 0 10px 30px rgba(0,0,0,.28);

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;

      --s1: 6px;
      --s2: 10px;
      --s3: 12px;
      --s4: 14px;
      --s5: 16px;

      --tFast: 90ms;
      --tMed: 120ms;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; }
    body{
      font-family: var(--font);
      background:
        radial-gradient(900px 600px at 18% 10%, rgba(122,17,20,.20), transparent 55%),
        radial-gradient(800px 500px at 90% 28%, rgba(243,239,230,.10), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      color: var(--cream);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      overflow-x:hidden;
    }

    @media (prefers-reduced-motion: reduce){
      *{
        transition: none !important;
        animation: none !important;
        scroll-behavior: auto !important;
      }
    }

    .hidden { display:none !important; }
    .srOnly{
      position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0;
    }

    :focus-visible{
      outline: 3px solid rgba(243,239,230,.42);
      outline-offset: 2px;
      border-radius: 10px;
    }

    .wrap{
      height:100%;
      padding: var(--s3) var(--s3) calc(var(--s3) + env(safe-area-inset-bottom));
      display:flex;
      justify-content:center;
    }
    .app{
      width:100%;
      max-width: 1280px;
      height: 100%;
      display:grid;
      grid-template-columns: 300px 1fr 360px;
      grid-template-rows: auto 1fr;
      gap: var(--s3);
      min-width: 0;
    }

    header{
      grid-column: 1 / -1;
      border: 1px solid var(--border);
      background: rgba(20,17,13,.78);
      backdrop-filter: blur(10px);
      border-radius: var(--r);
      box-shadow: var(--shadow2);
      padding: var(--s3);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: var(--s3);
      min-width: 0;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: var(--s2);
      min-width: 0;
    }
    .logo{
      width: 38px;
      height: 38px;
      border-radius: 14px;
      display:grid;
      place-items:center;
      user-select:none;
      font-weight: 900;
      letter-spacing: .4px;
      color: var(--cream);
      border: 1px solid rgba(243,239,230,.16);
      background:
        radial-gradient(18px 18px at 30% 25%, rgba(243,239,230,.22), transparent 55%),
        linear-gradient(135deg, rgba(122,17,20,.75), rgba(122,17,20,.20));
      box-shadow: 0 10px 22px rgba(122,17,20,.18);
      flex: 0 0 auto;
    }
    .brandText{
      display:flex;
      flex-direction:column;
      line-height: 1.06;
      min-width: 0;
      gap: 6px;
    }
    .brandText strong{
      font-size: 15.5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .catRow{
      display:flex;
      align-items:center;
      gap: var(--s2);
      min-width: 0;
    }
    .catBadge{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 5px 9px;
      border-radius: 999px;
      border: 1px solid rgba(243,239,230,.14);
      font-size: 12px;
      color: rgba(243,239,230,.92);
      background: rgba(15,13,10,.35);
      white-space: nowrap;
      user-select:none;
      flex: 0 0 auto;
    }
    .catBadge .miniDot{
      width: 8px;
      height: 8px;
      border-radius: 50%;
      box-shadow: 0 0 0 3px rgba(0,0,0,.18);
      flex: 0 0 auto;
    }
    .catBadge.biz .miniDot{ background: var(--accent2); box-shadow: 0 0 0 3px rgba(122,17,20,.16); }
    .catBadge.school .miniDot{ background: var(--school2); box-shadow: 0 0 0 3px rgba(37,99,235,.16); }
    .catBadge.personal .miniDot{ background: var(--personal2); box-shadow: 0 0 0 3px rgba(20,184,166,.16); }

    #topSub{
      font-size: 12px;
      color: rgba(243,239,230,.68);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 0;
      max-width: 64ch;
    }

    .statusRow{
      display:flex;
      align-items:center;
      gap: var(--s2);
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .badge{
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(20,17,13,.55);
      color: rgba(243,239,230,.82);
      font-size: 12px;
      user-select:none;
      white-space: nowrap;
      max-width: 100%;
      transition: background var(--tMed) ease, border-color var(--tMed) ease;
    }
    .badge.clickable{ cursor:pointer; }
    .badge:hover{
      border-color: var(--border2);
      background: rgba(20,17,13,.66);
    }
    .badge .label{
      color: rgba(243,239,230,.62);
      font-weight: 650;
    }

    .dot{
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: var(--amber);
      box-shadow: 0 0 0 4px rgba(180,83,9,.14);
      flex: 0 0 auto;
    }
    .dot.ok{ background: var(--green); box-shadow: 0 0 0 4px rgba(21,128,61,.14); }
    .dot.bad{ background: var(--red); box-shadow: 0 0 0 4px rgba(185,28,28,.16); }

    .ghostBtn{
      border: 1px solid var(--border);
      background: rgba(20,17,13,.45);
      color: rgba(243,239,230,.90);
      padding: 10px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 740;
      font-size: 13px;
      transition: background var(--tMed) ease, border-color var(--tMed) ease;
      user-select:none;
    }
    .ghostBtn:hover{
      border-color: var(--border2);
      background: rgba(20,17,13,.62);
    }

    .panel{
      border-radius: var(--r);
      border: 1px solid var(--border);
      background: rgba(20,17,13,.78);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 0;
      min-width: 0;
    }
    .panelHeader{
      padding: var(--s3);
      border-bottom: 1px solid rgba(243,239,230,.14);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: var(--s2);
    }
    .panelHeader strong{
      font-size: 13px;
      letter-spacing: .2px;
      color: rgba(243,239,230,.92);
    }
    .panelHeader small{
      display:block;
      font-size: 12px;
      color: rgba(243,239,230,.62);
      margin-top:4px;
    }
    .panelBody{
      padding: var(--s2);
      overflow:auto;
      min-height: 0;
    }

    .segRow{
      display:flex;
      gap:8px;
      margin-top:10px;
      flex-wrap: wrap;
    }
    .seg{
      flex:1;
      min-width: 86px;
      padding: 10px 10px;
      border-radius: 999px;
      border: 1px solid rgba(243,239,230,.14);
      background: rgba(15,13,10,.35);
      color: rgba(243,239,230,.82);
      font-weight: 820;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
      text-align:center;
      transition: border-color var(--tMed) ease, background var(--tMed) ease;
      white-space: nowrap;
    }
    .seg.active{
      border-color: rgba(122,17,20,.45);
      background: rgba(122,17,20,.18);
      color: rgba(243,239,230,.92);
      box-shadow: 0 0 0 4px rgba(122,17,20,.10) inset;
    }
    .seg.schoolActive{
      border-color: rgba(37,99,235,.45);
      background: rgba(37,99,235,.16);
      box-shadow: 0 0 0 4px rgba(37,99,235,.10) inset;
    }
    .seg.personalActive{
      border-color: rgba(20,184,166,.45);
      background: rgba(20,184,166,.14);
      box-shadow: 0 0 0 4px rgba(20,184,166,.10) inset;
    }

    .list{ display:flex; flex-direction:column; gap: 8px; margin-top:10px; }
    .item{
      border: 1px solid rgba(243,239,230,.14);
      background: rgba(15,13,10,.35);
      border-radius: 14px;
      padding: 10px;
      cursor:pointer;
      transition: border-color var(--tMed) ease, background var(--tMed) ease;
    }
    .item:hover{
      border-color: rgba(243,239,230,.22);
      background: rgba(15,13,10,.48);
    }
    .item.active{
      border-color: rgba(243,239,230,.26);
      background: rgba(243,239,230,.06);
      box-shadow: 0 0 0 3px rgba(243,239,230,.06) inset;
    }
    .itemTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .itemTitle{
      font-weight: 850;
      font-size: 13px;
      color: rgba(243,239,230,.92);
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      min-width:0;
    }
    .pillMini{
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(243,239,230,.14);
      color: rgba(243,239,230,.72);
      background: rgba(15,13,10,.35);
      flex: 0 0 auto;
      user-select:none;
    }
    .itemMeta{
      font-size: 12px;
      color: rgba(243,239,230,.62);
      margin-top: 6px;
      line-height: 1.25;
    }
    .rowBtns{
      display:flex;
      gap:8px;
      margin-top:10px;
      flex-wrap: wrap;
    }

    .chat{
      border-radius: var(--r);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 0;
      min-width: 0;
    }
    .chat.bizBg{
      background:
        radial-gradient(900px 600px at 30% 0%, rgba(122,17,20,.10), transparent 55%),
        linear-gradient(180deg, rgba(243,239,230,.08), rgba(243,239,230,.04));
    }
    .chat.schoolBg{
      background:
        radial-gradient(900px 600px at 30% 0%, rgba(37,99,235,.10), transparent 55%),
        linear-gradient(180deg, rgba(243,239,230,.08), rgba(243,239,230,.04));
    }
    .chat.personalBg{
      background:
        radial-gradient(900px 600px at 30% 0%, rgba(20,184,166,.10), transparent 55%),
        linear-gradient(180deg, rgba(243,239,230,.08), rgba(243,239,230,.04));
    }

    .feed{
      flex:1;
      overflow:auto;
      padding: 14px 12px;
      background:
        radial-gradient(900px 600px at 25% 20%, rgba(243,239,230,.12), transparent 55%),
        linear-gradient(180deg, rgba(243,239,230,.10), rgba(243,239,230,.06));
      min-height: 0;
      scroll-behavior: smooth;
    }

    .row{ display:flex; margin: 10px 0; gap: 10px; }
    .row.you{ justify-content:flex-end; }
    .row.bot{ justify-content:flex-start; }

    .bubbleWrap{
      display:flex;
      flex-direction:column;
      gap: 6px;
      max-width: min(92ch, 96%);
      min-width: 0;
    }
    .bubble{
      padding: 12px 12px;
      border-radius: var(--r2);
      border: 1px solid rgba(21,18,13,.14);
      background: rgba(243,239,230,.92);
      color: var(--ink);
      box-shadow: 0 8px 20px rgba(0,0,0,.10);
      white-space: pre-wrap;
      word-wrap: break-word;
      line-height: 1.42;
      font-size: 14.6px;
      position: relative;
      min-width: 0;
    }
    .you .bubble{
      border-color: rgba(122,17,20,.25);
      box-shadow:
        0 10px 24px rgba(122,17,20,.10),
        0 0 0 1px rgba(122,17,20,.08) inset;
      padding-left: 14px;
    }
    .you .bubble:before{
      content:"";
      position:absolute;
      left: 0;
      top: 10px;
      bottom: 10px;
      width: 3px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(122,17,20,.85), rgba(122,17,20,.20));
      opacity:.9;
    }

    .meta{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size: 11px;
      color: rgba(21,18,13,.62);
      padding: 0 2px;
      align-items:center;
    }
    .confidence{ display:flex; align-items:center; gap: 6px; user-select:none; }
    .confDot{
      width: 8px; height: 8px; border-radius: 50%;
      background: #9ca3af;
      box-shadow: 0 0 0 3px rgba(156,163,175,.18);
    }
    .confDot.g{ background: var(--green); box-shadow: 0 0 0 3px rgba(21,128,61,.14); }
    .confDot.y{ background: var(--amber); box-shadow: 0 0 0 3px rgba(180,83,9,.14); }
    .confDot.r{ background: var(--red); box-shadow: 0 0 0 3px rgba(185,28,28,.14); }

    .composer{
      padding: var(--s3);
      border-top: 1px solid rgba(243,239,230,.14);
      background: rgba(20,17,13,.52);
      display:flex;
      flex-direction:column;
      gap: var(--s2);
    }

    /* Attach chips row */
    .chipsRow{
      display:flex;
      gap:8px;
      flex-wrap: wrap;
      align-items:center;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(243,239,230,.14);
      background: rgba(15,13,10,.30);
      color: rgba(243,239,230,.86);
      font-size: 12px;
      user-select:none;
      max-width: 100%;
    }
    .chip strong{
      font-weight: 860;
      color: rgba(243,239,230,.92);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 44ch;
    }
    .chipBtn{
      border: 1px solid rgba(243,239,230,.14);
      background: rgba(20,17,13,.45);
      color: rgba(243,239,230,.92);
      padding: 6px 10px;
      border-radius: 999px;
      cursor:pointer;
      font-weight: 820;
      font-size: 12px;
      user-select:none;
    }
    .chipBtn:hover{
      border-color: rgba(243,239,230,.22);
      background: rgba(20,17,13,.62);
    }
    .chipX{
      border: none;
      background: transparent;
      color: rgba(243,239,230,.72);
      cursor:pointer;
      font-weight: 900;
      padding: 0 2px;
      line-height: 1;
    }
    .chipX:hover{ color: rgba(243,239,230,.92); }

    .composerRow{
      display:flex;
      gap: var(--s2);
      align-items:flex-end;
    }

    textarea{
      flex:1;
      resize:none;
      min-height: 48px;
      max-height: 220px;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(243,239,230,.16);
      background: rgba(11,10,8,.55);
      color: rgba(243,239,230,.92);
      font-size: 14.6px;
      outline:none;
    }
    textarea::placeholder{ color: rgba(243,239,230,.55); }
    textarea:focus{
      border-color: rgba(122,17,20,.40);
      box-shadow: 0 0 0 5px rgba(122,17,20,.16);
    }

    .warn{
      display:none;
      border: 1px solid rgba(180,83,9,.35);
      background: rgba(180,83,9,.10);
      color: rgba(243,239,230,.92);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 12.5px;
      line-height: 1.35;
    }
    .warn strong{ color: rgba(243,239,230,.95); }

    .send{
      min-width: 96px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(122,17,20,.45);
      background: linear-gradient(180deg, rgba(122,17,20,.32), rgba(122,17,20,.18));
      color: rgba(243,239,230,.95);
      font-weight: 850;
      cursor: pointer;
      box-shadow: 0 10px 26px rgba(122,17,20,.16);
      transition: filter var(--tFast) ease;
    }
    .send:hover{ filter: brightness(1.06); }
    .send:disabled{
      opacity: .55;
      cursor: not-allowed;
      box-shadow: none;
      filter: none;
    }

    .section{
      border: 1px solid rgba(243,239,230,.14);
      background: rgba(15,13,10,.35);
      border-radius: 14px;
      padding: 10px;
    }
    .section + .section{ margin-top: 10px; }

    .sectionTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 8px;
    }
    .sectionTitle strong{
      font-size: 12.5px;
      color: rgba(243,239,230,.90);
      letter-spacing: .2px;
    }
    .sectionTitle span{
      font-size: 12px;
      color: rgba(243,239,230,.62);
    }

    .kv{ display:flex; flex-direction:column; gap: 8px; }
    .kvRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      padding-top: 6px;
      border-top: 1px dashed rgba(243,239,230,.12);
    }
    .kvRow:first-child{ border-top:none; padding-top:0; }
    .kvKey{
      font-size: 12px;
      color: rgba(243,239,230,.78);
      line-height: 1.25;
      display:flex;
      gap:8px;
      align-items:flex-start;
    }
    .kvVal{
      font-size: 12px;
      color: rgba(243,239,230,.92);
      font-weight: 780;
      text-align:right;
      line-height: 1.25;
      white-space: nowrap;
    }
    .kvSub{
      font-size: 11px;
      color: rgba(243,239,230,.62);
      margin-top: 2px;
    }

    .fileChip{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(243,239,230,.14);
      background: rgba(15,13,10,.30);
      color: rgba(243,239,230,.80);
      font-size: 12px;
    }
    .fileChip small{ color: rgba(243,239,230,.60); }

    .miniBtn{
      border-radius: 999px;
      padding: 7px 10px;
      border: 1px solid rgba(243,239,230,.14);
      background: rgba(20,17,13,.45);
      color: rgba(243,239,230,.90);
      font-weight: 820;
      cursor:pointer;
      user-select:none;
      font-size: 12px;
      transition: background var(--tMed) ease, border-color var(--tMed) ease;
      white-space: nowrap;
    }
    .miniBtn:hover{ border-color: rgba(243,239,230,.22); background: rgba(20,17,13,.62); }
    .miniBtn.danger{
      border-color: rgba(185,28,28,.35);
      background: rgba(185,28,28,.12);
    }
    .miniBtn.danger:hover{
      border-color: rgba(185,28,28,.55);
      background: rgba(185,28,28,.18);
    }

    .fatal{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      background: rgba(0,0,0,.78);
      z-index: 9999;
    }
    .fatalCard{
      width: min(860px, 100%);
      border-radius: 20px;
      border: 1px solid rgba(243,239,230,.18);
      background: rgba(20,17,13,.92);
      box-shadow: 0 22px 80px rgba(0,0,0,.55);
      padding: 14px;
      color: rgba(243,239,230,.90);
    }
    .fatalCard strong{ font-size: 13px; }
    .fatalCard pre{
      margin: 10px 0 0;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(243,239,230,.14);
      background: rgba(11,10,8,.55);
      overflow:auto;
      max-height: 45vh;
      color: rgba(243,239,230,.86);
      font-size: 12px;
      line-height: 1.35;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .drawerBackdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.58);
      display:none;
      z-index: 9000;
    }
    .drawer{
      position: fixed;
      top: 0;
      bottom: 0;
      width: min(92vw, 420px);
      background: rgba(20,17,13,.92);
      border-right: 1px solid rgba(243,239,230,.14);
      box-shadow: 0 22px 80px rgba(0,0,0,.55);
      transform: translateX(-110%);
      transition: transform var(--tMed) ease;
      z-index: 9100;
      padding: 12px;
      overflow:auto;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
    }
    .drawer.right{
      right: 0;
      left: auto;
      border-right: none;
      border-left: 1px solid rgba(243,239,230,.14);
      transform: translateX(110%);
    }
    .drawer.open{ transform: translateX(0); }
    .drawerBackdrop.open{ display:block; }

    @media (max-width: 1080px){
      .app{ grid-template-columns: 300px 1fr; }
      #workspacePanel{ display:none; }
    }
    @media (max-width: 760px){
      .app{ grid-template-columns: 1fr; }
      #leftPanel{ display:none; }
      #workspacePanel{ display:none; }
      header{
        padding: 10px;
        gap: 10px;
      }
      #topSub{ max-width: 42ch; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="app">

      <!-- TOP -->
      <header>
        <div class="brand">
          <div class="logo" aria-hidden="true">W</div>
          <div class="brandText">
            <div class="catRow">
              <strong>WilliamBot</strong>
              <span class="catBadge biz" id="catBadge" aria-label="Active category">
                <span class="miniDot" aria-hidden="true"></span>
                <span id="catText">Business</span>
              </span>
            </div>
            <span id="topSub">Session: —</span>
          </div>
        </div>

        <div class="statusRow" aria-label="Status">
          <div class="badge clickable" id="profileBadge" title="Profile is stored per session" role="button" tabindex="0">
            <span class="label">Profile</span>
            <span id="profileText">Study</span>
          </div>

          <div class="badge clickable" id="notionBadge" title="Notion sync placeholder (wire later)" role="button" tabindex="0">
            <span id="notionDot" class="dot bad" aria-hidden="true"></span>
            <span class="label">Notion</span>
            <span id="notionText">Not connected</span>
          </div>

          <div class="badge" title="Local backend connection">
            <span id="engineDot" class="dot bad" aria-hidden="true"></span>
            <span class="label">Engine</span>
            <span id="engineText">UI only</span>
          </div>

          <button class="ghostBtn" id="openSessions" aria-haspopup="dialog">Sessions</button>
          <button class="ghostBtn" id="openWorkspace" aria-haspopup="dialog">Workspace</button>
        </div>
      </header>

      <!-- LEFT: SESSIONS (desktop/tablet) -->
      <aside class="panel" id="leftPanel" aria-label="Sessions panel">
        <div class="panelHeader">
          <div>
            <strong>Sessions</strong>
            <small><span id="sessionCount">0</span> total • <span id="activeLabel">Active: —</span></small>

            <div class="segRow" role="tablist" aria-label="Session groups">
              <button class="seg active" id="tabBiz" role="tab" aria-selected="true">Business</button>
              <button class="seg" id="tabSchool" role="tab" aria-selected="false">School</button>
              <button class="seg" id="tabPersonal" role="tab" aria-selected="false">Personal</button>
            </div>
          </div>

          <div style="display:flex; gap:8px; align-items:center;">
            <button class="miniBtn" id="newSessionBtn" title="Create a new session">New</button>
          </div>
        </div>

        <div class="panelBody">
          <div class="list" id="sessionList"></div>
        </div>
      </aside>

      <!-- CENTER: CHAT -->
      <main class="chat bizBg" id="chatShell" aria-label="Chat">
        <div class="feed" id="feed" aria-live="polite" aria-relevant="additions text"></div>

        <div class="composer">
          <div class="warn" id="contextWarn"></div>

          <!-- Attach chips row -->
          <div class="chipsRow" id="chipsRow" style="display:none;">
            <button class="chipBtn" id="attachBtn" title="Attach context for the next message">Attach</button>
            <div id="chipList" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
          </div>

          <div class="composerRow">
            <label class="srOnly" for="input">Message</label>
            <textarea id="input" placeholder="Ask, calculate, study… (Enter to send, Shift+Enter new line)"></textarea>
            <button class="send" id="sendBtn" disabled>Send</button>
          </div>
        </div>
      </main>

      <!-- RIGHT: WORKSPACE (desktop only; mobile uses drawer) -->
      <aside class="panel" id="workspacePanel" aria-label="Workspace panel">
        <div class="panelHeader">
          <div>
            <strong>Workspace</strong>
            <small id="wsSubtitle">Session-bound state</small>
          </div>
          <span id="wsHint" style="font-size:12px; color: rgba(243,239,230,.62);">—</span>
        </div>
        <div class="panelBody" id="workspaceBody"></div>
      </aside>

    </div>
  </div>

  <!-- Mobile drawers -->
  <div class="drawerBackdrop" id="drawerBackdrop"></div>

  <div class="drawer" id="sessionsDrawer" aria-hidden="true" role="dialog" aria-label="Sessions drawer">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <strong>Sessions</strong>
      <button class="miniBtn" id="closeSessionsDrawer">Close</button>
    </div>

    <div class="segRow" style="margin-top:12px;">
      <button class="seg active" id="drawerTabBiz">Business</button>
      <button class="seg" id="drawerTabSchool">School</button>
      <button class="seg" id="drawerTabPersonal">Personal</button>
    </div>

    <div class="rowBtns" style="margin-top:10px;">
      <button class="miniBtn" id="drawerNewSession">New session</button>
    </div>

    <div class="list" id="drawerSessionList" style="margin-top:12px;"></div>
  </div>

  <div class="drawer right" id="workspaceDrawer" aria-hidden="true" role="dialog" aria-label="Workspace drawer">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <strong>Workspace</strong>
      <button class="miniBtn" id="closeWorkspaceDrawer">Close</button>
    </div>
    <div id="drawerWorkspaceBody" style="margin-top:12px;"></div>
  </div>

  <!-- Attach Context Drawer (right side) -->
  <div class="drawer right" id="attachDrawer" aria-hidden="true" role="dialog" aria-label="Attach context drawer">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <strong>Attach Context</strong>
      <button class="miniBtn" id="closeAttachDrawer">Close</button>
    </div>
    <div style="margin-top:10px; color: rgba(243,239,230,.75); font-size:12px; line-height:1.35;">
      Personal can attach from Business + School. Attachments apply to the <strong>next message only</strong> and then auto-clear.
    </div>

    <div class="section" style="margin-top:12px;">
      <div class="sectionTitle">
        <strong>Available sessions</strong>
        <span>Business + School</span>
      </div>
      <div class="list" id="attachSessionList"></div>
    </div>
  </div>

  <!-- Fatal overlay -->
  <div class="fatal" id="fatal">
    <div class="fatalCard" role="dialog" aria-label="Crash report">
      <strong>WilliamBot UI crashed (no silent white screen).</strong>
      <div style="margin-top:6px; color: rgba(243,239,230,.75); font-size:12px;">
        Copy the error, refresh, and you’re back.
      </div>
      <pre id="fatalText"></pre>
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:10px;">
        <button class="miniBtn" id="fatalCopy">Copy error</button>
        <button class="miniBtn" id="fatalClose">Close</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      "use strict";

      // -------------------- Crash safety --------------------
      const fatalEl = document.getElementById("fatal");
      const fatalText = document.getElementById("fatalText");
      const fatalCopy = document.getElementById("fatalCopy");
      const fatalClose = document.getElementById("fatalClose");

      function showFatal(err){
        try{
          const msg = (err && err.stack) ? err.stack : String(err);
          fatalText.textContent = msg;
          fatalEl.style.display = "flex";
        } catch {}
      }
      window.addEventListener("error", (e) => showFatal(e.error || e.message || e), true);
      window.addEventListener("unhandledrejection", (e) => showFatal(e.reason || e), true);

      fatalCopy.addEventListener("click", async () => {
        try{ await navigator.clipboard.writeText(fatalText.textContent || ""); } catch {}
      });
      fatalClose.addEventListener("click", () => { fatalEl.style.display = "none"; });

      // -------------------- DOM helpers --------------------
      const $ = (id) => document.getElementById(id);

      const escapeHtml = (s) =>
        String(s).replace(/[&<>"']/g, c => ({
          "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
        }[c]));

      function stamp(){
        const d = new Date();
        return d.toLocaleString([], {month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit"});
      }
      function nowTime(){
        const d = new Date();
        return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
      }
      function uid(){
        return "s_" + Math.random().toString(36).slice(2, 8) + "_" + Date.now().toString(36).slice(-4);
      }
      function setDot(el, state){
        el.classList.remove("ok","bad");
        if(state === "ok") el.classList.add("ok");
        if(state === "bad") el.classList.add("bad");
      }
      function safeParse(json, fallback){
        try { return JSON.parse(json); } catch { return fallback; }
      }

      // -------------------- Storage --------------------
      const STORE = {
        sessions: "wb_sessions_v8",
        historyPrefix: "wb_history_v8_",

        activeGroup: "wb_active_group_v8",                   // "business" | "school" | "personal"
        activeBiz: "wb_active_session_business_v8",
        activeSchool: "wb_active_session_school_v8",
        activePersonal: "wb_active_session_personal_v8",

        profilePrefix: "wb_profile_v8_"                      // per-session profile
      };
      const historyKey = (sid) => STORE.historyPrefix + sid;
      const profileKey = (sid) => STORE.profilePrefix + sid;

      // -------------------- Default sessions --------------------
      function defaultSessions(){
        return [
          {
            id: "personal_main",
            group: "personal",
            title: "Personal — Main",
            note: "Normal chat • planning • pull from Business/School when needed",
            updated: stamp(),
            files: []
          },
          {
            id: "biz_main",
            group: "business",
            title: "Business — Pricing & Ops",
            note: "COGS • margins • Amazon/Shopify • decision ledger",
            updated: stamp(),
            files: [
              { name: "Products & SKUs (local)", desc: "Later: Notion + invoices + COGS tables" },
              { name: "Pricing guardrails (local)", desc: "Margin floors • fees • shipping • overhead" }
            ]
          },
          {
            id: "math107",
            group: "school",
            title: "UMGC — MATH 107 (College Algebra)",
            note: "Syllabus PDF • homework help • study plan",
            updated: stamp(),
            files: [{ name: "MATH_107_...Spring_2026.pdf", desc: "Syllabus (uploaded)" }]
          },
          {
            id: "hist125",
            group: "school",
            title: "UMGC — HIST 125 (Technological Transformations)",
            note: "Syllabus PDF • readings • discussion prep",
            updated: stamp(),
            files: [{ name: "HIST_125_...Spring_2026.pdf", desc: "Syllabus (uploaded)" }]
          }
        ];
      }

      function loadSessions(){
        const raw = localStorage.getItem(STORE.sessions);
        const parsed = safeParse(raw, null);
        if(Array.isArray(parsed) && parsed.length) return parsed;

        const s = defaultSessions();
        localStorage.setItem(STORE.sessions, JSON.stringify(s));
        return s;
      }
      function saveSessions(sessions){
        localStorage.setItem(STORE.sessions, JSON.stringify(sessions));
      }
      function loadHistory(sid){
        const raw = localStorage.getItem(historyKey(sid));
        const parsed = safeParse(raw, []);
        return Array.isArray(parsed) ? parsed : [];
      }
      function saveHistory(sid, hist){
        localStorage.setItem(historyKey(sid), JSON.stringify(hist.slice(-800)));
      }

      // -------------------- Group + Active session (per group) --------------------
      function getActiveGroup(){
        return localStorage.getItem(STORE.activeGroup) || "personal";
      }
      function setActiveGroup(g){
        localStorage.setItem(STORE.activeGroup, g);
      }
      function keyForGroup(group){
        if(group === "business") return STORE.activeBiz;
        if(group === "school") return STORE.activeSchool;
        return STORE.activePersonal;
      }
      function getActiveSessionIdForGroup(group){
        return localStorage.getItem(keyForGroup(group)) || "";
      }
      function setActiveSessionIdForGroup(group, id){
        localStorage.setItem(keyForGroup(group), id);
      }

      // -------------------- Profiles (PER SESSION) --------------------
      const PROFILE_BUS = ["Financial", "Ops", "Strategy", "Formulation", "Compliance"];
      const PROFILE_SCHOOL = ["Study", "Writing", "Math", "Research"];
      const PROFILE_PERSONAL = ["General", "Planning", "Life", "Fitness"];

      function profileListForSession(session){
        if(session.group === "business") return PROFILE_BUS;
        if(session.group === "school") return PROFILE_SCHOOL;
        return PROFILE_PERSONAL;
      }
      function getProfileForSession(session){
        const stored = localStorage.getItem(profileKey(session.id));
        const list = profileListForSession(session);
        if(stored && list.includes(stored)) return stored;
        if(session.group === "business") return "Financial";
        if(session.group === "school") return "Study";
        return "General";
      }
      function setProfileForSession(session, profile){
        localStorage.setItem(profileKey(session.id), profile);
        $("profileText").textContent = profile;
      }
      function cycleProfileForSession(session){
        const list = profileListForSession(session);
        const cur = getProfileForSession(session);
        const idx = Math.max(0, list.indexOf(cur));
        const next = list[(idx + 1) % list.length];
        setProfileForSession(session, next);
      }

      // -------------------- UI elements --------------------
      const feed = $("feed");
      const input = $("input");
      const sendBtn = $("sendBtn");
      const topSub = $("topSub");
      const sessionCount = $("sessionCount");
      const activeLabel = $("activeLabel");

      const sessionList = $("sessionList");

      const tabBiz = $("tabBiz");
      const tabSchool = $("tabSchool");
      const tabPersonal = $("tabPersonal");

      const drawerTabBiz = $("drawerTabBiz");
      const drawerTabSchool = $("drawerTabSchool");
      const drawerTabPersonal = $("drawerTabPersonal");

      const backdrop = $("drawerBackdrop");
      const sessionsDrawer = $("sessionsDrawer");
      const workspaceDrawer = $("workspaceDrawer");
      const attachDrawer = $("attachDrawer");

      const drawerSessionList = $("drawerSessionList");
      const attachSessionList = $("attachSessionList");

      const wsHint = $("wsHint");
      const wsSubtitle = $("wsSubtitle");
      const workspaceBody = $("workspaceBody");
      const drawerWorkspaceBody = $("drawerWorkspaceBody");

      const notionDot = $("notionDot");
      const engineDot = $("engineDot");

      const catBadge = $("catBadge");
      const catText = $("catText");
      const chatShell = $("chatShell");

      const contextWarn = $("contextWarn");

      // Attach UI
      const chipsRow = $("chipsRow");
      const chipList = $("chipList");
      const attachBtn = $("attachBtn");

      // -------------------- State --------------------
      let sessions = loadSessions();
      saveSessions(sessions);

      let history = [];

      // Next-message attachments (AUTO-CLEAR after send)
      // rule: only allowed in Personal, and only sessions from Business + School
      let nextAttachments = []; // array of session IDs

      function sessionsByGroup(group){
        return sessions.filter(s => s.group === group);
      }
      function firstSessionId(group){
        const list = sessionsByGroup(group);
        return list.length ? list[0].id : "";
      }

      function currentSession(){
        const sid = getActiveSessionIdForGroup(getActiveGroup());
        return sessions.find(s => s.id === sid) || null;
      }

      function setCategoryUI(group){
        catBadge.classList.remove("biz","school","personal");
        chatShell.classList.remove("bizBg","schoolBg","personalBg");

        if(group === "business"){
          catBadge.classList.add("biz");
          chatShell.classList.add("bizBg");
          catText.textContent = "Business";
        } else if(group === "school"){
          catBadge.classList.add("school");
          chatShell.classList.add("schoolBg");
          catText.textContent = "School";
        } else {
          catBadge.classList.add("personal");
          chatShell.classList.add("personalBg");
          catText.textContent = "Personal";
        }
      }

      function setTopSubText(){
        const s = currentSession();
        topSub.textContent = "Session: " + (s ? s.title : "—");
      }

      function setTabsUI(group){
        tabBiz.classList.toggle("active", group === "business");
        tabSchool.classList.toggle("active", group === "school");
        tabPersonal.classList.toggle("active", group === "personal");

        tabBiz.setAttribute("aria-selected", group === "business" ? "true" : "false");
        tabSchool.setAttribute("aria-selected", group === "school" ? "true" : "false");
        tabPersonal.setAttribute("aria-selected", group === "personal" ? "true" : "false");

        tabBiz.classList.remove("schoolActive","personalActive");
        tabSchool.classList.remove("schoolActive","personalActive");
        tabPersonal.classList.remove("schoolActive","personalActive");

        if(group === "school") tabSchool.classList.add("schoolActive");
        if(group === "personal") tabPersonal.classList.add("personalActive");

        drawerTabBiz.classList.toggle("active", group === "business");
        drawerTabSchool.classList.toggle("active", group === "school");
        drawerTabPersonal.classList.toggle("active", group === "personal");

        drawerTabBiz.classList.remove("schoolActive","personalActive");
        drawerTabSchool.classList.remove("schoolActive","personalActive");
        drawerTabPersonal.classList.remove("schoolActive","personalActive");

        if(group === "school") drawerTabSchool.classList.add("schoolActive");
        if(group === "personal") drawerTabPersonal.classList.add("personalActive");
      }

      function sessionPillText(s){
        const cs = currentSession();
        const active = cs && s.id === cs.id;
        if(active) return "Active";
        if(s.group === "school") return "Class";
        if(s.group === "personal") return "Personal";
        return "Business";
      }

      function renderSessionListInto(el, group){
        el.innerHTML = "";
        const filtered = sessionsByGroup(group);
        const cs = currentSession();

        if(filtered.length === 0){
          const empty = document.createElement("div");
          empty.style.color = "rgba(243,239,230,.62)";
          empty.style.fontSize = "12px";
          empty.textContent = "No sessions yet.";
          el.appendChild(empty);
          return;
        }

        for(const s of filtered){
          const div = document.createElement("div");
          div.className = "item" + ((cs && s.id === cs.id) ? " active" : "");
          div.innerHTML = `
            <div class="itemTop">
              <div class="itemTitle">${escapeHtml(s.title)}</div>
              <span class="pillMini">${escapeHtml(sessionPillText(s))}</span>
            </div>
            <div class="itemMeta">
              ${escapeHtml(s.note || "")}<br/>
              <span style="color: rgba(243,239,230,.58)">Updated: ${escapeHtml(s.updated || "—")}</span>
            </div>

            <div class="rowBtns">
              <button class="miniBtn" data-act="activate" data-id="${escapeHtml(s.id)}">Open</button>
              <button class="miniBtn" data-act="rename" data-id="${escapeHtml(s.id)}">Rename</button>
              <button class="miniBtn danger" data-act="delete" data-id="${escapeHtml(s.id)}">Delete</button>
            </div>
          `;
          el.appendChild(div);
        }
      }

      function renderAttachChips(){
        const cs = currentSession();
        if(!cs){
          chipsRow.style.display = "none";
          return;
        }

        // Attach UI visible only in Personal
        if(cs.group !== "personal"){
          chipsRow.style.display = "none";
          nextAttachments = [];
          chipList.innerHTML = "";
          return;
        }

        chipsRow.style.display = "flex";
        chipList.innerHTML = "";

        for(const sid of nextAttachments){
          const s = sessions.find(x => x.id === sid);
          if(!s) continue;

          const chip = document.createElement("div");
          chip.className = "chip";
          chip.innerHTML = `
            <span style="opacity:.75;">Attached:</span>
            <strong title="${escapeHtml(s.title)}">${escapeHtml(s.title)}</strong>
            <button class="chipX" data-chip-x="${escapeHtml(sid)}" aria-label="Remove attachment">×</button>
          `;
          chipList.appendChild(chip);
        }
      }

      function renderSessions(){
        const group = getActiveGroup();
        setTabsUI(group);
        setCategoryUI(group);

        sessionCount.textContent = String(sessions.length);

        const cs = currentSession();
        activeLabel.textContent = cs ? cs.title : "—";

        renderSessionListInto(sessionList, group);
        renderSessionListInto(drawerSessionList, group);

        setTopSubText();

        if(cs) $("profileText").textContent = getProfileForSession(cs);

        renderAttachChips();
      }

      // -------------------- Activation + Group switching --------------------
      function activateSession(id, opts){
        opts = opts || {};
        const s = sessions.find(x => x.id === id);
        if(!s) return;

        setActiveGroup(s.group);
        setActiveSessionIdForGroup(s.group, s.id);

        // When leaving personal, clear attachments
        if(s.group !== "personal"){
          nextAttachments = [];
        }

        $("profileText").textContent = getProfileForSession(s);

        loadThread();
        hydrateWorkspace();
        renderSessions();

        if(!opts.keepDrawersOpen) closeDrawer("sessions");
      }

      function activateSessionForGroup(group){
        const last = getActiveSessionIdForGroup(group);
        const exists = last && sessions.some(s => s.id === last && s.group === group);
        const pick = exists ? last : firstSessionId(group);

        setActiveGroup(group);

        if(pick){
          activateSession(pick, { keepDrawersOpen: true });
        } else {
          loadThreadEmpty(group);
          hydrateWorkspaceEmpty(group);
          renderSessions();
        }
      }

      // -------------------- CRUD sessions --------------------
      function createSession(group){
        const newId = uid();

        let title, note;
        if(group === "business"){
          title = "Business — New Session";
          note = "Pricing • ops • planning";
        } else if(group === "school"){
          title = "UMGC — New Class Session";
          note = "Study plan • assignments • notes";
        } else {
          title = "Personal — New Session";
          note = "Normal chat • planning";
        }

        const sess = { id: newId, group, title, note, updated: stamp(), files: [] };

        sessions = [sess, ...sessions];
        saveSessions(sessions);

        saveHistory(newId, [introForSession(sess)]);
        localStorage.setItem(profileKey(newId), getProfileForSession(sess));

        activateSession(newId);
      }

      function renameSession(id){
        const s = sessions.find(x => x.id === id);
        if(!s) return;

        const next = prompt("Rename session:", s.title);
        if(!next) return;

        s.title = next.trim().slice(0, 90) || s.title;
        s.updated = stamp();
        saveSessions(sessions);

        renderSessions();
        hydrateWorkspace();
      }

      function deleteSession(id){
        const s = sessions.find(x => x.id === id);
        if(!s) return;

        const protectedIds = new Set(["biz_main","math107","hist125","personal_main"]);
        if(protectedIds.has(id)){
          alert("That session is protected (default). Create new ones and delete those instead.");
          return;
        }

        const ok = confirm("Delete this session? This removes its chat history from this browser.");
        if(!ok) return;

        const group = s.group;
        sessions = sessions.filter(x => x.id !== id);
        saveSessions(sessions);

        try{ localStorage.removeItem(historyKey(id)); } catch {}
        try{ localStorage.removeItem(profileKey(id)); } catch {}

        // Remove from attachments if present
        nextAttachments = nextAttachments.filter(x => x !== id);

        const activeInGroup = getActiveSessionIdForGroup(group);
        if(activeInGroup === id){
          const fallback = firstSessionId(group);
          if(fallback) {
            setActiveSessionIdForGroup(group, fallback);
            if(getActiveGroup() === group) activateSession(fallback, { keepDrawersOpen:true });
          } else {
            if(getActiveGroup() === group){
              loadThreadEmpty(group);
              hydrateWorkspaceEmpty(group);
              renderSessions();
            }
          }
        } else {
          renderSessions();
        }
      }

      // -------------------- Chat --------------------
      function renderMessage(m){
        const row = document.createElement("div");
        row.className = "row " + (m.role === "you" ? "you" : "bot");

        const wrap = document.createElement("div");
        wrap.className = "bubbleWrap";

        const bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.textContent = m.content || "";

        const meta = document.createElement("div");
        meta.className = "meta";

        const who = document.createElement("span");
        who.textContent = m.role === "you" ? "You" : "WilliamBot";

        const conf = document.createElement("span");
        conf.className = "confidence";

        const dot = document.createElement("span");
        dot.className = "confDot " + (m.confidence || "y");

        const label = document.createElement("span");
        label.textContent = (m.confidence === "g") ? "High" : (m.confidence === "r") ? "Low" : "Medium";

        const time = document.createElement("span");
        time.style.opacity = ".65";
        time.textContent = "• " + (m.ts || nowTime());

        conf.appendChild(dot);
        conf.appendChild(label);
        conf.appendChild(time);

        meta.appendChild(who);
        meta.appendChild(conf);

        wrap.appendChild(bubble);

        // If the user message had attachments, show a tiny line under bubble
        if(m.role === "you" && Array.isArray(m.attachments) && m.attachments.length){
          const att = document.createElement("div");
          att.style.fontSize = "11px";
          att.style.opacity = ".72";
          att.style.marginTop = "6px";
          att.textContent = "Attached: " + m.attachments
            .map(sid => (sessions.find(x => x.id === sid)?.title || sid))
            .join(" • ");
          wrap.appendChild(att);
        }

        wrap.appendChild(meta);

        row.appendChild(wrap);
        feed.appendChild(row);

        feed.scrollTop = feed.scrollHeight;
      }

      function introForSession(session){
        if(session.group === "business"){
          return {
            role:"bot",
            confidence:"y",
            ts: nowTime(),
            content:
`Business session loaded.

When backend connects:
• COGS-aware pricing & margin math
• Channel fees (Amazon/Shopify) + shipping + overhead allocation
• Decision ledger for traceable pricing changes
• RAG for product specs, invoices, policies

Try:
- "Build pricing guardrails"
- "List inputs needed to lock MSRP"
- "Create a decision ledger template"`
          };
        }
        if(session.group === "school"){
          return {
            role:"bot",
            confidence:"y",
            ts: nowTime(),
            content:
`Class session loaded.

When backend connects:
• Read syllabus PDF and extract deadlines + grading
• Build weekly plan + checklists
• Explain concepts and help structure drafts

Try:
- "Summarize grading breakdown"
- "Extract deadlines into a checklist"
- "Explain this topic like I'm new"`
          };
        }
        return {
          role:"bot",
          confidence:"y",
          ts: nowTime(),
          content:
`Personal session loaded.

Rules:
• Personal can attach context from Business + School
• Attachments apply to the next message only (auto-clear)
• No automatic cross-session mixing

Try:
- "Attach Business and remind me what we decided last time"
- "Attach School and list my next deadlines"`
        };
      }

      function loadThread(){
        const cs = currentSession();
        feed.innerHTML = "";
        contextWarn.style.display = "none";
        contextWarn.textContent = "";

        if(!cs){
          loadThreadEmpty(getActiveGroup());
          return;
        }

        history = loadHistory(cs.id);
        if(history.length === 0){
          const intro = introForSession(cs);
          history.push(intro);
          saveHistory(cs.id, history);
        }

        for(const m of history) renderMessage(m);
      }

      function loadThreadEmpty(group){
        feed.innerHTML = "";
        contextWarn.style.display = "none";
        contextWarn.textContent = "";

        const msg = {
          role:"bot",
          confidence:"y",
          ts: nowTime(),
          content:
(group === "business")
? "No Business sessions exist yet. Tap **New** to create one."
: (group === "school")
? "No School sessions exist yet. Tap **New session** to create one."
: "No Personal sessions exist yet. Tap **New session** to create one."
        };
        renderMessage(msg);
        history = [];
      }

      function addToHistory(m){
        const cs = currentSession();
        if(!cs) return;
        history.push(m);
        saveHistory(cs.id, history);
      }

      function syncSendButton(){
        sendBtn.disabled = input.value.trim().length === 0 || !currentSession();
      }

      function autoSizeTextarea(){
        input.style.height = "auto";
        input.style.height = Math.min(input.scrollHeight, 220) + "px";
      }

      // -------------------- Context safeguards --------------------
      const SCHOOL_HINTS = ["syllabus","assignment","homework","quiz","discussion post","apa","citation","umgc","grade","module","week"];
      const BIZ_HINTS = ["cogs","margin","msrp","sku","shopify","amazon","fba","fbm","overhead","fees","pricing","profit","inventory","supplier"];

      function maybeWarnAboutContext(text){
        const cs = currentSession();
        if(!cs) return;

        // No warning in Personal. Personal is allowed to talk about anything.
        if(cs.group === "personal"){
          contextWarn.style.display = "none";
          contextWarn.textContent = "";
          return;
        }

        const t = String(text || "").toLowerCase();
        const looksSchool = SCHOOL_HINTS.some(k => t.includes(k));
        const looksBiz = BIZ_HINTS.some(k => t.includes(k));

        if(cs.group === "business" && looksSchool && !looksBiz){
          contextWarn.innerHTML = `<strong>Context check:</strong> This looks like School content, but you’re in a Business session. Switch tabs if that’s accidental.`;
          contextWarn.style.display = "block";
          return;
        }

        if(cs.group === "school" && looksBiz && !looksSchool){
          contextWarn.innerHTML = `<strong>Context check:</strong> This looks like Business content, but you’re in a School session. Switch tabs if that’s accidental.`;
          contextWarn.style.display = "block";
          return;
        }

        contextWarn.style.display = "none";
        contextWarn.textContent = "";
      }

      // -------------------- Attach Context logic --------------------
      function canUseAttach(){
        const cs = currentSession();
        return !!cs && cs.group === "personal";
      }

      function allowedAttachSessions(){
        // Smart restriction: Personal can attach ONLY from Business + School
        return sessions
          .filter(s => (s.group === "business" || s.group === "school"))
          .sort((a,b) => (a.group === b.group)
            ? String(a.title).localeCompare(String(b.title))
            : String(a.group).localeCompare(String(b.group)));
      }

      function openAttachDrawer(){
        if(!canUseAttach()) return;

        attachSessionList.innerHTML = "";
        const avail = allowedAttachSessions();
        if(avail.length === 0){
          attachSessionList.innerHTML = `<div style="color: rgba(243,239,230,.62); font-size:12px;">No Business/School sessions available.</div>`;
          openDrawer("attach");
          return;
        }

        for(const s of avail){
          const already = nextAttachments.includes(s.id);
          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = `
            <div class="itemTop">
              <div class="itemTitle">${escapeHtml(s.title)}</div>
              <span class="pillMini">${escapeHtml(s.group === "school" ? "School" : "Business")}</span>
            </div>
            <div class="itemMeta">${escapeHtml(s.note || "")}</div>
            <div class="rowBtns">
              <button class="miniBtn" data-attach-add="${escapeHtml(s.id)}">${already ? "Attached" : "Attach"}</button>
            </div>
          `;
          attachSessionList.appendChild(div);
        }

        openDrawer("attach");
      }

      function attachSession(sid){
        if(!canUseAttach()) return;

        const s = sessions.find(x => x.id === sid);
        if(!s) return;

        // enforce rule
        if(!(s.group === "business" || s.group === "school")) return;

        // allow multiple, but you can keep it 1 if you want
        if(!nextAttachments.includes(sid)){
          nextAttachments.push(sid);
        }

        renderAttachChips();
        // refresh attach list to show "Attached"
        openAttachDrawer();
      }

      function removeAttachment(sid){
        nextAttachments = nextAttachments.filter(x => x !== sid);
        renderAttachChips();
      }

      function clearAttachments(){
        nextAttachments = [];
        renderAttachChips();
      }

      // -------------------- Send message (with auto-clear attachments) --------------------
      function sendMessage(){
        const cs = currentSession();
        if(!cs) return;

        const text = input.value.trim();
        if(!text) return;

        maybeWarnAboutContext(text);

        input.value = "";
        autoSizeTextarea();
        syncSendButton();

        // record attachments ONLY for this outgoing message
        const attachmentsForThisMsg = (cs.group === "personal") ? nextAttachments.slice() : [];

        const youMsg = {
          role:"you",
          confidence:"g",
          ts: nowTime(),
          content: text,
          attachments: attachmentsForThisMsg
        };
        renderMessage(youMsg);
        addToHistory(youMsg);

        // AUTO-CLEAR after send (your requirement)
        if(cs.group === "personal"){
          clearAttachments();
        }

        cs.updated = stamp();
        saveSessions(sessions);
        renderSessions();

        // UI-only canned reply
        let reply;
        if(cs.group === "business"){
          reply =
`UI-only mode (backend not connected).

When backend is live, I will:
• compute margins step-by-step
• use your real COGS/fees/shipping
• store decisions in a ledger

Pick next:
1) MSRP guardrails
2) MSRP inputs list
3) Decision ledger format`;
        } else if(cs.group === "school"){
          reply =
`UI-only mode (backend not connected).

When backend is live, I will:
• parse the syllabus PDF
• extract deadlines + grading
• build a weekly plan

Pick next:
1) Weekly plan
2) Deadlines checklist
3) Concept help`;
        } else {
          reply =
`UI-only mode (backend not connected).

Personal rules enforced:
• Attachments were applied to that one message (if any)
• They auto-cleared after send
• No cross-session mixing unless you attach

Try:
- Click Attach, pick a Business/School session, then ask your question.`;
        }

        const botMsg = { role:"bot", confidence:"y", ts: nowTime(), content: reply };
        renderMessage(botMsg);
        addToHistory(botMsg);
      }

      // -------------------- Workspace --------------------
      function categoryFiles(group){
        const out = [];
        for(const s of sessionsByGroup(group)){
          const files = Array.isArray(s.files) ? s.files : [];
          for(const f of files){
            out.push({
              sessionTitle: s.title,
              sessionId: s.id,
              name: f.name || "Untitled",
              desc: f.desc || ""
            });
          }
        }
        return out;
      }

      function workspaceTemplate(session){
        const isBiz = session.group === "business";
        const isSchool = session.group === "school";
        const isPersonal = session.group === "personal";

        wsHint.textContent = session.id.toUpperCase();
        wsSubtitle.textContent = (isBiz ? "Business state" : isSchool ? "Class state" : "Personal state") + " • " + stamp();

        const files = session.files || [];
        const fileRows = files.map(f => `
          <div class="fileChip">
            <div>
              <div style="font-weight:850; color: rgba(243,239,230,.92);">${escapeHtml(f.name)}</div>
              <small>${escapeHtml(f.desc || "")}</small>
            </div>
            <button class="miniBtn" data-ws="open">Open</button>
          </div>
        `).join("");

        const assumptions = isBiz
          ? [
              { k:"Target gross margin", v:"≥ 70%", sub:"Luxury guardrail", c:"g" },
              { k:"Channels", v:"Amazon + Shopify", sub:"Different fees, same COGS base", c:"g" },
              { k:"Fee risk", v:"Verify category", sub:"Amazon referral/fulfillment vary", c:"y" },
              { k:"COGS freshness", v:"Notion not connected", sub:"Avoid locking MSRP without data", c:"r" }
            ]
          : isSchool
          ? [
              { k:"Syllabus", v:"Mounted (PDF)", sub:"Use for deadlines + grading policy", c:"g" },
              { k:"Weekly plan", v:"Build cadence", sub:"Make it automatic later", c:"y" },
              { k:"Notes", v:"Structured", sub:"Definitions • examples • self-test", c:"g" }
            ]
          : [
              { k:"Scope", v:"General", sub:"Personal can talk about anything", c:"g" },
              { k:"Attachments", v:"Manual only", sub:"Attach Business/School per message", c:"g" },
              { k:"Auto-clear", v:"Enabled", sub:"Attachments clear after send", c:"g" }
            ];

        const assRows = assumptions.map(a => `
          <div class="kvRow">
            <div>
              <div class="kvKey">
                <span class="confDot ${a.c}" style="transform: translateY(2px);"></span>
                <div>
                  <div>${escapeHtml(a.k)}</div>
                  <div class="kvSub">${escapeHtml(a.sub || "")}</div>
                </div>
              </div>
            </div>
            <div class="kvVal">${escapeHtml(a.v)}</div>
          </div>
        `).join("");

        const actions = isBiz ? `
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="miniBtn" data-ws="guardrails">Pricing guardrails</button>
            <button class="miniBtn" data-ws="inputs">MSRP inputs list</button>
            <button class="miniBtn" data-ws="ledger">Decision ledger</button>
          </div>
        ` : isSchool ? `
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="miniBtn" data-ws="plan">Weekly plan</button>
            <button class="miniBtn" data-ws="deadlines">Extract deadlines</button>
            <button class="miniBtn" data-ws="notes">Study notes</button>
          </div>
        ` : `
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="miniBtn" data-ws="personalTips">Personal tips</button>
            <button class="miniBtn" data-ws="attachHelp">Attach context help</button>
          </div>
        `;

        const rag = `
          <div class="section">
            <div class="sectionTitle">
              <strong>Knowledge (RAG)</strong>
              <span>Local-only</span>
            </div>
            <div style="color: rgba(243,239,230,.72); font-size:12px; line-height:1.35;">
              Where syllabi, notes, invoices, specs, and policies live for retrieval.
              <br/>UI today; backend will index files later.
            </div>
            <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
              <button class="miniBtn" data-ws="ragAdd">Add document</button>
              <button class="miniBtn" data-ws="ragReindex">Re-index</button>
            </div>
          </div>
        `;

        return `
          <div class="section">
            <div class="sectionTitle">
              <strong>Active session</strong>
              <span>${escapeHtml(session.updated || "")}</span>
            </div>
            <div style="color: rgba(243,239,230,.86); font-size:12.5px; line-height:1.35;">
              <div style="font-weight:900; color: rgba(243,239,230,.94);">${escapeHtml(session.title)}</div>
              <div style="margin-top:4px; color: rgba(243,239,230,.70);">${escapeHtml(session.note || "")}</div>
            </div>
            <div style="margin-top:10px;">${actions}</div>
          </div>

          <div class="section">
            <div class="sectionTitle">
              <strong>Mounted files (this session)</strong>
              <span>${files.length} items</span>
            </div>
            <div style="display:flex; flex-direction:column; gap:8px;">
              ${fileRows || `<div style="color: rgba(243,239,230,.62); font-size:12px;">No files yet.</div>`}
            </div>
          </div>

          <div class="section">
            <div class="sectionTitle">
              <strong>All files (${escapeHtml(session.group)})</strong>
              <span>${categoryFiles(session.group).length} total</span>
            </div>
            <div style="display:flex; flex-direction:column; gap:8px;">
              ${(categoryFiles(session.group).length ? categoryFiles(session.group).map(f => `
                <div class="fileChip">
                  <div>
                    <div style="font-weight:850; color: rgba(243,239,230,.92);">${escapeHtml(f.name)}</div>
                    <small>${escapeHtml(f.sessionTitle)} • ${escapeHtml(f.desc)}</small>
                  </div>
                  <button class="miniBtn" data-ws="open">Open</button>
                </div>
              `).join("") : `<div style="color: rgba(243,239,230,.62); font-size:12px;">No files in this category yet.</div>`)}
            </div>
          </div>

          <div class="section">
            <div class="sectionTitle">
              <strong>Working assumptions</strong>
              <span>${escapeHtml(getProfileForSession(session))}</span>
            </div>
            <div class="kv">${assRows}</div>
          </div>

          ${rag}
        `;
      }

      function hydrateWorkspace(){
        const cs = currentSession();
        if(!cs){
          hydrateWorkspaceEmpty(getActiveGroup());
          return;
        }

        const html = workspaceTemplate(cs);
        workspaceBody.innerHTML = html;
        drawerWorkspaceBody.innerHTML = html;
      }

      function onWorkspaceClick(e){
        const btn = e.target.closest("[data-ws]");
        if(!btn) return;

        const act = btn.getAttribute("data-ws");
        const s = currentSession();
        if(!s) return;

        const canned = (function(){
          if(s.group === "business"){
            if(act === "guardrails") return
`Pricing guardrails (UI preview):
• Don’t lock MSRP until COGS + packaging + shipping + fees are verified.
• Keep gross margin floor ≥ 70% (luxury guardrail).
• Separate prices by channel (Amazon fees vs Shopify).
• Log every price change in a decision ledger.`;
            if(act === "inputs") return
`MSRP inputs list (UI preview):
1) Unit ingredient cost (COGS)
2) Packaging unit cost (jar/bottle + label + shrink + box)
3) Avg shipping + worst-case shipping
4) Channel fees (Amazon referral/FBA; Shopify payment fees)
5) Returns + damage reserve
6) Overhead allocation per unit (fixed costs / volume assumption)
7) Target margin floor + promo buffer`;
            if(act === "ledger") return
`Decision ledger template (UI preview):
• Date/time
• SKU + channel
• Old price → new price
• Inputs used (COGS, fees, ship, overhead)
• Margin impact (before/after)
• Reason
• Risks + mitigations
• Sources (links/files)`;
          } else if(s.group === "school"){
            if(act === "plan") return
`Weekly plan (UI preview):
• Mon: read/watch + outline
• Tue: practice/problems/notes
• Wed: draft discussion/assignment
• Thu: revise + self-test
• Fri: final polish + submit`;
            if(act === "deadlines") return
`Deadlines extraction (backend hook):
Backend will parse the syllabus PDF and generate:
• assignment list
• due dates
• grading weights
• reminders`;
            if(act === "notes") return
`Study notes (backend hook):
Backend will generate structured notes:
• key terms
• examples
• common mistakes
• quick quiz questions`;
          } else {
            if(act === "personalTips") return
`Personal session tips:
• Keep this as your hub for normal chat.
• Attach Business/School only when you need it.
• Auto-clear is on to prevent accidental mixing.`;
            if(act === "attachHelp") return
`Attach Context:
• Click Attach (Personal only)
• Pick a Business/School session
• Ask your question
• Attachments auto-clear after send`;
          }

          if(act === "ragAdd") return "RAG add-doc: backend will index PDFs/Docs into your local knowledge store.";
          if(act === "ragReindex") return "Re-index: backend will rebuild embeddings + refresh the vector store.";
          if(act === "open") return "UI-only: file open will be wired when backend can serve PDFs and extracted text.";
          return "UI-only action.";
        })();

        const msg = { role:"bot", confidence:"y", ts: nowTime(), content: canned };
        renderMessage(msg);
        addToHistory(msg);
      }

      function hydrateWorkspaceEmpty(group){
        wsHint.textContent = "—";
        wsSubtitle.textContent = (group === "business" ? "Business state" : group === "school" ? "Class state" : "Personal state") + " • " + stamp();

        const html = `
          <div class="section">
            <div class="sectionTitle">
              <strong>No active session</strong>
              <span>${escapeHtml(group)}</span>
            </div>
            <div style="color: rgba(243,239,230,.78); font-size:12.5px; line-height:1.35;">
              Create a ${group === "business" ? "Business" : group === "school" ? "School" : "Personal"} session to activate the workspace.
            </div>
          </div>
        `;
        workspaceBody.innerHTML = html;
        drawerWorkspaceBody.innerHTML = html;
      }

      // -------------------- Drawers --------------------
      function openDrawer(which){
        backdrop.classList.add